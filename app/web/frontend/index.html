<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=yes, maximum-scale=5"/>
  <title>ATGSD Sea Pay Processor</title>
  <style>
    :root {
      /* =========================
         PATCH: Dark "glass" theme
         ========================= */
      --navy-dark: #0a3854;
      --navy: #0e5578;
      --navy-light: #1a7ba8;
      --accent: #6fb7ff;

      --success: #16c784;
      --success-dark: #0ea371;
      --danger: #ff5b6b;
      --danger-dark: #d64552;
      --warning: #f5c451;

      --border: rgba(255,255,255,0.10);

      --bg: #070b14;
      --panel: rgba(20, 28, 48, 0.72);
      --panel-2: rgba(20, 28, 48, 0.55);

      --text-primary: rgba(245,248,255,0.92);
      --text-secondary: rgba(245,248,255,0.62);

      --shadow-sm: 0 10px 26px rgba(0,0,0,0.35);
      --shadow: 0 18px 50px rgba(0,0,0,0.45);
      --shadow-lg: 0 28px 70px rgba(0,0,0,0.55);

      --mono: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;

      --r: 14px;
      --r-sm: 10px;
    }

    * { box-sizing: border-box; }
    img, svg, video, canvas { max-width: 100%; height: auto; }
    html, body { overflow-x: hidden; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background:
        radial-gradient(900px 380px at 50% -60px, rgba(90,160,255,0.22), transparent 60%),
        radial-gradient(700px 340px at 18% 18%, rgba(22,199,132,0.10), transparent 55%),
        radial-gradient(700px 340px at 85% 22%, rgba(255,91,107,0.10), transparent 55%),
        linear-gradient(180deg, #040714 0%, #070b14 45%, #040714 100%);
      color: var(--text-primary);
      line-height: 1.5;
      width: 100%;
    }

    header {
      background: linear-gradient(90deg, rgba(24,34,58,0.78), rgba(10,14,28,0.78));
      color: white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      width: 100%;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .header-inner{
      max-width: 1600px;
      margin: 0 auto;
      padding: 14px 16px;
      width: 100%;
      position: relative;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .header-inner::after{
      content:"";
      position:absolute;
      left:16px;
      right:16px;
      bottom:-1px;
      height: 3px;
      background: linear-gradient(90deg, transparent, rgba(120,190,255,0.75), transparent);
      opacity: 0.55;
      pointer-events:none;
    }

    header h1 {
      margin: 0;
      font-size: clamp(16px, 2.2vw, 22px);
      font-weight: 750;
      letter-spacing: -0.02em;
      display:flex;
      gap:10px;
      align-items:center;
      flex: 1;
    }
    header .subtitle {
      font-size: clamp(11px, 1.6vw, 13px);
      opacity: 0.88;
      margin-top: 2px;
      color: rgba(245,248,255,0.72);
    }
    
    /* ğŸ”¹ PATCH: Header buttons */
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .header-btn {
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 650;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.18s ease;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .header-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(111,183,255,0.35);
      transform: translateY(-1px);
    }

    .wrap {
      max-width: 1600px;
      margin: 0 auto;
      padding: 18px 16px 10px;
      width: 100%;
    }

    .top-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 14px;
      margin-bottom: 14px;
    }
    @media (max-width: 1024px) {
      .top-grid { grid-template-columns: 1fr; gap: 12px; }
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position: relative;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      background:
        radial-gradient(520px 160px at 20% 0%, rgba(120,190,255,0.12), transparent 60%),
        radial-gradient(420px 150px at 85% 10%, rgba(22,199,132,0.08), transparent 60%);
      opacity: 0.8;
    }
    .card > * { position: relative; }

    .card h3 {
      margin: 0;
      padding: 12px 14px;
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-size: 13px;
      font-weight: 750;
      letter-spacing: 0.02em;
      color: rgba(245,248,255,0.92);
      line-height: 1.2;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card .body { padding: 14px; }

    label {
      display: block;
      font-size: 12px;
      font-weight: 650;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    input[type=file], select {
      width: 100%;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      font-size: 13px;
      background: rgba(6,10,18,0.55);
      color: var(--text-primary);
      transition: all 0.18s ease;
      outline: none;
    }
    input[type=file]::file-selector-button{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text-primary);
      border-radius: 10px;
      padding: 7px 10px;
      margin-right: 10px;
      cursor: pointer;
      transition: all 0.18s ease;
    }
    input[type=file]::file-selector-button:hover{
      background: rgba(255,255,255,0.09);
      border-color: rgba(120,190,255,0.30);
      transform: translateY(-1px);
    }
    input[type=file]:hover, select:hover { border-color: rgba(120,190,255,0.35); }
    input[type=file]:focus, select:focus {
      border-color: rgba(120,190,255,0.55);
      box-shadow: 0 0 0 3px rgba(120,190,255,0.18);
    }

    button {
      border: 1px solid transparent;
      font-weight: 750;
      cursor: pointer;
      transition: all 0.18s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
      white-space: nowrap;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1;
    }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    button:not(:disabled):active { transform: scale(0.99); }

    .primary, button.primary {
      width: 100%;
      background: linear-gradient(135deg, rgba(111,183,255,0.30), rgba(255,255,255,0.06));
      color: var(--text-primary);
      border-color: rgba(111,183,255,0.26);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    .primary:not(:disabled):hover, button.primary:not(:disabled):hover {
      transform: translateY(-1px);
      border-color: rgba(111,183,255,0.42);
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
    }

    .secondary, button.secondary {
      width: 100%;
      background: rgba(255,255,255,0.04);
      color: var(--text-primary);
      border-color: rgba(255,255,255,0.10);
    }
    .secondary:not(:disabled):hover, button.secondary:not(:disabled):hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(111,183,255,0.24);
      transform: translateY(-1px);
    }

    .danger, button.danger {
      width: 100%;
      background: linear-gradient(135deg, rgba(255,91,107,0.32), rgba(255,255,255,0.05));
      color: var(--text-primary);
      border-color: rgba(255,91,107,0.32);
    }
    .danger:not(:disabled):hover, button.danger:not(:disabled):hover {
      transform: translateY(-1px);
      border-color: rgba(255,91,107,0.45);
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
    }

    .success, button.success {
      width: 100%;
      background: linear-gradient(135deg, rgba(22,199,132,0.28), rgba(255,255,255,0.05));
      color: var(--text-primary);
      border-color: rgba(22,199,132,0.30);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    .success:not(:disabled):hover, button.success:not(:disabled):hover {
      transform: translateY(-1px);
      border-color: rgba(22,199,132,0.42);
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 750;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(6,10,18,0.55);
      border: 1px solid rgba(255,255,255,0.12);
      width: 100%;
      color: var(--text-primary);

      /* ===== PATCH: Status progress bar behind text ===== */
      position: relative;
      overflow: hidden;
    }
    .status::before {
      content: '';
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 0 4px rgba(22,199,132,0.16);
      animation: pulse 2s ease-in-out infinite;
      position: relative;
      z-index: 1;
    }

    /* ===== PATCH: Status progress bar fill (behind text) ===== */
    .status::after{
      content: "";
      position: absolute;
      inset: 0;
      width: var(--pct, 0%);
      background: linear-gradient(
        90deg,
        rgba(111,183,255,0.22),
        rgba(22,199,132,0.22)
      );
      opacity: 0;
      transition: width 250ms ease, opacity 200ms ease;
      z-index: 0;
      pointer-events: none;
    }
    .status[data-has-pct="1"]::after{ opacity: 1; }

    /* ensure status text stays above bar */
    #statusText{
      position: relative;
      z-index: 1;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.55; transform: scale(0.92); }
    }

    .logbox {
      height: 240px;
      overflow: auto;
      background: rgba(5,7,12,0.78);
      color: rgba(22,199,132,0.95);
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      padding: 14px;
      border-radius: 14px;
      white-space: pre;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
      transition: height 0.3s ease;
    }
    .logbox.collapsed {
      height: 0;
      padding: 0;
      overflow: hidden;
      border: none;
    }

    /* ğŸ”¹ PATCH: Stats badges in header */
    .stats-badges {
      display: flex;
      gap: 8px;
      margin-left: auto;
      padding-left: 10px;
    }
    .stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 750;
      border: 1px solid;
      white-space: nowrap;
    }
    .stat-badge.valid {
      background: rgba(22,199,132,0.16);
      color: rgba(22,199,132,1);
      border-color: rgba(22,199,132,0.35);
    }
    .stat-badge.invalid {
      background: rgba(255,91,107,0.16);
      color: rgba(255,91,107,1);
      border-color: rgba(255,91,107,0.35);
    }
    .stat-badge .count {
      font-weight: 850;
      font-size: 12px;
    }
    
    .collapsible-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: opacity 0.2s ease;
    }
    .collapsible-header:hover {
      opacity: 0.8;
    }
    .collapse-icon {
      transition: transform 0.3s ease;
      display: inline-block;
      font-size: 10px;
    }
    .collapse-icon.collapsed {
      transform: rotate(-90deg);
    }
    .collapsible-content {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
      opacity: 1;
    }
    .collapsible-content.collapsed {
      max-height: 0;
      opacity: 0;
      margin-top: 0 !important;
    }

    .table-wrapper, .table-container {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(6,10,18,0.40);
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 900px;
      color: var(--text-primary);
    }
    thead {
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      padding: 12px 12px;
      text-align: left;
      font-weight: 800;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      color: rgba(245,248,255,0.82);
      border-bottom: 1px solid rgba(255,255,255,0.10);
      white-space: nowrap;
    }
    td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    tr.valid { background: rgba(22,199,132,0.09); }
    tr.invalid { background: rgba(255,91,107,0.09); }
    tr:hover { background: rgba(255,255,255,0.04); }

    .override-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    .override-wrap select {
      width: auto;
      min-width: 140px;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 12px;
    }
    .override-wrap.dirty::after {
      content: 'â—';
      color: var(--warning);
      font-size: 14px;
      position: absolute;
      right: -14px;
      top: 50%;
      transform: translateY(-50%);
      animation: pulse 1.5s ease-in-out infinite;
    }

    textarea.override-reason {
      width: 100%;
      min-height: 34px;
      padding: 9px 10px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      font-family: inherit;
      font-size: 13px;
      resize: vertical;
      background: rgba(6,10,18,0.55);
      color: var(--text-primary);
      transition: all 0.18s ease;
    }
    textarea.override-reason:focus {
      outline: none;
      border-color: rgba(111,183,255,0.55);
      box-shadow: 0 0 0 3px rgba(111,183,255,0.18);
    }
    td.reason-cell {
      max-width: 360px;
      min-width: 220px;
    }

    .hint {
      font-size: 13px;
      color: rgba(245,248,255,0.55);
      text-align: center;
      padding: 10px 8px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,0.14);
      background: rgba(6,10,18,0.35);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 850;
      font-size: 12px;
      margin: 14px 0 8px;
      color: rgba(245,248,255,0.86);
      text-transform: uppercase;
      letter-spacing: 0.10em;
    }

    .text-secondary { color: var(--text-secondary); }
    .mb-1 { margin-bottom: 10px; }

    /* ===== PATCH: Even 2-up button wrapper ===== */
    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 640px) {
      .btn-row { grid-template-columns: 1fr; }
      table { min-width: 860px; }
    }

    /* ===== PATCH: System actions (Process/Reset + Save/Rebuild) in ONE wrapper ===== */
    .system-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .system-actions > button {
      width: 100%;
      padding: 10px 12px !important;
      border-radius: 12px !important;
      font-size: 13px !important;
    }
    @media (max-width: 640px) {
      .system-actions { grid-template-columns: 1fr; }
    }

    /* Footer */
    footer.app-footer{
      max-width: 1600px;
      margin: 16px auto 22px;
      padding: 0 16px;
    }
    footer.app-footer .footer-inner{
      padding: 12px 14px;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
      box-shadow: var(--shadow-sm);
      text-align:center;
      color: rgba(245,248,255,0.55);
      font-size: 12px;
    }
    footer.app-footer a{
      color: rgba(170,205,255,0.95);
      font-weight: 850;
      text-decoration: none;
    }
    footer.app-footer a:hover{ text-decoration: underline; }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div style="flex: 1;">
        <h1>âš“ ATGSD Sea Pay Processor</h1>
        <div class="subtitle">Automated Sea Duty Certification & PG-13 Generation System</div>
      </div>
      <div class="header-buttons">
        <a href="https://github.com/night-owl-018/stg1_nivera_atgsd-sea-pay-processor/tree/main" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="header-btn" 
           style="text-decoration: none;"
           title="View source code on GitHub">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
          </svg>
          GitHub
        </a>
        <button onclick="$('aboutModal').style.display='block'" class="header-btn">â„¹ï¸ About</button>
        <button onclick="$('helpModal').style.display='block'" class="header-btn">ğŸ“– Help</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="top-grid">

      <!-- INPUT FILES -->
      <div class="card">
        <h3 class="collapsible-header" onclick="toggleCollapse('inputFilesContent')">
          <span class="collapse-icon" id="inputFilesIcon">â–¼</span>
          ğŸ“‚ Input Files
        </h3>
        <div class="body collapsible-content" id="inputFilesContent">
          <label>Sea Duty Cert (PDF)</label>
          <input id="pdfs" name="pdfs" type="file" accept="application/pdf" multiple required class="mb-1">

          <label>Rate CSV</label>
          <input id="ratesCsv" name="rates_csv" type="file" accept=".csv" class="mb-1">

          <label>Template PDF</label>
          <input id="templatePdf" name="template_pdf" type="file" accept="application/pdf">
        </div>
      </div>

      <!-- SYSTEM -->
      <div class="card">
        <h3 class="collapsible-header" onclick="toggleCollapse('systemContent')">
          <span class="collapse-icon" id="systemIcon">â–¼</span>
          âš™ï¸ System
        </h3>
        <div class="body collapsible-content" id="systemContent">
          <label>Status</label>
          <div class="status" id="statusText">Idle</div>

          <div style="height:12px;"></div>

          <label>Strikeout</label>
          <select id="strikeColor" name="strikeout_color">
            <option value="Black" selected>âš« Black</option>
            <option value="Red">ğŸ”´ Red</option>
          </select>

          <div style="height:12px;"></div>

          <!-- ğŸ”¹ NEW: PG-13 Consolidation Option -->
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
            <input type="checkbox" id="consolidatePG13" name="consolidate_pg13" style="width: auto; cursor: pointer;">
            <span style="font-weight: 650; font-size: 13px;">ğŸ“„ Consolidate PG-13s by Ship</span>
          </label>
          <div style="font-size: 11px; color: rgba(245,248,255,0.62); margin-top: 4px; line-height: 1.4;">
            When checked, creates <strong>one PG-13 per ship</strong> with all periods listed.<br>
            Saves paper when a sailor has multiple periods on the same ship.
          </div>

          <!-- PATCH: ALL FOUR buttons in ONE wrapper (2x2 grid) -->
          <div class="system-actions">
            <button type="button" id="processBtn" class="primary">â–¶ï¸ Process</button>
            <button class="danger" type="button" id="btnCancel" disabled>â¹ï¸ Cancel</button>

            <button id="saveOverridesBtn" type="button" class="success">
              ğŸ’¾ Save Overrides
            </button>
            <button id="rebuildBtn" class="primary" type="button">
              ğŸ”„ Rebuild Outputs
            </button>
          </div>
          
          <button class="danger" type="button" id="btnReset" style="width: 100%; margin-top: 10px;">
            ğŸ—‘ï¸ Reset All
          </button>
        </div>
      </div>

      <!-- DOWNLOADS + MEMBER & STATS -->
      <div class="card">
        <h3 class="collapsible-header" onclick="toggleCollapse('downloadsContent')">
          <span class="collapse-icon" id="downloadsIcon">â–¼</span>
          ğŸ“¥ Downloads & Member
        </h3>
        <div class="body collapsible-content" id="downloadsContent">
          <div class="btn-row" style="margin-top:0; margin-bottom: 12px;">
            <button class="secondary" type="button" id="btnMerged">ğŸ“¦ Package</button>
            <button class="secondary" type="button" id="btnAll">ğŸ“‚ All</button>
          </div>

          <div style="margin-top:0; margin-bottom: 12px;">
            <div style="font-size: 12px; color: rgba(245,248,255,0.72); margin-bottom: 6px; font-weight: 600;">
              Download for Selected Member:
            </div>
            <div class="btn-row">
              <button class="secondary" type="button" id="btnDownloadSummary" disabled style="font-size: 12px; padding: 8px 10px;">
                ğŸ“„ Summary
              </button>
              <button class="secondary" type="button" id="btnDownloadToris" disabled style="font-size: 12px; padding: 8px 10px;">
                ğŸ“‹ TORIS Cert
              </button>
            </div>
            <div class="btn-row" style="margin-top: 6px;">
              <button class="secondary" type="button" id="btnDownloadPG13s" disabled style="font-size: 12px; padding: 8px 10px;">
                ğŸ“‘ PG-13 Forms
              </button>
              <button class="secondary" type="button" id="btnDownloadMemberAll" disabled style="font-size: 12px; padding: 8px 10px;">
                ğŸ“¦ All Files
              </button>
            </div>
          </div>

          <label>Member</label>
          <select id="memberSelect" class="mb-1">
            <option value="">Select member</option>
          </select>

          <label>Sheet</label>
          <select id="sheetSelect" disabled class="mb-1">
            <option value="">Select sheet</option>
          </select>
        </div>
      </div>

    </div>

    <!-- REVIEW & OVERRIDE -->
    <div class="card" style="margin-bottom: 14px;">
      <h3 class="collapsible-header" onclick="toggleCollapse('reviewContent')">
        <span class="collapse-icon" id="reviewIcon">â–¼</span>
        âœï¸ Review & Override
        <div class="stats-badges">
          <div class="stat-badge valid">
            <span>âœ…</span>
            <span class="count" id="validCount">0</span>
          </div>
          <div class="stat-badge invalid">
            <span>âŒ</span>
            <span class="count" id="invalidCount">0</span>
          </div>
        </div>
      </h3>
      <div class="body collapsible-content" id="reviewContent">

        <div class="hint" id="reviewHint">
          ğŸ‘† Select a member and sheet above to review and override validation results
        </div>

        <div class="section-header">âœ… Valid Rows</div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Ship</th>
                <th>Event</th>
                <th>Status</th>
                <th>Override</th>
                <th>Reason</th>
              </tr>
            </thead>
            <tbody id="validBody"></tbody>
          </table>
        </div>

        <div class="section-header">âŒ Invalid Events</div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Ship</th>
                <th>Event</th>
                <th>Status</th>
                <th>Override</th>
                <th>Reason</th>
              </tr>
            </thead>
            <tbody id="invalidBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CUSTOM DOWNLOAD & MERGE -->
    <div class="card" style="margin-bottom: 14px;">
      <h3 class="collapsible-header" onclick="toggleCollapse('customDownloadContent')">
        <span class="collapse-icon" id="customDownloadIcon">â–¼</span>
        ğŸ¯ Custom Download & Merge
      </h3>
      <div class="body collapsible-content" id="customDownloadContent">
        
        <div style="font-size: 12px; color: rgba(245,248,255,0.72); margin-bottom: 10px;">
          Select members and file types to download or merge:
        </div>
        
        <!-- Quick Actions -->
        <div class="btn-row" style="margin-bottom: 12px;">
          <button class="secondary" type="button" id="btnSelectAll" style="font-size: 12px; padding: 8px 10px;">
            â˜‘ Select All
          </button>
          <button class="secondary" type="button" id="btnDeselectAll" style="font-size: 12px; padding: 8px 10px;">
            â˜ Deselect All
          </button>
        </div>
        
        <!-- Member Selection List -->
        <div id="memberSelectionList" style="max-height: 400px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; background: rgba(6,10,18,0.35);">
          <div style="text-align: center; color: rgba(245,248,255,0.55); padding: 20px;">
            Process files first to see member list
          </div>
        </div>
        
        <!-- Selection Summary -->
        <div id="selectionSummary" style="margin-top: 10px; padding: 10px; background: rgba(111,183,255,0.1); border-radius: 10px; font-size: 13px; text-align: center; color: rgba(245,248,255,0.82);">
          Selection: <span id="selectedCount">0 members, 0 items</span>
        </div>
        
        <!-- Action Buttons -->
        <div class="btn-row" style="margin-top: 12px;">
          <button class="success" type="button" id="btnDownloadCustom" disabled>
            ğŸ“¥ Download ZIP
          </button>
          <button class="primary" type="button" id="btnMergeCustom" disabled>
            ğŸ“¦ Merge to PDF
          </button>
        </div>
        
      </div>
    </div>

    <!-- LIVE PROCESSING LOG -->
    <div class="card">
      <h3 class="collapsible-header" onclick="toggleCollapse('liveLogContent')">
        <span class="collapse-icon" id="liveLogIcon">â–¼</span>
        ğŸ“œ Live Processing Log
      </h3>
      <div class="body collapsible-content" id="liveLogContent">
        <div id="liveLog" class="logbox"></div>
      </div>
    </div>

  </div>

  <!-- ABOUT MODAL -->
  <div id="aboutModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; overflow-y: auto; backdrop-filter: blur(8px);">
    <div style="max-width: 900px; margin: 40px auto; padding: 20px;">
      <div class="card" style="margin-bottom: 20px;">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <span>â„¹ï¸ About ATGSD Sea Pay Processor</span>
          <button onclick="$('aboutModal').style.display='none'" style="width: auto; padding: 8px 16px; font-size: 14px;" class="danger">âœ• Close</button>
        </h3>
        <div class="body" style="max-height: 70vh; overflow-y: auto;">
          
          <h4 style="color: var(--accent); margin-top: 0; font-size: 18px; letter-spacing: -0.01em;">Mission Statement</h4>
          <p style="line-height: 1.8; font-size: 14px;">
            The ATGSD Sea Pay Processor is a specialized web application designed to streamline and automate the complex process of validating sea duty certifications and generating official PG-13 payment authorization forms for United States Navy personnel. Our mission is to reduce administrative burden, eliminate human error, and ensure accurate compensation for sailors serving at sea.
          </p>

          <h4 style="color: var(--accent); margin-top: 24px; font-size: 16px;">ğŸ¯ Core Purpose</h4>
          <p style="line-height: 1.8; font-size: 14px;">
            This system transforms the traditionally manual, time-intensive process of sea pay certification into an efficient, automated workflow. By leveraging advanced OCR (Optical Character Recognition) technology and intelligent validation algorithms, the processor can:
          </p>
          <ul style="line-height: 1.8; font-size: 14px; padding-left: 20px;">
            <li>Extract and validate sea duty events from certification documents</li>
            <li>Automatically identify valid and invalid pay periods</li>
            <li>Generate properly formatted PG-13 payment authorization forms</li>
            <li>Create annotated TORIS certifications with clear visual indicators</li>
            <li>Produce comprehensive summary reports for personnel records</li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px; font-size: 16px;">âš™ï¸ Technical Capabilities</h4>
          <p style="line-height: 1.8; font-size: 14px;">
            Built with modern web technologies and integrated AI-powered document processing, the system offers:
          </p>
          <ul style="line-height: 1.8; font-size: 14px; padding-left: 20px;">
            <li><strong>Intelligent OCR Processing:</strong> Extracts text and data from scanned PDF documents with high accuracy</li>
            <li><strong>Event Validation Engine:</strong> Automatically validates sea duty events against Navy regulations and rate requirements</li>
            <li><strong>Ship Name Normalization:</strong> Matches and standardizes ship names using official Navy vessel databases</li>
            <li><strong>Duplicate Detection:</strong> Identifies and flags duplicate entries to prevent overpayment</li>
            <li><strong>Manual Override System:</strong> Allows authorized personnel to review and override automated decisions with audit trails</li>
            <li><strong>Batch Processing:</strong> Handles multiple personnel certifications simultaneously</li>
            <li><strong>Custom Report Generation:</strong> Creates tailored reports and merged documents for distribution</li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px; font-size: 16px;">ğŸ‘¥ Target Users</h4>
          <p style="line-height: 1.8; font-size: 14px;">
            This application is designed for use by:
          </p>
          <ul style="line-height: 1.8; font-size: 14px; padding-left: 20px;">
            <li>Personnel Support Detachment (PSD) administrators</li>
            <li>Command administrative staff responsible for pay processing</li>
            <li>Pay and personnel specialists (PS ratings)</li>
            <li>Administrative officers and division officers</li>
            <li>Any authorized Navy personnel involved in sea pay certification workflows</li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px; font-size: 16px;">ğŸ”’ Data Security & Privacy</h4>
          <p style="line-height: 1.8; font-size: 14px;">
            This application processes sensitive personnel information and is designed with security in mind:
          </p>
          <ul style="line-height: 1.8; font-size: 14px; padding-left: 20px;">
            <li>All data processing occurs locally on your device or secure server</li>
            <li>No personally identifiable information (PII) is transmitted to external services</li>
            <li>File uploads and processing are handled securely within your network</li>
            <li>Session data is temporary and can be cleared using the Reset function</li>
            <li>Users should follow their command's information security protocols</li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px; font-size: 16px;">ğŸ“Š Output Products</h4>
          <p style="line-height: 1.8; font-size: 14px;">
            The system generates multiple document types to support the complete pay authorization workflow:
          </p>
          <ul style="line-height: 1.8; font-size: 14px; padding-left: 20px;">
            <li><strong>Summary Reports:</strong> Text-based summaries showing valid and invalid periods with day counts</li>
            <li><strong>TORIS Certifications:</strong> Annotated original certifications with invalid entries clearly marked</li>
            <li><strong>PG-13 Forms:</strong> Official payment authorization forms for each valid sea period</li>
            <li><strong>Tracking Reports:</strong> Consolidated records for administrative oversight</li>
            <li><strong>Merged Packages:</strong> Complete document sets organized by member with PDF bookmarks</li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px; font-size: 16px;">ğŸš€ Benefits</h4>
          <ul style="line-height: 1.8; font-size: 14px; padding-left: 20px;">
            <li><strong>Time Savings:</strong> Reduces processing time from hours to minutes per member</li>
            <li><strong>Accuracy:</strong> Eliminates manual transcription errors and calculation mistakes</li>
            <li><strong>Consistency:</strong> Applies validation rules uniformly across all certifications</li>
            <li><strong>Audit Trail:</strong> Maintains complete record of override decisions and reasons</li>
            <li><strong>Compliance:</strong> Ensures adherence to Navy pay regulations and procedures</li>
            <li><strong>Scalability:</strong> Handles workload from individual members to entire commands</li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px; font-size: 16px;">ğŸ“ Version & Development</h4>
          <p style="line-height: 1.8; font-size: 14px;">
            <strong>Current Version:</strong> 1.0.0<br>
            <strong>Release Date:</strong> January 2025<br>
            <strong>Development Status:</strong> Active Development<br>
            <strong>Platform:</strong> Web-based Application (Browser Compatible)<br>
            <strong>Technology Stack:</strong> Python (Backend), Flask (Web Framework), PyTesseract (OCR), ReportLab/PyPDF2 (PDF Generation)
          </p>

          <h4 style="color: var(--accent); margin-top: 24px; font-size: 16px;">ğŸ‘¨â€ğŸ’» Developer Information</h4>
          <p style="line-height: 1.8; font-size: 14px;">
            <strong>Developed by:</strong> STG1(SW) Ryan Nivera, USN<br>
            <strong>Command:</strong> Afloat Training Group San Diego (ATGSD)<br>
            <strong>Contact:</strong> <a href="mailto:ryan.n.nivera.mil@us.navy.mil" style="color: var(--accent);">ryan.n.nivera.mil@us.navy.mil</a><br>
            <strong>Purpose:</strong> Streamlining administrative processes for Navy personnel operations
          </p>

          <h4 style="color: var(--accent); margin-top: 24px; font-size: 16px;">âš ï¸ Disclaimer</h4>
          <p style="line-height: 1.8; font-size: 14px; color: rgba(245,248,255,0.78); font-style: italic;">
            This application is a tool to assist with sea pay processing and does not replace official Navy pay regulations or the judgment of qualified personnel specialists. All outputs should be reviewed by authorized personnel before submission to disbursing or DFAS. Users are responsible for ensuring accuracy and compliance with current Navy pay policies. This is an unofficial tool and is not endorsed by or affiliated with the Department of the Navy or Department of Defense.
          </p>

          <h4 style="color: var(--accent); margin-top: 24px; font-size: 16px;">ğŸ¤ Feedback & Support</h4>
          <p style="line-height: 1.8; font-size: 14px;">
            We continuously improve this application based on user feedback. If you encounter issues, have suggestions for improvement, or would like to request new features, please contact the developer directly. Your input helps make this tool more effective for the entire fleet.
          </p>

          <div style="margin-top: 32px; padding: 16px; background: rgba(111,183,255,0.08); border-left: 4px solid var(--accent); border-radius: 8px;">
            <p style="margin: 0; line-height: 1.8; font-size: 14px; font-weight: 600;">
              <strong>ğŸ–ï¸ Serving Those Who Serve</strong><br>
              This tool was created by sailors, for sailors, to make administrative processes more efficient and accurateâ€”because every minute saved on paperwork is a minute that can be spent on the mission.
            </p>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- HELP MODAL -->
  <div id="helpModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; overflow-y: auto; backdrop-filter: blur(8px);">
    <div style="max-width: 900px; margin: 40px auto; padding: 20px;">
      <div class="card" style="margin-bottom: 20px;">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ“– User Guide & Help</span>
          <button onclick="$('helpModal').style.display='none'" style="width: auto; padding: 8px 16px; font-size: 14px;" class="danger">âœ• Close</button>
        </h3>
        <div class="body" style="max-height: 70vh; overflow-y: auto;">
          
          <h4 style="color: var(--accent); margin-top: 0;">ğŸš€ Quick Start Guide</h4>
          <ol style="line-height: 1.8; padding-left: 20px;">
            <li><strong>Upload Files:</strong> Select one or more Sea Duty Certification PDFs in the "Input Files" section</li>
            <li><strong>Optional:</strong> Upload a custom Rate CSV or Template PDF if needed</li>
            <li><strong>Process:</strong> Click the "â–¶ï¸ Process" button to begin automated processing</li>
            <li><strong>Review:</strong> Check the "Review & Override" section to verify results</li>
            <li><strong>Download:</strong> Use the download buttons to get your processed files</li>
          </ol>

          <h4 style="color: var(--accent); margin-top: 24px;">ğŸ“‚ Input Files</h4>
          <ul style="line-height: 1.8; padding-left: 20px;">
            <li><strong>Sea Duty Cert (PDF):</strong> Required. Upload one or more certification PDFs to process</li>
            <li><strong>Rate CSV:</strong> Optional. Custom rate/rank definitions. System includes default rates</li>
            <li><strong>Template PDF:</strong> Optional. Custom PG-13 form template. System includes default template</li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px;">âš™ï¸ System Controls</h4>
          <ul style="line-height: 1.8; padding-left: 20px;">
            <li><strong>Status:</strong> Shows current processing status with progress percentage</li>
            <li><strong>Strikeout Color:</strong> Choose Black or Red for invalid entry strikethrough on TORIS certs</li>
            <li><strong>â–¶ï¸ Process:</strong> Starts processing of uploaded files</li>
            <li><strong>ğŸ—‘ï¸ Reset:</strong> Clears all data and outputs (cannot be undone)</li>
            <li><strong>ğŸ’¾ Save Overrides:</strong> Saves any manual corrections you've made to event validation</li>
            <li><strong>ğŸ”„ Rebuild Outputs:</strong> Regenerates all PDFs using current override settings</li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px;">ğŸ“¥ Downloads</h4>
          <ul style="line-height: 1.8; padding-left: 20px;">
            <li><strong>ğŸ“¦ Package:</strong> Download merged package with all members organized with bookmarks</li>
            <li><strong>ğŸ“‚ All:</strong> Download complete output folder as ZIP (all files, all members)</li>
            <li><strong>Per-Member Downloads:</strong> Select a member from dropdown to download their specific files:
              <ul style="margin-top: 8px;">
                <li>ğŸ“„ Summary - Text summary of valid/invalid periods</li>
                <li>ğŸ“‹ TORIS Cert - Annotated certification with strikeouts</li>
                <li>ğŸ“‘ PG-13 Forms - Generated payment forms</li>
                <li>ğŸ“¦ All Files - Complete package for that member</li>
              </ul>
            </li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px;">âœï¸ Review & Override</h4>
          <p style="line-height: 1.8;">After processing, you can review and manually override the system's validation decisions:</p>
          <ol style="line-height: 1.8; padding-left: 20px;">
            <li>Select a member from the dropdown</li>
            <li>Select a sheet/page from their certification</li>
            <li>Review the Valid and Invalid events tables</li>
            <li>Use the Override dropdown to change validation status:
              <ul style="margin-top: 8px;">
                <li><strong>ğŸ”„ Auto:</strong> Use system's automatic validation</li>
                <li><strong>âœ… Valid:</strong> Force event to be valid (payable)</li>
                <li><strong>âŒ Invalid:</strong> Force event to be invalid (non-payable)</li>
              </ul>
            </li>
            <li>Add a reason/note in the Reason field (optional but recommended)</li>
            <li>Click "ğŸ’¾ Save Overrides" to apply your changes</li>
            <li>Click "ğŸ”„ Rebuild Outputs" to regenerate PDFs with your overrides</li>
          </ol>

          <h4 style="color: var(--accent); margin-top: 24px;">ğŸ¯ Custom Download & Merge</h4>
          <p style="line-height: 1.8;">Create custom packages with only the members and file types you need:</p>
          <ol style="line-height: 1.8; padding-left: 20px;">
            <li>Use "â˜‘ Select All" or "â˜ Deselect All" for quick selection</li>
            <li>Check individual members you want to include</li>
            <li>For each member, choose which file types to include (Summary, TORIS Cert, PG-13 Forms)</li>
            <li>Click "ğŸ“¥ Download ZIP" to get selected files as a ZIP archive</li>
            <li>Click "ğŸ“¦ Merge to PDF" to combine all selected files into one PDF with bookmarks</li>
          </ol>

          <h4 style="color: var(--accent); margin-top: 24px;">ğŸ“œ Live Processing Log</h4>
          <p style="line-height: 1.8;">Monitor real-time progress of file processing. The log shows:</p>
          <ul style="line-height: 1.8; padding-left: 20px;">
            <li>Files being processed</li>
            <li>OCR and parsing status</li>
            <li>Validation results</li>
            <li>Output generation progress</li>
            <li>Any errors or warnings</li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px;">ğŸ”§ Troubleshooting</h4>
          <ul style="line-height: 1.8; padding-left: 20px;">
            <li><strong>Files not processing?</strong> Check the Live Processing Log for error messages</li>
            <li><strong>Missing events?</strong> Use the Review & Override section to manually add them</li>
            <li><strong>Wrong validation?</strong> Override the event status and add a reason</li>
            <li><strong>Changes not showing?</strong> Make sure to click "ğŸ’¾ Save Overrides" then "ğŸ”„ Rebuild Outputs"</li>
            <li><strong>Download not working?</strong> Open browser console (F12) and check for error messages</li>
            <li><strong>Start fresh?</strong> Use the "ğŸ—‘ï¸ Reset" button to clear all data</li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px;">ğŸ’¡ Tips & Best Practices</h4>
          <ul style="line-height: 1.8; padding-left: 20px;">
            <li>Always review the output before submitting for official use</li>
            <li>Add detailed reasons when overriding automatic validation</li>
            <li>Use the merged package for easy distribution to multiple personnel</li>
            <li>Keep a backup of your original PDFs before processing</li>
            <li>Process files in small batches for easier review</li>
            <li>Check the valid/invalid counts after processing</li>
          </ul>

          <h4 style="color: var(--accent); margin-top: 24px;">ğŸ“ Support</h4>
          <p style="line-height: 1.8;">
            For technical support, bug reports, or feature requests, contact:<br>
            <strong>STG1(SW) Ryan Nivera</strong><br>
            Email: <a href="mailto:ryan.n.nivera.mil@us.navy.mil" style="color: var(--accent);">ryan.n.nivera.mil@us.navy.mil</a>
          </p>

        </div>
      </div>
    </div>
  </div>

  <footer class="app-footer">
    <div class="footer-inner">
      Developed by
      <a href="mailto:ryan.n.nivera.mil@us.navy.mil">STG1(SW) Ryan Nivera</a>
      Â© <span id="yearNow">2025</span>
    </div>
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);

    let lastStatus = null;
    let pendingOverrides = {};
    let lastSelectedMember = "";
    let lastSelectedSheet = "";
    let customSelections = {};
    let processingAborted = false;

    // ğŸ”¹ PATCH: Collapse/Expand functionality with localStorage persistence
    window.toggleCollapse = function(contentId) {
      const content = $(contentId);
      const iconId = contentId.replace('Content', 'Icon');
      const icon = $(iconId);
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        icon.classList.remove('collapsed');
        localStorage.setItem('collapse_' + contentId, 'false');
      } else {
        content.classList.add('collapsed');
        icon.classList.add('collapsed');
        localStorage.setItem('collapse_' + contentId, 'true');
      }
    };

    // ğŸ”¹ PATCH: Restore collapse states on page load
    function restoreCollapseStates() {
      const collapsibles = [
        'inputFilesContent',
        'systemContent', 
        'downloadsContent',
        'reviewContent',
        'customDownloadContent',
        'liveLogContent'
      ];
      
      collapsibles.forEach(contentId => {
        const isCollapsed = localStorage.getItem('collapse_' + contentId) === 'true';
        if (isCollapsed) {
          const content = $(contentId);
          const iconId = contentId.replace('Content', 'Icon');
          const icon = $(iconId);
          
          if (content && icon) {
            content.classList.add('collapsed');
            icon.classList.add('collapsed');
          }
        }
      });
    }

    // Call on page load
    restoreCollapseStates();

    // Custom selection functions
    window.toggleMember = function(member) {
      customSelections[member].enabled = !customSelections[member].enabled;
      if (customSelections[member].enabled) {
        customSelections[member].summary = true;
        customSelections[member].toris = true;
        customSelections[member].pg13 = true;
      }
      renderMemberSelectionList();
    };

    window.toggleFileType = function(member, fileType) {
      customSelections[member][fileType] = !customSelections[member][fileType];
      updateSelectionSummary();
    };

    function renderMemberSelectionList() {
      const container = $("memberSelectionList");
      
      if (Object.keys(customSelections).length === 0) {
        container.innerHTML = '<div style="text-align: center; color: rgba(245,248,255,0.55); padding: 20px;">Process files first to see member list</div>';
        return;
      }
      
      let html = '';
      for (const member in customSelections) {
        const sel = customSelections[member];
        const checked = sel.enabled ? 'checked' : '';
        
        html += `
          <div style="margin-bottom: 12px; padding: 10px; border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; background: rgba(20,28,48,0.4);">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; margin-bottom: 8px;">
              <input type="checkbox" onchange="toggleMember('${member}')" ${checked}>
              <span>${member}</span>
            </label>
            <div style="padding-left: 30px; display: flex; gap: 12px; flex-wrap: wrap;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" onchange="toggleFileType('${member}', 'summary')" ${sel.summary ? 'checked' : ''} ${!sel.enabled ? 'disabled' : ''}>
                <span>ğŸ“„ Summary</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" onchange="toggleFileType('${member}', 'toris')" ${sel.toris ? 'checked' : ''} ${!sel.enabled ? 'disabled' : ''}>
                <span>ğŸ“‹ TORIS Cert</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" onchange="toggleFileType('${member}', 'pg13')" ${sel.pg13 ? 'checked' : ''} ${!sel.enabled ? 'disabled' : ''}>
                <span>ğŸ“‘ PG-13 Forms</span>
              </label>
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
      updateSelectionSummary();
    }

    function updateSelectionSummary() {
      let memberCount = 0;
      let itemCount = 0;
      
      for (const member in customSelections) {
        const sel = customSelections[member];
        if (sel.enabled) {
          memberCount++;
          if (sel.summary) itemCount++;
          if (sel.toris) itemCount++;
          if (sel.pg13) itemCount++;
        }
      }
      
      $("selectedCount").textContent = `${memberCount} members, ${itemCount} items`;
      
      const hasSelection = itemCount > 0;
      $("btnDownloadCustom").disabled = !hasSelection;
      $("btnMergeCustom").disabled = !hasSelection;
    }

    function safeText(v) {
      if (v === null || v === undefined) return "";
      if (typeof v === "object") return JSON.stringify(v);
      return String(v);
    }
    function pick(obj, keys, fallback="") {
      if (!obj) return fallback;
      for (const k of keys) {
        if (obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
      }
      return fallback;
    }

    function fitFontToBox(el, opts = {}) {
      const minPx = (opts.minPx ?? 6);
      const maxPx = (opts.maxPx ?? null);
      const mode  = (opts.mode ?? "width");

      if (!el) return;

      const cs = window.getComputedStyle(el);
      const current = parseFloat(cs.fontSize) || 12;
      let start = maxPx ? maxPx : current;

      if (el.clientWidth <= 0) return;

      el.style.fontSize = start + "px";

      const overflows = () => {
        const w = el.scrollWidth > el.clientWidth + 1;
        if (mode === "width") return w;
        const h = el.scrollHeight > el.clientHeight + 1;
        return w || h;
      };

      let size = start;
      while (size > minPx && overflows()) {
        size -= 0.5;
        el.style.fontSize = size + "px";
      }

      if (size < minPx) el.style.fontSize = minPx + "px";
    }

    function autoGrowTextarea(ta) {
      if (!ta) return;
      ta.style.height = "auto";
      ta.style.height = Math.max(ta.scrollHeight, 30) + "px";
    }

    function patchFitAllReasonCells() {
      document.querySelectorAll("textarea.override-reason").forEach((ta) => {
        autoGrowTextarea(ta);
        fitFontToBox(ta, { minPx: 6, mode: "width" });
      });
    }

    window.addEventListener("resize", () => {
      patchFitAllReasonCells();
    });

    async function jget(url) {
      const r = await fetch(url, {cache:"no-store"});
      if (!r.ok) throw new Error("GET " + url + " -> " + r.status);
      return await r.json();
    }
    async function jpost(url, payload) {
      const r = await fetch(url, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      if (!r.ok) {
        const t = await r.text().catch(()=> "");
        throw new Error("POST " + url + " -> " + r.status + " " + t);
      }
      return await r.json();
    }

    async function pollProgress() {
      try {
        const data = await jget("/progress");
        const pct = pick(data, ["percent","progress","pct"], null);
        const status = pick(data, ["status","state","message"], "Idle");
        const log = pick(data, ["log","lines","text"], "");
        if (status === "COMPLETE" && lastStatus !== "COMPLETE") {
          refreshReviewLists();
        }
        lastStatus = status;

        /* ===== PATCH: Progress bar behind status text ===== */
        const st = $("statusText");
        if (pct !== null && pct !== undefined && pct !== "") {
          const p = Math.max(0, Math.min(100, Number(pct)));
          st.textContent = status + " (" + p + "%)";
          st.style.setProperty("--pct", p + "%");
          st.setAttribute("data-has-pct", "1");
        } else {
          st.textContent = status;
          st.style.setProperty("--pct", "0%");
          st.removeAttribute("data-has-pct");
        }

        if (typeof log === "string") {
          const logBox = $("liveLog");
          const isAtBottom = logBox.scrollHeight - logBox.scrollTop - logBox.clientHeight < 20;
          logBox.textContent = log;
          if (isAtBottom) {
            logBox.scrollTop = logBox.scrollHeight;
          }
        }
      } catch (e) {}
    }

    setInterval(pollProgress, 1000);
    pollProgress();

    $("processBtn").addEventListener("click", async () => {
      const fd = new FormData();
      for (const f of $("pdfs").files) fd.append("pdfs", f);
      if ($("ratesCsv").files[0]) fd.append("rates_csv", $("ratesCsv").files[0]);
      if ($("templatePdf").files[0]) fd.append("template_pdf", $("templatePdf").files[0]);
      fd.append("strikeout_color", $("strikeColor").value);
      fd.append("consolidate_pg13", $("consolidatePG13").checked ? "true" : "false");
      
      $("processBtn").disabled = true;
      $("btnCancel").disabled = false;
      processingAborted = false;
      
      try {
        const r = await fetch("/process", {method:"POST", body: fd});
        if (!r.ok) throw new Error("Process failed: " + r.status);
        await refreshReviewLists();
      } catch (err) {
        alert(err.message || String(err));
      } finally {
        $("processBtn").disabled = false;
        $("btnCancel").disabled = true;
      }
    });

    // ğŸ”¹ PATCH: Cancel processing button
    $("btnCancel").addEventListener("click", async () => {
      if (!confirm("âš ï¸ Cancel current processing? This will stop the operation.")) return;
      
      try {
        processingAborted = true;
        const r = await fetch("/cancel_process", {method:"POST"});
        if (r.ok) {
          alert("âœ… Processing cancelled");
          $("processBtn").disabled = false;
          $("btnCancel").disabled = true;
        }
      } catch (err) {
        console.error("Cancel error:", err);
      }
    });

    $("btnMerged").addEventListener("click", () => { window.location = "/download_merged"; });
    $("btnAll").addEventListener("click", () => { window.location = "/download_all"; });
    
    $("btnDownloadSummary").addEventListener("click", () => {
      const member = $("memberSelect").value;
      if (!member) {
        alert("Please select a member first");
        return;
      }
      window.location = "/download_member_summary/" + encodeURIComponent(member);
    });
    
    $("btnDownloadToris").addEventListener("click", () => {
      const member = $("memberSelect").value;
      if (!member) {
        alert("Please select a member first");
        return;
      }
      window.location = "/download_member_toris/" + encodeURIComponent(member);
    });
    
    $("btnDownloadPG13s").addEventListener("click", () => {
      const member = $("memberSelect").value;
      if (!member) {
        alert("Please select a member first");
        return;
      }
      window.location = "/download_member_pg13s/" + encodeURIComponent(member);
    });
    
    $("btnDownloadMemberAll").addEventListener("click", () => {
      const member = $("memberSelect").value;
      if (!member) {
        alert("Please select a member first");
        return;
      }
      window.location = "/download_member/" + encodeURIComponent(member);
    });

    $("btnSelectAll").addEventListener("click", () => {
      for (const member in customSelections) {
        customSelections[member].enabled = true;
        customSelections[member].summary = true;
        customSelections[member].toris = true;
        customSelections[member].pg13 = true;
      }
      renderMemberSelectionList();
    });

    $("btnDeselectAll").addEventListener("click", () => {
      for (const member in customSelections) {
        customSelections[member].enabled = false;
        customSelections[member].summary = false;
        customSelections[member].toris = false;
        customSelections[member].pg13 = false;
      }
      renderMemberSelectionList();
    });

    // ğŸ”¹ PATCH: Enhanced custom download with debugging
    $("btnDownloadCustom").addEventListener("click", async () => {
      const selections = {};
      let totalItems = 0;
      
      // Build selections object
      for (const member in customSelections) {
        const sel = customSelections[member];
        if (sel.enabled) {
          selections[member] = { 
            summary: sel.summary, 
            toris: sel.toris, 
            pg13: sel.pg13 
          };
          if (sel.summary) totalItems++;
          if (sel.toris) totalItems++;
          if (sel.pg13) totalItems++;
        }
      }
      
      console.log("ğŸ” Download request:", {
        memberCount: Object.keys(selections).length,
        totalItems: totalItems,
        selections: selections
      });
      
      if (totalItems === 0) {
        alert("âŒ No items selected. Please select at least one file type.");
        return;
      }
      
      try {
        $("btnDownloadCustom").disabled = true;
        $("btnDownloadCustom").textContent = "ğŸ“¥ Downloading...";
        
        const response = await fetch("/download_custom", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({action: "download", selections: selections})
        });
        
        console.log("ğŸ“¡ Server response:", response.status, response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error("âŒ Server error:", errorText);
          throw new Error(`Download failed: ${response.status} - ${errorText}`);
        }
        
        const blob = await response.blob();
        console.log("âœ… Received blob:", blob.size, "bytes");
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "CUSTOM_SELECTION.zip";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log("âœ… Download completed successfully");
        
      } catch (err) {
        console.error("âŒ Download error:", err);
        alert("Download failed: " + err.message + "\n\nCheck the browser console (F12) for details.");
      } finally {
        $("btnDownloadCustom").disabled = false;
        $("btnDownloadCustom").textContent = "ğŸ“¥ Download ZIP";
      }
    });

    // ğŸ”¹ PATCH: Enhanced custom merge with debugging
    $("btnMergeCustom").addEventListener("click", async () => {
      const selections = {};
      let totalItems = 0;
      
      for (const member in customSelections) {
        const sel = customSelections[member];
        if (sel.enabled) {
          selections[member] = { 
            summary: sel.summary, 
            toris: sel.toris, 
            pg13: sel.pg13 
          };
          if (sel.summary) totalItems++;
          if (sel.toris) totalItems++;
          if (sel.pg13) totalItems++;
        }
      }
      
      console.log("ğŸ” Merge request:", {
        memberCount: Object.keys(selections).length,
        totalItems: totalItems,
        selections: selections
      });
      
      if (totalItems === 0) {
        alert("âŒ No items selected. Please select at least one file type.");
        return;
      }
      
      try {
        $("btnMergeCustom").disabled = true;
        $("btnMergeCustom").textContent = "ğŸ“¦ Merging...";
        
        const response = await fetch("/download_custom", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({action: "merge", selections: selections})
        });
        
        console.log("ğŸ“¡ Server response:", response.status, response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error("âŒ Server error:", errorText);
          throw new Error(`Merge failed: ${response.status} - ${errorText}`);
        }
        
        const blob = await response.blob();
        console.log("âœ… Received blob:", blob.size, "bytes");
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "CUSTOM_MERGED_PACKAGE.pdf";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log("âœ… Merge completed successfully");
        
      } catch (err) {
        console.error("âŒ Merge error:", err);
        alert("Merge failed: " + err.message + "\n\nCheck the browser console (F12) for details.");
      } finally {
        $("btnMergeCustom").disabled = false;
        $("btnMergeCustom").textContent = "ğŸ“¦ Merge to PDF";
      }
    });

    $("btnReset").addEventListener("click", async () => {
      if (!confirm("âš ï¸ Reset all output and overrides? This cannot be undone.")) return;
      try {
        const r = await fetch("/reset", {method:"POST"});
        if (!r.ok) throw new Error("Reset failed: " + r.status);

        // ğŸ”¹ PATCH: Clear all file inputs
        $("pdfs").value = "";
        $("ratesCsv").value = "";
        $("templatePdf").value = "";

        $("memberSelect").innerHTML = '<option value="">Select member</option>';
        $("sheetSelect").innerHTML = '<option value="">Select sheet</option>';
        $("sheetSelect").disabled = true;
        $("btnDownloadSummary").disabled = true;
        $("btnDownloadToris").disabled = true;
        $("btnDownloadPG13s").disabled = true;
        $("btnDownloadMemberAll").disabled = true;
        $("validBody").innerHTML = "";
        $("invalidBody").innerHTML = "";
        $("reviewHint").textContent = "ğŸ‘† Select a member and sheet above to review and override validation results";
        pendingOverrides = {};
        customSelections = {};
        renderMemberSelectionList();

        if($("validCount")) $("validCount").textContent = "0";
        if($("invalidCount")) $("invalidCount").textContent = "0";

        alert("âœ… Reset complete!");
      } catch (err) {
        alert(err.message || String(err));
      }
    });

    async function refreshReviewLists() {
      try {
        const members = await jget("/api/members");
        const sel = $("memberSelect");
        const current = sel.value;
        sel.innerHTML = '<option value="">Select member</option>';
        
        customSelections = {};
        for (const m of members) {
          const opt = document.createElement("option");
          opt.value = m;
          opt.textContent = m;
          sel.appendChild(opt);
          
          customSelections[m] = {
            enabled: false,
            summary: false,
            toris: false,
            pg13: false
          };
        }
        if (current && members.includes(current)) {
          sel.value = current;
        }
        lastSelectedMember = sel.value;
        renderMemberSelectionList();
      } catch (e) {}
    }

    async function loadSheetsForMember(memberKey) {
      const hasSelection = !!memberKey;
      $("btnDownloadSummary").disabled = !hasSelection;
      $("btnDownloadToris").disabled = !hasSelection;
      $("btnDownloadPG13s").disabled = !hasSelection;
      $("btnDownloadMemberAll").disabled = !hasSelection;
      $("sheetSelect").disabled = true;
      $("sheetSelect").innerHTML = '<option value="">Select sheet</option>';
      $("validBody").innerHTML = "";
      $("invalidBody").innerHTML = "";
      $("reviewHint").style.display = "block";
      $("reviewHint").textContent = "Select a sheet above to review events";
      if (!memberKey) {
        if($("validCount")) $("validCount").textContent = "0";
        if($("invalidCount")) $("invalidCount").textContent = "0";
        return;
      }
      const sheets = await jget("/api/member/" + encodeURIComponent(memberKey) + "/sheets");
      const sel = $("sheetSelect");
      for (const s of sheets) {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        sel.appendChild(opt);
      }
      sel.disabled = false;
      lastSelectedSheet = sel.value;
    }

    function buildOverrideSelect(memberKey, sheetFile, eventIndex, currentStatus, source) {
      const wrap = document.createElement("div");
      wrap.className = "override-wrap";

      const key = `${memberKey}|||${sheetFile}|||${eventIndex}`;

      const sel = document.createElement("select");
      sel.setAttribute("data-override-key", key);

      const options = [
        {v:"", t:"ğŸ”„ Auto"},
        {v:"valid", t:"âœ… Valid"},
        {v:"invalid", t:"âŒ Invalid"},
      ];
      for (const o of options) {
        const opt = document.createElement("option");
        opt.value = o.v;
        opt.textContent = o.t;
        sel.appendChild(opt);
      }
      sel.value = currentStatus || "";

      function markDirty(reasonText) {
        wrap.classList.add("dirty");
        pendingOverrides[key] = {
          member_key: memberKey,
          sheet_file: sheetFile,
          event_index: eventIndex,
          override_status: sel.value || null,
          override_reason: reasonText || null
        };
      }

      sel.addEventListener("change", () => {
        const ta = document.querySelector(`textarea[data-override-key="${CSS.escape(key)}"]`);
        const reasonText = ta ? ta.value : "";
        markDirty(reasonText);
        patchFitAllReasonCells();
      });

      if (source === "override") {
        wrap.classList.add("dirty");
      }

      wrap.appendChild(sel);
      return wrap;
    }

    function buildReasonTextarea(memberKey, sheetFile, eventIndex, initialText, currentOverrideReason) {
      const key = `${memberKey}|||${sheetFile}|||${eventIndex}`;

      const ta = document.createElement("textarea");
      ta.className = "override-reason";
      ta.rows = 1;

      ta.value = (currentOverrideReason && currentOverrideReason.trim() !== "")
        ? currentOverrideReason
        : (initialText || "");

      ta.placeholder = "Optional...";
      ta.setAttribute("data-override-key", key);

      function markDirty() {
        const sel = document.querySelector(`select[data-override-key="${CSS.escape(key)}"]`);
        const statusVal = sel ? sel.value : "";

        pendingOverrides[key] = {
          member_key: memberKey,
          sheet_file: sheetFile,
          event_index: eventIndex,
          override_status: statusVal || null,
          override_reason: ta.value || null
        };

        const wrap = sel ? sel.closest(".override-wrap") : null;
        if (wrap) wrap.classList.add("dirty");
      }

      ta.addEventListener("input", () => {
        autoGrowTextarea(ta);
        markDirty();
        fitFontToBox(ta, { minPx: 6, mode: "width" });
      });

      setTimeout(() => {
        autoGrowTextarea(ta);
        fitFontToBox(ta, { minPx: 6, mode: "width" });
      }, 0);

      return ta;
    }

    function getOverrideStatus(row) {
      const direct = (row && row.override_status !== undefined && row.override_status !== null) ? String(row.override_status) : "";
      if (direct !== "") return direct;
      const nested = (row && row.override && row.override.status !== undefined && row.override.status !== null) ? String(row.override.status) : "";
      return nested || "";
    }

    function getOverrideReason(row) {
      const direct = (row && row.override_reason !== undefined && row.override_reason !== null) ? String(row.override_reason) : "";
      if (direct.trim() !== "") return direct;
      const nested = (row && row.override && row.override.reason !== undefined && row.override.reason !== null) ? String(row.override.reason) : "";
      return nested || "";
    }

    async function loadEventTableForSheet(memberKey, sheetFile) {
      $("validBody").innerHTML = "";
      $("invalidBody").innerHTML = "";
      $("reviewHint").textContent = "Loading events...";

      try {
        const data = await jget("/api/member/" + encodeURIComponent(memberKey) + "/sheet/" + encodeURIComponent(sheetFile));

        const validRows = data.valid_rows || [];
        const invalidRows = data.invalid_events || [];

        if($("validCount")) $("validCount").textContent = String(validRows.length);
        if($("invalidCount")) $("invalidCount").textContent = String(invalidRows.length);

        const validBody = $("validBody");
        const invalidBody = $("invalidBody");

        if (validRows.length === 0 && invalidRows.length === 0) {
          $("reviewHint").textContent = "No events found for this sheet";
          return;
        }

        $("reviewHint").style.display = "none";

        for (const row of validRows) {
          const tr = document.createElement("tr");
          tr.className = "valid";

          const tdDate = document.createElement("td");
          tdDate.textContent = safeText(row.date);

          const tdShip = document.createElement("td");
          tdShip.textContent = safeText(row.ship);

          const tdEvent = document.createElement("td");
          tdEvent.textContent = safeText(row.event);

          const tdStatus = document.createElement("td");
          tdStatus.textContent = row.source === "override" ? "Override" : "Valid";

          const tdOverride = document.createElement("td");
          tdOverride.appendChild(
            buildOverrideSelect(
              memberKey,
              sheetFile,
              row.event_index,
              getOverrideStatus(row),
              row.source
            )
          );

          const tdReason = document.createElement("td");
          tdReason.className = "reason-cell";
          tdReason.appendChild(
            buildReasonTextarea(
              memberKey,
              sheetFile,
              row.event_index,
              safeText(row.status_reason),
              getOverrideReason(row)
            )
          );

          tr.appendChild(tdDate);
          tr.appendChild(tdShip);
          tr.appendChild(tdEvent);
          tr.appendChild(tdStatus);
          tr.appendChild(tdOverride);
          tr.appendChild(tdReason);

          validBody.appendChild(tr);
        }

        for (const row of invalidRows) {
          const tr = document.createElement("tr");
          tr.className = "invalid";

          const tdDate = document.createElement("td");
          tdDate.textContent = safeText(row.date);

          const tdShip = document.createElement("td");
          tdShip.textContent = safeText(row.ship);

          const tdEvent = document.createElement("td");
          tdEvent.textContent = safeText(row.event);

          const tdStatus = document.createElement("td");
          tdStatus.textContent = row.source === "override" ? "Override" : "Invalid";

          const tdOverride = document.createElement("td");
          tdOverride.appendChild(
            buildOverrideSelect(
              memberKey,
              sheetFile,
              row.event_index,
              getOverrideStatus(row),
              row.source
            )
          );

          const tdReason = document.createElement("td");
          tdReason.className = "reason-cell";
          tdReason.appendChild(
            buildReasonTextarea(
              memberKey,
              sheetFile,
              row.event_index,
              safeText(row.reason),
              getOverrideReason(row)
            )
          );

          tr.appendChild(tdDate);
          tr.appendChild(tdShip);
          tr.appendChild(tdEvent);
          tr.appendChild(tdStatus);
          tr.appendChild(tdOverride);
          tr.appendChild(tdReason);

          invalidBody.appendChild(tr);
        }

        setTimeout(() => {
          patchFitAllReasonCells();
        }, 0);

      } catch (err) {
        $("reviewHint").textContent = "Error loading events: " + err.message;
        $("reviewHint").style.display = "block";
      }
    }

    $("memberSelect").addEventListener("change", async (e) => {
      const memberKey = e.target.value;
      lastSelectedMember = memberKey;
      pendingOverrides = {};
      await loadSheetsForMember(memberKey);
    });

    $("sheetSelect").addEventListener("change", async (e) => {
      const sheetFile = e.target.value;
      lastSelectedSheet = sheetFile;
      pendingOverrides = {};
      if (!sheetFile || !lastSelectedMember) return;
      await loadEventTableForSheet(lastSelectedMember, sheetFile);
    });

    $("saveOverridesBtn").addEventListener("click", async function() {
      const overrides = Object.values(pendingOverrides);
      if (overrides.length === 0) {
        alert("No changes to save");
        return;
      }

      const transformedOverrides = overrides.map(override => ({
        member_key: override.member_key,
        sheet_file: override.sheet_file,
        event_index: override.event_index,
        status: override.override_status || "",
        reason: override.override_reason || "",
        source: "manual"
      }));

      $("saveOverridesBtn").disabled = true;
      try {
        await jpost("/api/overrides/batch", transformedOverrides);
        alert(`âœ… Saved ${overrides.length} override(s)`);
        pendingOverrides = {};

        if (lastSelectedMember && lastSelectedSheet) {
          await loadEventTableForSheet(lastSelectedMember, lastSelectedSheet);
        }
      } catch (err) {
        alert("Error saving overrides: " + err.message);
      } finally {
        $("saveOverridesBtn").disabled = false;
      }
    });

    $("rebuildBtn").addEventListener("click", async function() {
      if (!confirm("ğŸ”„ Rebuild all output files using current overrides?")) return;

      $("rebuildBtn").disabled = true;
      try {
        const consolidate = $("consolidatePG13").checked;
        const resp = await jpost("/rebuild_outputs", { consolidate_pg13: consolidate });
        alert("âœ… " + (resp.status || "Rebuild complete"));
      } catch (err) {
        alert("Error rebuilding: " + err.message);
      } finally {
        setTimeout(() => {
          $("rebuildBtn").disabled = false;
        }, 1000);
      }
    });

    if ($("yearNow")) $("yearNow").textContent = new Date().getFullYear();
  </script>
</body>
</html>
