<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=yes, maximum-scale=5"/>
  <title>ATGSD Sea Pay Processor</title>
  <style>
    :root {
      --navy-dark: #0a3854;
      --navy: #0e5578;
      --accent: #6fb7ff;
      --success: #16c784;
      --danger: #ff5b6b;
      --warning: #f5c451;
      --border: rgba(255,255,255,0.10);
      --bg: #070b14;
      --panel: rgba(20, 28, 48, 0.72);
      --text-primary: rgba(245,248,255,0.92);
      --text-secondary: rgba(245,248,255,0.62);
      --shadow-sm: 0 10px 26px rgba(0,0,0,0.35);
      --shadow: 0 18px 50px rgba(0,0,0,0.45);
      --mono: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
      --r: 14px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    img, svg, video, canvas { max-width: 100%; height: auto; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: radial-gradient(900px 380px at 50% -60px, rgba(90,160,255,0.22), transparent 60%),
                  radial-gradient(700px 340px at 18% 18%, rgba(22,199,132,0.10), transparent 55%),
                  radial-gradient(700px 340px at 85% 22%, rgba(255,91,107,0.10), transparent 55%),
                  linear-gradient(180deg, #040714 0%, #070b14 45%, #040714 100%);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* Header */
    header {
      background: linear-gradient(90deg, rgba(24,34,58,0.78), rgba(10,14,28,0.78));
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    .header-inner {
      max-width: 1600px;
      margin: 0 auto;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
    }
    
    .header-inner::after {
      content: "";
      position: absolute;
      left: 16px;
      right: 16px;
      bottom: -1px;
      height: 3px;
      background: linear-gradient(90deg, transparent, rgba(120,190,255,0.75), transparent);
      opacity: 0.55;
    }

    header h1 {
      font-size: clamp(16px, 2.2vw, 22px);
      font-weight: 750;
      letter-spacing: -0.02em;
      display: flex;
      gap: 10px;
      align-items: center;
      flex: 1;
    }
    
    .subtitle {
      font-size: clamp(11px, 1.6vw, 13px);
      opacity: 0.88;
      margin-top: 2px;
      color: rgba(245,248,255,0.72);
    }
    
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .header-btn {
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 650;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.18s ease;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }
    
    .header-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(111,183,255,0.35);
      transform: translateY(-1px);
    }

    /* Layout */
    .wrap {
      max-width: 1600px;
      margin: 0 auto;
      padding: 12px 12px 8px;
    }

    .top-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    /* Cards */
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      backdrop-filter: blur(10px);
      position: relative;
    }
    
    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      pointer-events: none;
      background: radial-gradient(520px 160px at 20% 0%, rgba(120,190,255,0.12), transparent 60%),
                  radial-gradient(420px 150px at 85% 10%, rgba(22,199,132,0.08), transparent 60%);
      opacity: 0.8;
    }
    
    .card > * { position: relative; }

    .card h3 {
      padding: 8px 10px;
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-size: 12px;
      font-weight: 750;
      letter-spacing: 0.02em;
      color: rgba(245,248,255,0.92);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card .body { padding: 10px; }

    /* Form Elements */
    label {
      display: block;
      font-size: 11px;
      font-weight: 650;
      margin-bottom: 4px;
      color: var(--text-secondary);
    }

    input[type=file], select, textarea {
      width: 100%;
      padding: 7px 8px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      font-size: 12px;
      background: rgba(6,10,18,0.55);
      color: var(--text-primary);
      transition: all 0.18s ease;
      outline: none;
      font-family: inherit;
    }
    
    input[type=file]::file-selector-button {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text-primary);
      border-radius: 10px;
      padding: 7px 10px;
      margin-right: 10px;
      cursor: pointer;
      transition: all 0.18s ease;
    }
    
    input[type=file]::file-selector-button:hover {
      background: rgba(255,255,255,0.09);
      border-color: rgba(120,190,255,0.30);
    }
    
    input[type=file]:hover, select:hover, textarea:hover {
      border-color: rgba(120,190,255,0.35);
    }
    
    input[type=file]:focus, select:focus, textarea:focus {
      border-color: rgba(120,190,255,0.55);
      box-shadow: 0 0 0 3px rgba(120,190,255,0.18);
    }
    
    textarea {
      resize: vertical;
      min-height: 34px;
    }

    input[type=checkbox] {
      width: auto;
      cursor: pointer;
    }

    /* Buttons */
    button {
      border: 1px solid transparent;
      font-weight: 750;
      cursor: pointer;
      transition: all 0.18s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-family: inherit;
      white-space: nowrap;
      border-radius: 10px;
      padding: 7px 10px;
      font-size: 12px;
    }
    
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    
    button:not(:disabled):active {
      transform: scale(0.99);
    }

    .btn-primary {
      background: linear-gradient(135deg, rgba(111,183,255,0.30), rgba(255,255,255,0.06));
      color: var(--text-primary);
      border-color: rgba(111,183,255,0.26);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    
    .btn-primary:not(:disabled):hover {
      transform: translateY(-1px);
      border-color: rgba(111,183,255,0.42);
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.04);
      color: var(--text-primary);
      border-color: rgba(255,255,255,0.10);
    }
    
    .btn-secondary:not(:disabled):hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(111,183,255,0.24);
      transform: translateY(-1px);
    }

    .btn-danger {
      background: linear-gradient(135deg, rgba(255,91,107,0.32), rgba(255,255,255,0.05));
      color: var(--text-primary);
      border-color: rgba(255,91,107,0.32);
    }
    
    .btn-danger:not(:disabled):hover {
      transform: translateY(-1px);
      border-color: rgba(255,91,107,0.45);
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
    }

    .btn-success {
      background: linear-gradient(135deg, rgba(22,199,132,0.28), rgba(255,255,255,0.05));
      color: var(--text-primary);
      border-color: rgba(22,199,132,0.30);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    
    .btn-success:not(:disabled):hover {
      transform: translateY(-1px);
      border-color: rgba(22,199,132,0.42);
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
    }

    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 6px;
    }
    
    .btn-row button {
      width: 100%;
    }

    .system-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 6px;
    }
    
    .system-actions button {
      width: 100%;
    }

    /* Status */
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 750;
      padding: 7px 10px;
      border-radius: 10px;
      background: rgba(6,10,18,0.55);
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text-primary);
      position: relative;
      overflow: hidden;
    }
    
    .status::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 0 3px rgba(22,199,132,0.16);
      animation: pulse 2s ease-in-out infinite;
      position: relative;
      z-index: 1;
    }
    
    .status::after {
      content: "";
      position: absolute;
      inset: 0;
      width: var(--pct, 0%);
      background: linear-gradient(90deg, rgba(111,183,255,0.22), rgba(22,199,132,0.22));
      opacity: 0;
      transition: width 250ms ease, opacity 200ms ease;
      z-index: 0;
    }
    
    .status[data-has-pct="1"]::after {
      opacity: 1;
    }
    
    #statusText {
      position: relative;
      z-index: 1;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.55; transform: scale(0.92); }
    }

    /* Stats Badges */
    .stats-badges {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    
    .stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 750;
      border: 1px solid;
      white-space: nowrap;
    }
    
    .stat-badge.valid {
      background: rgba(22,199,132,0.16);
      color: rgba(22,199,132,1);
      border-color: rgba(22,199,132,0.35);
    }
    
    .stat-badge.invalid {
      background: rgba(255,91,107,0.16);
      color: rgba(255,91,107,1);
      border-color: rgba(255,91,107,0.35);
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(6,10,18,0.40);
      margin-top: 6px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 900px;
      color: var(--text-primary);
    }
    
    thead {
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    th {
      padding: 8px 10px;
      text-align: left;
      font-weight: 800;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      color: rgba(245,248,255,0.82);
      border-bottom: 1px solid rgba(255,255,255,0.10);
      white-space: nowrap;
    }
    
    td {
      padding: 7px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      vertical-align: middle;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr.valid {
      background: rgba(22,199,132,0.09);
    }
    
    tr.invalid {
      background: rgba(255,91,107,0.09);
    }
    
    tr:hover {
      background: rgba(255,255,255,0.04);
    }

    .override-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    
    .override-wrap select {
      width: auto;
      min-width: 140px;
      padding: 8px 10px;
      font-size: 13px;
    }
    
    .override-wrap.dirty::after {
      content: 'â—';
      color: var(--warning);
      font-size: 14px;
      position: absolute;
      right: -14px;
      top: 50%;
      transform: translateY(-50%);
      animation: pulse 1.5s ease-in-out infinite;
    }

    .reason-cell {
      max-width: 360px;
      min-width: 220px;
    }

    /* Log */
    .logbox {
      height: 180px;
      overflow: auto;
      background: rgba(5,7,12,0.78);
      color: rgba(22,199,132,0.95);
      font-family: var(--mono);
      font-size: 11px;
      line-height: 1.3;
      padding: 10px;
      border-radius: 10px;
      white-space: pre;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }

    /* Utility */
    .hint {
      font-size: 11px;
      color: rgba(245,248,255,0.55);
      text-align: center;
      padding: 8px 6px;
      border-radius: 10px;
      border: 1px dashed rgba(255,255,255,0.14);
      background: rgba(6,10,18,0.35);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 850;
      font-size: 11px;
      margin: 10px 0 6px;
      color: rgba(245,248,255,0.86);
      text-transform: uppercase;
      letter-spacing: 0.10em;
    }

    .mb-1 { margin-bottom: 6px; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 9999;
      overflow-y: auto;
      backdrop-filter: blur(8px);
    }
    
    .modal-content {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }
    
    .modal h4 {
      color: var(--accent);
      margin-top: 24px;
      font-size: 16px;
    }
    
    .modal h4:first-of-type {
      margin-top: 0;
    }
    
    .modal p, .modal ul, .modal ol {
      line-height: 1.8;
      font-size: 14px;
    }
    
    .modal ul, .modal ol {
      padding-left: 20px;
    }
    
    .modal a {
      color: var(--accent);
    }
    
    /* New Style for Review Modal Controls */
    .review-controls-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr) auto auto;
      gap: 10px;
      align-items: end; /* Aligns items at the bottom for a clean look */
    }

    @media (max-width: 900px) {
      .review-controls-grid {
        grid-template-columns: 1fr 1fr;
      }
    }


    /* Footer */
    .app-footer {
      max-width: 1600px;
      margin: 16px auto 22px;
      padding: 0 16px;
    }
    
    .footer-inner {
      padding: 12px 14px;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
      box-shadow: var(--shadow-sm);
      text-align: center;
      color: rgba(245,248,255,0.55);
      font-size: 12px;
    }
    
    .app-footer a {
      color: rgba(170,205,255,0.95);
      font-weight: 850;
      text-decoration: none;
    }
    
    .app-footer a:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 1400px) {
      .wrap > div:first-child {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    @media (max-width: 1024px) {
      .wrap > div:first-child {
        grid-template-columns: 1fr !important;
      }
    }

    @media (max-width: 640px) {
      .btn-row, .system-actions {
        grid-template-columns: 1fr;
      }
      
      table {
        min-width: 860px;
      }
      
      .header-buttons {
        flex-wrap: wrap;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div style="flex: 1;">
        <h1>âš“ ATGSD Sea Pay Processor</h1>
        <div class="subtitle">Automated Sea Duty Certification & PG-13 Generation System</div>
      </div>
      <div class="header-buttons">
        <a href="https://github.com/night-owl-018/stg1_nivera_atgsd-sea-pay-processor/tree/main" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="header-btn" 
           title="View source code on GitHub">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
          </svg>
          GitHub
        </a>
        <button onclick="showModal('certifyingOfficerModal'); loadCertifyingOfficer();" class="header-btn">ğŸ‘¤ Certifying Officer</button>
        <button onclick="showModal('aboutModal')" class="header-btn">â„¹ï¸ About</button>
        <button onclick="showModal('helpModal')" class="header-btn">ğŸ“– Help</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- First Row: Input, System, Downloads, Custom -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
      
      <!-- INPUT FILES -->
      <div class="card">
        <h3>ğŸ“‚ Files</h3>
        <div class="body">
          <label>Sea Duty PDFs *</label>
          <input id="pdfs" type="file" accept="application/pdf" multiple required class="mb-1">

          <label>Rate CSV</label>
          <input id="ratesCsv" type="file" accept=".csv" class="mb-1">

          <label>Template PDF</label>
          <input id="templatePdf" type="file" accept="application/pdf">
        </div>
      </div>

      <!-- SYSTEM CONTROLS -->
      <div class="card">
        <h3>âš™ï¸ Controls</h3>
        <div class="body">
          <label>Status</label>
          <div class="status" id="statusText">Idle</div>

          <div style="height:6px;"></div>

          <label>Strikeout</label>
          <select id="strikeColor">
            <option value="Black" selected>âš« Black</option>
            <option value="Red">ğŸ”´ Red</option>
          </select>

          <div style="height:6px;"></div>

          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; font-size: 11px;">
            <input type="checkbox" id="consolidatePG13">
            <span>Consolidate PG-13s (one per ship)</span>
          </label>
          
          <div style="height:4px;"></div>
          
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; font-size: 11px;">
            <input type="checkbox" id="consolidateAllMissions">
            <span>Consolidate All Missions (one per member)</span>
          </label>
          
          <div style="height:8px;"></div>
          
          <label>Action</label>
          <select id="actionSelect" style="margin-bottom: 6px;">
            <option value="">Select action</option>
            <option value="process">â–¶ï¸ Process Files</option>
            <option value="cancel" disabled id="cancelOption">â¹ï¸ Cancel Processing</option>
            <option value="reset">ğŸ—‘ï¸ Reset All Data</option>
          </select>
          
          <button type="button" id="actionGoBtn" class="btn-primary" disabled style="width: 100%;">
            âš¡ Go
          </button>
        </div>
      </div>

      <!-- TOOLS -->
      <div class="card">
        <h3>ğŸ”§ Tools</h3>
        <div class="body">
          <button class="btn-primary" type="button" onclick="showModal('reviewModal')" style="width: 100%;">âœï¸ Review & Download</button>
          <button class="btn-primary" type="button" onclick="showModal('logModal')" style="width: 100%; margin-top: 6px;">ğŸ“œ Processing Log</button>
        </div>
      </div>

      <!-- QUICK DOWNLOADS (REVISED) -->
      <div class="card">
        <h3>ğŸ“¥ Downloads</h3>
        <div class="body">
          <div style="font-size: 11px; color: rgba(245,248,255,0.72); text-align: center; padding: 4px 0 10px;">
            Use the Review modal for per-member downloads.
          </div>
          <button class="btn-secondary" type="button" id="downloadMergedBtn" style="width: 100%;">ğŸ“¦ Package</button>
          <button class="btn-secondary" type="button" id="downloadAllBtn" style="width: 100%; margin-top: 6px;">ğŸ“‚ All Files</button>
          <button class="btn-primary" type="button" onclick="showModal('customModal')" style="width: 100%; margin-top: 6px;">ğŸ¯ Custom</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ABOUT MODAL -->
  <div id="aboutModal" class="modal">
    <div class="modal-content">
      <div class="card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <span>â„¹ï¸ About ATGSD Sea Pay Processor</span>
          <button onclick="hideModal('aboutModal')" class="btn-danger" style="width: auto; padding: 8px 16px;">âœ• Close</button>
        </h3>
        <div class="body" style="max-height: 70vh; overflow-y: auto;">
          <h4>Mission Statement</h4>
          <p>The ATGSD Sea Pay Processor streamlines and automates the validation of sea duty certifications and generation of official PG-13 payment authorization forms for United States Navy personnel.</p>

          <h4>ğŸ¯ Core Purpose</h4>
          <ul>
            <li>Extract and validate sea duty events from certification documents</li>
            <li>Automatically identify valid and invalid pay periods</li>
            <li>Generate properly formatted PG-13 payment authorization forms</li>
            <li>Create annotated TORIS certifications with clear visual indicators</li>
            <li>Produce comprehensive summary reports for personnel records</li>
          </ul>

          <h4>âš™ï¸ Technical Capabilities</h4>
          <ul>
            <li><strong>Intelligent OCR:</strong> Extracts text from scanned PDFs with high accuracy</li>
            <li><strong>Event Validation:</strong> Validates events against Navy regulations</li>
            <li><strong>Ship Name Normalization:</strong> Standardizes ship names using official databases</li>
            <li><strong>Duplicate Detection:</strong> Identifies duplicate entries to prevent overpayment</li>
            <li><strong>Manual Override System:</strong> Allows authorized review with audit trails</li>
            <li><strong>Batch Processing:</strong> Handles multiple certifications simultaneously</li>
          </ul>

          <h4>ğŸ“Š Output Products</h4>
          <ul>
            <li><strong>Summary Reports:</strong> Text summaries showing valid/invalid periods</li>
            <li><strong>TORIS Certifications:</strong> Annotated originals with invalid entries marked</li>
            <li><strong>PG-13 Forms:</strong> Official payment authorization forms</li>
            <li><strong>Merged Packages:</strong> Complete document sets with PDF bookmarks</li>
          </ul>

          <h4>ğŸ‘¨â€ğŸ’» Developer Information</h4>
          <p>
            <strong>Developed by:</strong> STG1(SW) Ryan Nivera, USN<br>
            <strong>Command:</strong> Afloat Training Group San Diego (ATGSD)<br>
            <strong>Contact:</strong> <a href="/cdn-cgi/l/email-protection#611318000f4f0f4f0f08170413004f0c080d2114124f0f0017184f0c080d"><span class="__cf_email__" data-cfemail="d5a7acb4bbfbbbfbbbbca3b0a7b4fbb8bcb995a0a6fbbbb4a3acfbb8bcb9">[email&#160;protected]</span></a>
          </p>

          <h4>âš ï¸ Disclaimer</h4>
          <p style="color: rgba(245,248,255,0.78); font-style: italic;">
            This tool assists with sea pay processing but does not replace official Navy regulations or qualified personnel judgment. All outputs should be reviewed before submission. This is an unofficial tool not endorsed by the Department of the Navy or Department of Defense.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- HELP MODAL -->
  <div id="helpModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
      <div class="card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ“– Complete User Guide</span>
          <button onclick="hideModal('helpModal')" class="btn-danger" style="width: auto; padding: 8px 16px;">âœ• Close</button>
        </h3>
        <div class="body" style="max-height: 75vh; overflow-y: auto;">
          
          <div style="background: rgba(111,183,255,0.1); padding: 16px; border-radius: 10px; border-left: 4px solid var(--accent); margin-bottom: 24px;">
            <h4 style="margin: 0 0 12px 0; color: var(--accent); font-size: 16px;">ğŸš€ Quick Start (First Time Users)</h4>
            <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
              <li><strong>Upload</strong> your Sea Duty Certification PDF(s) in the <strong>ğŸ“‚ Files</strong> section</li>
              <li>Click the <strong>â–¶ï¸ Process</strong> button in the <strong>âš™ï¸ Controls</strong> section</li>
              <li>Wait for processing to complete (watch the status indicator)</li>
              <li>Download your processed files from the <strong>ğŸ“¥ Downloads</strong> section or the <strong>âœï¸ Review & Download</strong> tool.</li>
            </ol>
          </div>

          <p style="text-align: center; font-size: 14px; color: rgba(245,248,255,0.7); margin-bottom: 24px;">
            <em>Scroll down for detailed instructions, troubleshooting, and FAQ</em>
          </p>

          <h4 style="color: var(--accent); margin-top: 0;">ğŸ–¥ï¸ Main Interface Overview</h4>
          
          <div style="display: grid; gap: 12px; margin-bottom: 24px;">
            
            <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid #6fb7ff;">
              <div style="font-weight: 700; margin-bottom: 8px; color: #6fb7ff;">ğŸ“‚ Files - Upload Your Documents</div>
              <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 14px;">
                <li><strong>Sea Duty PDFs</strong> (Required) - Upload one or more certification PDFs</li>
                <li><strong>Rate CSV & Template PDF</strong> (Optional) - Custom files for advanced users</li>
              </ul>
            </div>

            <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid #16c784;">
              <div style="font-weight: 700; margin-bottom: 8px; color: #16c784;">âš™ï¸ Controls - Process & Manage</div>
              <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 14px;">
                <li><strong>â–¶ï¸ Process</strong> - Start processing your files</li>
                <li><strong>â¹ï¸ Cancel</strong> - Stop processing if needed</li>
                <li><strong>ğŸ—‘ï¸ Reset</strong> - Clear everything and start over</li>
                <li><strong>Settings</strong> - Choose strikeout color and consolidation options</li>
              </ul>
            </div>

            <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid #f5c451;">
              <div style="font-weight: 700; margin-bottom: 8px; color: #f5c451;">ğŸ”§ Tools - Review & Monitor</div>
              <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 14px;">
                <li><strong>âœï¸ Review & Download</strong> - Check, correct, and download files for each member</li>
                <li><strong>ğŸ“œ Processing Log</strong> - See detailed processing information</li>
              </ul>
            </div>

            <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid #ff5b6b;">
              <div style="font-weight: 700; margin-bottom: 8px; color: #ff5b6b;">ğŸ“¥ Downloads - Get Your Files</div>
              <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 14px;">
                <li><strong>ğŸ“¦ Package / ğŸ“‚ All Files</strong> - Download everything at once</li>
                <li><strong>ğŸ¯ Custom</strong> - Create custom packages with selected files</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- CUSTOM DOWNLOAD MODAL -->
  <div id="customModal" class="modal">
    <div class="modal-content">
      <div class="card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ¯ Custom Download & Merge</span>
          <button onclick="hideModal('customModal')" class="btn-danger" style="width: auto; padding: 8px 16px;">âœ• Close</button>
        </h3>
        <div class="body">
          <div style="font-size: 12px; color: rgba(245,248,255,0.72); margin-bottom: 10px;">
            Select members and file types to download or merge into a package:
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
            <button class="btn-secondary" type="button" id="selectAllBtn">â˜‘ Select All</button>
            <button class="btn-secondary" type="button" id="deselectAllBtn">â˜ Deselect All</button>
          </div>
          
          <div id="memberSelectionList" style="max-height: 400px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; background: rgba(6,10,18,0.35); margin-bottom: 12px;">
            <div style="text-align: center; color: rgba(245,248,255,0.55); padding: 20px; font-size: 12px;">
              Process files first to see member list
            </div>
          </div>
          
          <div id="selectionSummary" style="padding: 10px; background: rgba(111,183,255,0.1); border-radius: 10px; font-size: 13px; text-align: center; color: rgba(245,248,255,0.82); margin-bottom: 12px;">
            Selection: <span id="selectedCount">0 members, 0 items</span>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button class="btn-success" type="button" id="downloadCustomBtn" disabled>ğŸ“¥ Download ZIP</button>
            <button class="btn-primary" type="button" id="mergeCustomBtn" disabled>ğŸ“¦ Merge to PDF</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- REVIEW & OVERRIDE MODAL (REVISED) -->
  <div id="reviewModal" class="modal">
    <div class="modal-content" id="reviewModalContent" style="max-width: 1400px; transition: all 0.3s ease;">
      <div class="card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span>âœï¸ Review & Download</span>
            <div class="stats-badges">
              <div class="stat-badge valid">
                <span>âœ…</span>
                <span class="count" id="validCountModal">0</span>
              </div>
              <div class="stat-badge invalid">
                <span>âŒ</span>
                <span class="count" id="invalidCountModal">0</span>
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button onclick="toggleMaximizeModal('reviewModal')" class="btn-secondary" style="width: auto; padding: 6px 12px; font-size: 12px;" title="Maximize/Restore">
              <span id="reviewModalMaximizeIcon">â›¶</span>
            </button>
            <button onclick="hideModal('reviewModal')" class="btn-danger" style="width: auto; padding: 8px 16px;">âœ• Close</button>
          </div>
        </h3>
        <div class="body" id="reviewModalBody" style="max-height: 65vh; overflow-y: auto; transition: max-height 0.3s ease;">

          <!-- New Integrated Controls -->
          <div class="review-controls-grid">
            <div>
              <label>Member</label>
              <select id="memberSelect">
                <option value="">Select member</option>
              </select>
            </div>
            <div>
              <label>Sheet</label>
              <select id="sheetSelect" disabled>
                <option value="">Select sheet</option>
              </select>
            </div>
            <div>
              <label>Download Type</label>
              <select id="memberFileTypeSelect" disabled>
                <option value="">Select file type</option>
                <option value="summary">ğŸ“„ Summary</option>
                <option value="toris">ğŸ“‹ TORIS Cert</option>
                <option value="pg13">ğŸ“‘ PG-13 Forms</option>
                <option value="all">ğŸ“¦ All Files</option>
              </select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn-success" type="button" id="downloadMemberFileBtn" disabled style="width: 100%;">
                ğŸ“¥ Download Selected
              </button>
            </div>
          </div>
          
          <div style="height: 12px; border-top: 1px solid rgba(255,255,255,0.1); margin: 12px 0;"></div>

          <div class="hint" id="reviewHint">
            ğŸ‘† Select a member to begin review
          </div>

          <div id="reviewTablesContainer" style="display: none;">
            <div class="section-header">âœ… Valid Rows</div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Ship</th>
                    <th>Event</th>
                    <th>Status</th>
                    <th>Override</th>
                    <th>Reason</th>
                  </tr>
                </thead>
                <tbody id="validBody"></tbody>
              </table>
            </div>

            <div class="section-header">âŒ Invalid Events</div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Ship</th>
                    <th>Event</th>
                    <th>Status</th>
                    <th>Override</th>
                    <th>Reason</th>
                  </tr>
                </thead>
                <tbody id="invalidBody"></tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div style="padding: 12px; border-top: 1px solid rgba(255,255,255,0.1); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.05)); display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button type="button" id="saveOverridesBtn" class="btn-success">ğŸ’¾ Save Overrides</button>
          <button type="button" id="rebuildBtn" class="btn-primary">ğŸ”„ Rebuild Outputs</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PROCESSING LOG MODAL -->
  <div id="logModal" class="modal">
    <div class="modal-content" id="logModalContent" style="max-width: 1200px; transition: all 0.3s ease;">
      <div class="card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ“œ Live Processing Log</span>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button onclick="toggleMaximizeModal('logModal')" class="btn-secondary" style="width: auto; padding: 6px 12px; font-size: 12px;" title="Maximize/Restore">
              <span id="logModalMaximizeIcon">â›¶</span>
            </button>
            <button onclick="hideModal('logModal')" class="btn-danger" style="width: auto; padding: 8px 16px;">âœ• Close</button>
          </div>
        </h3>
        <div class="body" id="logModalBody" style="transition: height 0.3s ease;">
          <div id="liveLog" class="logbox" style="height: 500px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CERTIFYING OFFICER MODAL -->
  <div id="certifyingOfficerModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ‘¤ Set Certifying Officer</span>
          <button onclick="hideModal('certifyingOfficerModal')" class="btn-danger" style="width: auto; padding: 8px 16px;">âœ• Close</button>
        </h3>
        <div class="body">
          <p style="margin-bottom: 16px; color: rgba(245,248,255,0.72); font-size: 13px;">
            Enter the certifying officer information. This name will appear on TORIS certification sheets and PG-13 forms.
          </p>
          
          <form id="certifyingOfficerForm" style="display: grid; gap: 12px;">
            <div>
              <label>Rate *</label>
              <input type="text" id="certifyingOfficerRate" placeholder="e.g., STG1" required style="text-transform: uppercase;">
            </div>
            
            <div>
              <label>Last Name *</label>
              <input type="text" id="certifyingOfficerLastName" placeholder="e.g., NIVERA" required style="text-transform: uppercase;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label>First Initial *</label>
                <input type="text" id="certifyingOfficerFirstInitial" placeholder="e.g., R" maxlength="1" required style="text-transform: uppercase;">
              </div>
              
              <div>
                <label>Middle Initial</label>
                <input type="text" id="certifyingOfficerMiddleInitial" placeholder="e.g., A" maxlength="1" style="text-transform: uppercase;">
              </div>
            </div>
            
            <div style="margin-top: 8px; padding: 12px; background: rgba(111,183,255,0.08); border-radius: 10px; border: 1px solid rgba(111,183,255,0.2);">
              <div style="font-size: 11px; font-weight: 650; margin-bottom: 6px; color: rgba(111,183,255,0.95);">Preview:</div>
              <div id="certifyingOfficerPreview" style="font-family: 'Courier New', monospace; font-size: 12px; font-weight: 700; color: rgba(245,248,255,0.95);">
                (Enter information above)
              </div>
            </div>
            
            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 8px;">
              ğŸ’¾ Save Certifying Officer
            </button>
            
            <div id="certifyingOfficerStatus" style="display: none; padding: 10px; border-radius: 10px; text-align: center; font-size: 12px; font-weight: 650;"></div>
          </form>
        </div>
      </div>
    </div>
  </div>


  <footer class="app-footer">
    <div class="footer-inner">
      Developed by <a href="/cdn-cgi/l/email-protection#ea98938b84c484c484839c8f988bc4878386aa9f99c4848b9c93c4878386">STG1(SW) Ryan Nivera</a> Â© <span id="yearNow">2025</span>
    </div>
  </footer>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // Utility functions
    const $ = id => document.getElementById(id);
    
    // Modal functions
    window.showModal = function(modalId) {
      const modal = $(modalId);
      if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      } else {
        console.error('Modal not found:', modalId);
      }
    };
    
    window.hideModal = function(modalId) {
      const modal = $(modalId);
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
    };
    
    document.addEventListener('click', e => {
      if (e.target.classList.contains('modal')) hideModal(e.target.id);
    });

    window.toggleMaximizeModal = function(modalId) {
      const content = $(modalId + 'Content');
      const body = $(modalId + 'Body');
      const icon = $(modalId + 'MaximizeIcon');
      if (!content) return;
      
      const isMaximized = content.getAttribute('data-maximized') === 'true';
      
      if (isMaximized) {
        content.style.maxWidth = modalId === 'reviewModal' ? '1400px' : '1200px';
        content.style.width = '';
        content.style.height = '';
        content.style.margin = '40px auto';
        if (body) {
          if (modalId === 'reviewModal') body.style.maxHeight = '65vh';
          else if (modalId === 'logModal') $('liveLog').style.height = '500px';
        }
        if (icon) icon.textContent = 'â›¶';
        content.setAttribute('data-maximized', 'false');
      } else {
        content.style.maxWidth = 'none';
        content.style.width = 'calc(100vw - 40px)';
        content.style.height = 'calc(100vh - 40px)';
        content.style.margin = '20px';
        if (body) {
          if (modalId === 'reviewModal') body.style.maxHeight = 'calc(100vh - 220px)';
          else if (modalId === 'logModal') $('liveLog').style.height = 'calc(100vh - 200px)';
        }
        if (icon) icon.textContent = 'ğŸ——';
        content.setAttribute('data-maximized', 'true');
      }
    };

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(modal => {
          if (modal.style.display === 'block') {
            hideModal(modal.id);
            const content = $(modal.id + 'Content');
            if (content && content.getAttribute('data-maximized') === 'true') {
              toggleMaximizeModal(modal.id);
            }
          }
        });
      }
    });

    // State
    let pendingOverrides = {};
    let customSelections = {};
    let currentMember = '';
    let currentSheet = '';
    let lastPollStatus = ''; // PATCH: For preventing repeated member refresh

    // API helpers
    async function apiGet(url) {
      const res = await fetch(url, {cache: 'no-store'});
      if (!res.ok) throw new Error(`GET ${url} failed: ${res.status}`);
      return res.json();
    }

    async function apiPost(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`POST ${url} failed: ${res.status} ${text}`);
      }
      return res.json();
    }

    // PATCHED Status polling function
    async function pollProgress() {
      try {
        const data = await apiGet('/progress');
        const status = data.status || data.state || 'Idle';
        const pct = data.percent || data.progress;
        const log = data.log || data.lines || '';
        const statusUpper = status.toUpperCase();

        const statusEl = $('statusText');
        if (pct != null) {
          const p = Math.max(0, Math.min(100, Number(pct)));
          statusEl.textContent = `${status} (${p}%)`;
          statusEl.style.setProperty('--pct', `${p}%`);
          statusEl.setAttribute('data-has-pct', '1');
        } else {
          statusEl.textContent = status;
          statusEl.style.setProperty('--pct', '0%');
          statusEl.removeAttribute('data-has-pct');
        }

        $('cancelOption').disabled = !['IDLE', 'COMPLETE', 'CANCELLED', 'CANCELLING'].includes(statusUpper);

        if (log) {
          const logEl = $('liveLog');
          const atBottom = logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight < 20;
          logEl.textContent = log;
          if (atBottom) logEl.scrollTop = logEl.scrollHeight;
        }

        if (statusUpper === 'COMPLETE' && lastPollStatus !== 'COMPLETE') {
          await refreshMembers();
        }
        lastPollStatus = statusUpper;

      } catch (e) {
        console.error('Poll error:', e);
      }
    }

    setInterval(pollProgress, 1000);
    pollProgress();

    // Action dropdown handler
    $('actionSelect').addEventListener('change', function() {
      const btn = $('actionGoBtn');
      btn.disabled = this.value === '';
      btn.className = this.value === 'reset' ? 'btn-danger' : 'btn-primary';
    });
    
    // Make consolidate checkboxes mutually exclusive
    $('consolidatePG13').addEventListener('change', function() {
      if (this.checked) {
        $('consolidateAllMissions').checked = false;
      }
    });
    
    $('consolidateAllMissions').addEventListener('change', function() {
      if (this.checked) {
        $('consolidatePG13').checked = false;
      }
    });
    
    // Action Go button handler
    $('actionGoBtn').addEventListener('click', async () => {
      const action = $('actionSelect').value;
      const btn = $('actionGoBtn');
      btn.disabled = true;

      try {
        if (action === 'process') {
          const fd = new FormData();
          for (const f of $('pdfs').files) fd.append('pdfs', f);
          if ($('ratesCsv').files[0]) fd.append('rates_csv', $('ratesCsv').files[0]);
          if ($('templatePdf').files[0]) fd.append('template_pdf', $('templatePdf').files[0]);
          fd.append('strikeout_color', $('strikeColor').value);
          fd.append('consolidate_pg13', $('consolidatePG13').checked);
          fd.append('consolidate_all_missions', $('consolidateAllMissions').checked);
          await fetch('/process', {method: 'POST', body: fd});
        } else if (action === 'cancel') {
          await fetch('/cancel_process', {method: 'POST'});
          alert('âœ… Processing cancelled');
        } else if (action === 'reset') {
          if (!confirm('âš ï¸ Reset all data? This cannot be undone.')) return;
          await fetch('/reset', {method: 'POST'});
          ['pdfs', 'ratesCsv', 'templatePdf'].forEach(id => $(id).value = '');
          $('memberSelect').innerHTML = '<option value="">Select member</option>';
          await loadSheets(); // Resets downstream elements
          alert('âœ… Reset complete');
          $('actionSelect').value = ''; // Only reset dropdown after actual reset
        }
      } catch (err) {
        alert(err.message);
      } finally {
        btn.disabled = false;
      }
    });

    // Downloads
    $('downloadMergedBtn').addEventListener('click', () => window.location = '/download_merged');
    $('downloadAllBtn').addEventListener('click', () => window.location = '/download_all');
    
    $('memberFileTypeSelect').addEventListener('change', function() {
      $('downloadMemberFileBtn').disabled = !this.value || !currentMember;
    });
    
    $('downloadMemberFileBtn').addEventListener('click', () => {
      const fileType = $('memberFileTypeSelect').value;
      if (!currentMember || !fileType) return;
      const urls = {
        summary: `/download_member_summary/${encodeURIComponent(currentMember)}`,
        toris: `/download_member_toris/${encodeURIComponent(currentMember)}`,
        pg13: `/download_member_pg13s/${encodeURIComponent(currentMember)}`,
        all: `/download_member/${encodeURIComponent(currentMember)}`
      };
      if (urls[fileType]) window.location = urls[fileType];
    });

    // Members & Sheets
    async function refreshMembers() {
      try {
        const members = await apiGet('/api/members');
        const sel = $('memberSelect');
        const current = sel.value;
        sel.innerHTML = '<option value="">Select member</option>';
        
        customSelections = {};
        members.forEach(m => {
          sel.appendChild(new Option(m, m));
          customSelections[m] = {enabled: false, summary: false, toris: false, pg13: false};
        });
        
        if (current && members.includes(current)) sel.value = current;
        currentMember = sel.value;
        renderMemberList();
        await loadSheets(); // Load sheets for currently selected member
      } catch (e) {
        console.error('Refresh members error:', e);
      }
    }

    $('memberSelect').addEventListener('change', async e => {
      currentMember = e.target.value;
      await loadSheets();
    });

    // Load member list from API
    async function loadMembers() {
      try {
        const members = await apiGet('/api/members');
        const sel = $('memberSelect');
        sel.innerHTML = '<option value="">Select member</option>';
        
        if (members.length === 0) {
          sel.innerHTML = '<option value="">No members found - process files first</option>';
          return;
        }
        
        members.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m;
          opt.textContent = m;
          sel.appendChild(opt);
        });
        
        console.log(`Loaded ${members.length} members`);
      } catch (e) {
        console.error('Load members error:', e);
        $('memberSelect').innerHTML = '<option value="">Error loading members</option>';
      }
    }

    async function loadSheets() {
      pendingOverrides = {};
      const hasMember = !!currentMember;
      
      $('memberFileTypeSelect').disabled = !hasMember;
      $('downloadMemberFileBtn').disabled = !hasMember || !$('memberFileTypeSelect').value;
      if (!hasMember) $('memberFileTypeSelect').value = '';
      
      const sheetSelect = $('sheetSelect');
      sheetSelect.innerHTML = '<option value="">Select sheet</option>';
      sheetSelect.disabled = !hasMember;

      // Reset tables and hint
      $('validBody').innerHTML = '';
      $('invalidBody').innerHTML = '';
      $('reviewHint').style.display = 'block';
      $('reviewHint').textContent = hasMember ? 'Select a sheet to review' : 'ğŸ‘† Select a member to begin review';
      $('reviewTablesContainer').style.display = 'none';
      ['validCountModal', 'invalidCountModal'].forEach(id => $(id).textContent = '0');
      
      if (!hasMember) return;
      
      try {
        const sheets = await apiGet(`/api/member/${encodeURIComponent(currentMember)}/sheets`);
        sheets.forEach(s => sheetSelect.appendChild(new Option(s, s)));
      } catch (e) {
        console.error('Load sheets error:', e);
      }
    }

    $('sheetSelect').addEventListener('change', async e => {
      currentSheet = e.target.value;
      if (currentSheet && currentMember) await loadEvents();
    });

    async function loadEvents() {
      $('validBody').innerHTML = '';
      $('invalidBody').innerHTML = '';
      $('reviewHint').style.display = 'block';
      $('reviewTablesContainer').style.display = 'none';
      $('reviewHint').textContent = 'Loading...';
      
      try {
        const data = await apiGet(`/api/member/${encodeURIComponent(currentMember)}/sheet/${encodeURIComponent(currentSheet)}`);
        const valid = data.valid_rows || [];
        const invalid = data.invalid_events || [];
        
        $('validCountModal').textContent = valid.length;
        $('invalidCountModal').textContent = invalid.length;
        
        if (valid.length === 0 && invalid.length === 0) {
          $('reviewHint').textContent = 'No events found for this sheet.';
        } else {
          $('reviewHint').style.display = 'none';
          $('reviewTablesContainer').style.display = 'block';
          valid.forEach(row => renderRow(row, $('validBody'), 'valid'));
          invalid.forEach(row => renderRow(row, $('invalidBody'), 'invalid'));
        }
      } catch (e) {
        $('reviewHint').textContent = `Error: ${e.message}`;
      }
    }

    function renderRow(row, tbody, type) {
      const tr = tbody.insertRow();
      tr.className = type;
      tr.innerHTML = `
        <td>${row.date || ''}</td>
        <td>${row.ship || ''}</td>
        <td>${row.event || ''}</td>
        <td>${row.source === 'override' ? 'Override' : (type === 'valid' ? 'Valid' : 'Invalid')}</td>
        <td></td>
        <td class="reason-cell"></td>
      `;
      
      const key = `${currentMember}|||${currentSheet}|||${row.event_index}`;
      const status = row.override_status || (row.override && row.override.status) || '';
      const reason = row.override_reason || (row.override && row.override.reason) || '';
      const statusReason = row.status_reason || row.reason || '';

      tr.cells[4].appendChild(createOverrideSelect(key, status, row.source));
      tr.cells[5].appendChild(createReasonTextarea(key, statusReason, reason));
    }

    function createOverrideSelect(key, status, source) {
      const wrap = document.createElement('div');
      wrap.className = 'override-wrap';
      if (source === 'override') wrap.classList.add('dirty');
      
      const sel = document.createElement('select');
      sel.innerHTML = `<option value="">ğŸ”„ Auto</option><option value="valid">âœ… Valid</option><option value="invalid">âŒ Invalid</option>`;
      sel.value = status;
      
      sel.addEventListener('change', () => {
        wrap.classList.add('dirty');
        const [member, sheet, index] = key.split('|||');
        pendingOverrides[key] = {
          member_key: member,
          sheet_file: sheet,
          event_index: parseInt(index),
          override_status: sel.value || null,
          override_reason: document.querySelector(`textarea[data-key="${key}"]`).value
        };
      });
      
      wrap.appendChild(sel);
      return wrap;
    }

    function createReasonTextarea(key, initialText, overrideReason) {
      const ta = document.createElement('textarea');
      ta.className = 'override-reason';
      ta.value = overrideReason || initialText || '';
      ta.placeholder = 'Optional reason...';
      ta.dataset.key = key;
      
      ta.addEventListener('input', () => {
        const sel = ta.closest('tr').querySelector('select');
        if (sel) sel.closest('.override-wrap').classList.add('dirty');
        
        const [member, sheet, index] = key.split('|||');
        pendingOverrides[key] = {
          member_key: member,
          sheet_file: sheet,
          event_index: parseInt(index),
          override_status: sel ? sel.value : null,
          override_reason: ta.value || null
        };
      });
      return ta;
    }

    // Overrides & Rebuild
    $('saveOverridesBtn').addEventListener('click', async () => {
      const overrides = Object.values(pendingOverrides);
      if (overrides.length === 0) return alert('No changes to save.');
      
      const transformed = overrides.map(o => ({
        ...o, status: o.override_status || '', reason: o.override_reason || '', source: 'manual'
      }));
      
      $('saveOverridesBtn').disabled = true;
      try {
        await apiPost('/api/overrides/batch', transformed);
        alert(`âœ… Saved ${overrides.length} override(s)`);
        pendingOverrides = {};
        if (currentMember && currentSheet) await loadEvents();
      } catch (err) {
        alert(`Error: ${err.message}`);
      } finally {
        $('saveOverridesBtn').disabled = false;
      }
    });

    $('rebuildBtn').addEventListener('click', async () => {
      if (!confirm('ğŸ”„ Rebuild all outputs?')) return;
      $('rebuildBtn').disabled = true;
      try {
        const res = await apiPost('/rebuild_outputs', { 
          consolidate_pg13: $('consolidatePG13').checked,
          consolidate_all_missions: $('consolidateAllMissions').checked
        });
        alert('âœ… ' + (res.status || 'Rebuild complete'));
      } catch (err) {
        alert(`Error: ${err.message}`);
      } finally {
        setTimeout(() => $('rebuildBtn').disabled = false, 1000);
      }
    });

    // Custom selection modal
    function renderMemberList() {
      const container = $('memberSelectionList');
      const members = Object.keys(customSelections);
      if (members.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: rgba(245,248,255,0.55); padding: 20px; font-size: 12px;">Process files first to see member list</div>';
        return;
      }
      container.innerHTML = members.map(member => {
        const s = customSelections[member];
        return `
          <div style="margin-bottom: 10px; padding: 10px; border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; background: rgba(20,28,48,0.4);">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; margin-bottom: 6px; font-size: 13px;">
              <input type="checkbox" onchange="toggleMember('${member}')" ${s.enabled ? 'checked' : ''}>
              <span>${member}</span>
            </label>
            <div style="padding-left: 30px; display: flex; gap: 12px; flex-wrap: wrap;">
              ${['summary', 'toris', 'pg13'].map(type => `
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px;">
                  <input type="checkbox" onchange="toggleFileType('${member}', '${type}')" ${s[type] ? 'checked' : ''} ${!s.enabled ? 'disabled' : ''}>
                  <span>${{summary: 'ğŸ“„ Summary', toris: 'ğŸ“‹ TORIS', pg13: 'ğŸ“‘ PG-13'}[type]}</span>
                </label>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
      updateSelectionSummary();
    }
    
    window.toggleMember = function(member) {
      customSelections[member].enabled = !customSelections[member].enabled;
      if (customSelections[member].enabled && !customSelections[member].summary && !customSelections[member].toris && !customSelections[member].pg13) {
        ['summary', 'toris', 'pg13'].forEach(type => customSelections[member][type] = true);
      }
      renderMemberList();
    };

    window.toggleFileType = function(member, type) {
      customSelections[member][type] = !customSelections[member][type];
      const s = customSelections[member];
      if (!s.summary && !s.toris && !s.pg13) s.enabled = false;
      else if (!s.enabled) s.enabled = true;
      renderMemberList();
    };

    function updateSelectionSummary() {
      let memberCount = 0;
      let itemCount = 0;
      Object.values(customSelections).forEach(s => {
        if (s.enabled) {
          memberCount++;
          itemCount += (s.summary ? 1 : 0) + (s.toris ? 1 : 0) + (s.pg13 ? 1 : 0);
        }
      });
      $('selectedCount').textContent = `${memberCount} members, ${itemCount} items`;
      $('downloadCustomBtn').disabled = itemCount === 0;
      $('mergeCustomBtn').disabled = itemCount === 0;
    }

    $('selectAllBtn').addEventListener('click', () => {
      Object.keys(customSelections).forEach(m => {
        customSelections[m] = {enabled: true, summary: true, toris: true, pg13: true};
      });
      renderMemberList();
    });

    $('deselectAllBtn').addEventListener('click', () => {
      Object.keys(customSelections).forEach(m => {
        customSelections[m] = {enabled: false, summary: false, toris: false, pg13: false};
      });
      renderMemberList();
    });

    async function handleCustomDownload(action) {
      const selections = {};
      Object.entries(customSelections).forEach(([member, s]) => {
        if (s.enabled) selections[member] = {summary: s.summary, toris: s.toris, pg13: s.pg13};
      });

      const btn = action === 'download' ? $('downloadCustomBtn') : $('mergeCustomBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = action === 'download' ? 'ğŸ“¥ Downloading...' : 'ğŸ“¦ Merging...';

      try {
        const res = await fetch('/download_custom', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action, selections})
        });
        if (!res.ok) throw new Error(`${action} failed: ${res.status}`);
        
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = action === 'download' ? 'CUSTOM_SELECTION.zip' : 'CUSTOM_MERGED_PACKAGE.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert(`Error: ${err.message}`);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    $('downloadCustomBtn').addEventListener('click', () => handleCustomDownload('download'));
    $('mergeCustomBtn').addEventListener('click', () => handleCustomDownload('merge'));

    // Initialize
    // Certifying Officer Functions
    function updateCertifyingOfficerPreview() {
      const rate = $('certifyingOfficerRate').value.trim().toUpperCase();
      const lastName = $('certifyingOfficerLastName').value.trim().toUpperCase();
      const firstInitial = $('certifyingOfficerFirstInitial').value.trim().toUpperCase();
      const middleInitial = $('certifyingOfficerMiddleInitial').value.trim().toUpperCase();
      
      let preview = '';
      if (rate) preview += rate + ' ';
      if (lastName) {
        preview += lastName;
        if (firstInitial) {
          preview += ', ' + firstInitial + '.';
          if (middleInitial) {
            preview += ' ' + middleInitial + '.';
          }
        }
      }
      
      $('certifyingOfficerPreview').textContent = preview || '(Enter information above)';
    }
    
    async function loadCertifyingOfficer() {
      try {
        const response = await apiGet('/api/certifying_officer');
        if (response.status === 'success' && response.officer) {
          const officer = response.officer;
          $('certifyingOfficerRate').value = officer.rate || '';
          $('certifyingOfficerLastName').value = officer.last_name || '';
          $('certifyingOfficerFirstInitial').value = officer.first_initial || '';
          $('certifyingOfficerMiddleInitial').value = officer.middle_initial || '';
          updateCertifyingOfficerPreview();
        }
      } catch (error) {
        console.error('Failed to load certifying officer:', error);
      }
    }
    
    $('certifyingOfficerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const rate = $('certifyingOfficerRate').value.trim().toUpperCase();
      const lastName = $('certifyingOfficerLastName').value.trim().toUpperCase();
      const firstInitial = $('certifyingOfficerFirstInitial').value.trim().toUpperCase();
      const middleInitial = $('certifyingOfficerMiddleInitial').value.trim().toUpperCase();
      
      if (!lastName) {
        alert('Last name is required');
        return;
      }
      
      const statusDiv = $('certifyingOfficerStatus');
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'ğŸ’¾ Saving...';
      statusDiv.style.display = 'none';
      
      try {
        const response = await apiPost('/api/certifying_officer', {
          rate: rate,
          last_name: lastName,
          first_initial: firstInitial,
          middle_initial: middleInitial
        });
        
        if (response.status === 'success') {
          statusDiv.textContent = 'âœ… Certifying officer saved successfully!';
          statusDiv.style.display = 'block';
          statusDiv.style.background = 'rgba(22, 199, 132, 0.15)';
          statusDiv.style.border = '1px solid rgba(22, 199, 132, 0.3)';
          statusDiv.style.color = '#16c784';
          
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 3000);
        } else {
          throw new Error(response.error || 'Failed to save');
        }
      } catch (error) {
        statusDiv.textContent = 'âŒ Error: ' + error.message;
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'rgba(255, 91, 107, 0.15)';
        statusDiv.style.border = '1px solid rgba(255, 91, 107, 0.3)';
        statusDiv.style.color = '#ff5b6b';
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    });
    
    // Add event listeners for live preview
    ['certifyingOfficerRate', 'certifyingOfficerLastName', 'certifyingOfficerFirstInitial', 'certifyingOfficerMiddleInitial'].forEach(id => {
      $(id).addEventListener('input', updateCertifyingOfficerPreview);
    });


    $('yearNow').textContent = new Date().getFullYear();
    loadMembers(); // Load member list on page load
    loadCertifyingOfficer(); // Load certifying officer on page load
  </script>
</body>
</html>
