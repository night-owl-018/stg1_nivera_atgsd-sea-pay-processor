<!DOCTYPE html>
<html>
<head>
    <title>ATGSD Sea Pay Processor</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #010409;
            --bg-header: #161b22;
            --bg-card: #0d1117;
            --bg-card-soft: #161b22;
            --border-subtle: #30363d;
            --text-primary: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --accent-soft: rgba(88, 166, 255, 0.4);
            --accent-danger: #f85149;
            --accent-warning: #d29922;
            --status-ready: #656d76;
            --status-processing: #d29922;
            --status-complete: #2ea043;
            --status-error: #f85149;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: radial-gradient(circle at top, #0d1117 0, #010409 55%, #000000 100%);
            font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text-primary);
        }

        /* HEADER */
        header {
            background: var(--bg-header);
            border-bottom: 1px solid var(--border-subtle);
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 20;
        }

        header h1 {
            margin: 0;
            font-size: 18px;
            letter-spacing: 0.04em;
        }

        header .subtitle {
            margin-top: 2px;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* LAYOUT */
        .container {
            max-width: 1200px;
            margin: 16px auto 24px;
            padding: 0 16px;
        }

        .grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .left,
        .right {
            flex: 1;
            min-width: 320px;
        }

        /* CARDS */
        .card {
            background: linear-gradient(145deg, var(--bg-card) 0, var(--bg-card-soft) 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 16px 16px 14px;
            margin-bottom: 16px;
            box-shadow:
                0 10px 30px rgba(0, 0, 0, 0.45),
                0 0 0 1px rgba(22, 27, 34, 0.4);
        }

        .card h3 {
            margin: 0 0 6px;
            font-size: 14px;
        }

        .card p {
            margin: 0 0 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .hint {
            font-size: 11px;
            color: var(--text-muted);
        }

        input[type="file"],
        input[type="text"],
        select {
            width: 100%;
            margin-top: 6px;
            margin-bottom: 6px;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            background: #010409;
            color: var(--text-primary);
            font-size: 12px;
        }

        input[type="file"]::file-selector-button {
            border: 1px solid var(--border-subtle);
            padding: 4px 10px;
            border-radius: 6px;
            background: #161b22;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 11px;
        }

        input[type="file"]::file-selector-button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* TOOLBAR BUTTONS */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .toolbar button {
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: #161b22;
            color: var(--text-primary);
            padding: 6px 14px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .toolbar button.primary {
            background: #238636;
            border-color: #2ea043;
        }

        .toolbar button.primary:hover:not(:disabled) {
            background: #2ea043;
        }

        .toolbar button.danger {
            background: #3d1a1b;
            border-color: #f85149;
            color: #f85149;
        }

        .toolbar button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        /* STATUS LINE */
        .status {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            border-radius: 999px;
            padding: 6px 10px;
            border: 1px solid var(--border-subtle);
            background: #020711;
        }

        .status-label {
            color: var(--text-muted);
        }

        .status-pill {
            border-radius: 999px;
            padding: 3px 8px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            border: 1px solid var(--border-subtle);
        }

        .status-pill-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #6e7681;
        }

        .status-ready .status-pill {
            background: rgba(110, 118, 129, 0.16);
            border-color: rgba(110, 118, 129, 0.7);
            color: var(--status-ready);
        }

        .status-processing .status-pill {
            background: rgba(210, 153, 34, 0.16);
            border-color: rgba(210, 153, 34, 0.7);
            color: var(--status-processing);
        }

        .status-complete .status-pill {
            background: rgba(46, 160, 67, 0.16);
            border-color: rgba(46, 160, 67, 0.7);
            color: var(--status-complete);
        }

        .status-error .status-pill {
            background: rgba(248, 81, 73, 0.16);
            border-color: rgba(248, 81, 73, 0.7);
            color: var(--status-error);
        }

        @keyframes statusPulse {
            0%   { opacity: 1;   transform: translateY(0); }
            50%  { opacity: 0.65; transform: translateY(-0.5px); }
            100% { opacity: 1;   transform: translateY(0); }
        }

        .status-processing .status-pill {
            animation: statusPulse 1.4s ease-in-out infinite;
        }

        /* PROGRESS CARD & BANNER */
        .progress-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 14px;
            border: 1px solid var(--border-subtle);
            margin-bottom: 10px;
            box-shadow:
                0 10px 30px rgba(0, 0, 0, 0.45),
                0 0 0 1px rgba(22, 27, 34, 0.4);
        }

        .progress-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px 12px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .progress-label {
            color: var(--text-muted);
        }

        .progress-value {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .progress-bar-outer {
            position: relative;
            height: 6px;
            border-radius: 999px;
            background: rgba(110, 118, 129, 0.35);
            overflow: hidden;
            margin: 6px 0 4px;
        }

        .progress-bar-inner {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--accent) 0, var(--accent-soft) 100%);
            transition: width 0.2s ease-out;
        }

        .progress-step {
            font-size: 11px;
            color: var(--text-muted);
            min-height: 14px;
        }

        .banner {
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }

        .banner-success {
            background: rgba(46, 160, 67, 0.16);
            border-color: rgba(46, 160, 67, 0.7);
            color: var(--status-complete);
        }

        .banner-error {
            background: rgba(248, 81, 73, 0.16);
            border-color: rgba(248, 81, 73, 0.7);
            color: var(--status-error);
        }

        .banner-hidden {
            display: none;
        }

        /* THEME TOGGLE */
        .theme-toggle {
            background: transparent;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
        }
        .theme-toggle:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        body.theme-light {
            --bg-body: #f4f5f7;
            --bg-header: #e5e7eb;
            --bg-card: #ffffff;
            --bg-card-soft: #f3f4f6;
            --border-subtle: #d0d7de;
            --text-primary: #111827;
            --text-muted: #6b7280;
            --accent: #2563eb;
            --accent-soft: rgba(37, 99, 235, 0.35);
        }

        /* LOGS SECTION */
        .logs {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 14px;
            border: 1px solid var(--border-subtle);
            margin-top: 10px;
            box-shadow:
                0 10px 30px rgba(0, 0, 0, 0.45),
                0 0 0 1px rgba(22, 27, 34, 0.4);
        }

        .logs h3 {
            margin: 0 0 6px;
            font-size: 14px;
        }

        #logBox {
            background: #02040a;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 8px;
            height: 260px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
            font-family: Consolas, "SF Mono", Menlo, Monaco, monospace;
        }

        footer {
            margin-top: 16px;
            font-size: 11px;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar button {
                width: 100%;
                justify-content: center;
            }

            #logBox {
                height: 220px;
            }
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>ATGSD SEA PAY PROCESSOR</h1>
        <div class="subtitle">Local-only tool for TORIS Sea Duty Certification Sheets &amp; NAVPERS 1070/613 generation.</div>
    </div>
    <div>
        <button type="button" class="theme-toggle" onclick="toggleTheme()" id="themeToggle">Dark</button>
    </div>
</header>

<div class="container">
    <div class="grid">
        <div class="left">
            <form id="uploadForm" action="/process" method="POST" enctype="multipart/form-data">

                <div class="card">
                    <h3>INPUT PDFS (SEA DUTY CERTIFICATION SHEETS)</h3>
                    <p>Select one or more PDFs exported from TORIS "Sea Duty Certification Sheet".</p>
                    <input type="file" name="files" multiple required>
                    <p class="hint">
                        All PDFs will be saved to the container's <code>/data</code> directory, then processed.
                    </p>
                </div>

                <div class="card">
                    <h3>FORM NAVPERS 1070/613 (OPTIONAL)</h3>
                    <p>If you have a NAVPERS 1070/613 PDF, upload it here. Otherwise, the default template is used.</p>
                    <input type="file" name="template_file">
                    <p class="hint">
                        The template is stored under <code>/templates</code>. Updating it here overwrites the existing one.
                    </p>
                </div>

                <div class="card">
                    <h3>RATES CSV (OPTIONAL)</h3>
                    <p>Upload the ATGSD rates CSV if you need to update or change names/rates.</p>
                    <input type="file" name="rate_file">
                    <p class="hint">
                        The CSV is stored under <code>/config/atgsd_n811.csv</code>. New uploads overwrite the previous file.
                    </p>
                </div>

                <div class="card">
                    <h3>OPTIONS</h3>
                    <div>
                        <label for="strike_color">Strikeout Color (TORIS Sheet):</label>
                        <select
                            name="strike_color"
                            id="strike_color"
                            style="margin-top: 4px; padding: 4px; border-radius: 6px; background:#010409; border:1px solid var(--border-subtle); color:var(--text-primary);"
                        >
                            <option value="black" selected>Black (Default)</option>
                            <option value="red">Red</option>
                        </select>
                    </div>

                    <div class="toolbar">
                        <button type="submit" id="submitBtn" class="primary">RUN PROCESSOR</button>
                        <button type="button" onclick="downloadMerged()">MERGED SEA PAY PG13</button>
                        <button type="button" onclick="downloadSummary()">MERGED SUMMARY</button>
                        <button type="button" onclick="downloadAll()">EXPORT ZIP</button>

                        <button type="button" onclick="location.href='/download_marked_sheets'">TORIS Sea Pay Cert Sheets</button>
                        <button type="button" onclick="location.href='/download_tracking'">TRACKER FILE</button>

                        <button type="button" onclick="resetAll()" class="danger">RESET ALL</button>
                    </div>

                    <div class="status status-ready" id="statusText">
                        <span class="status-label">Status</span>
                        <span class="status-pill">
                            <span class="status-pill-dot"></span>
                            READY
                        </span>
                    </div>
                </div>
            </form>
        </div>

        <div class="right">
            <div class="card">
                <h3>HOW IT WORKS</h3>
                <p>This tool runs completely inside your Unraid Docker container, without sending data outside.</p>
                <ul class="hint">
                    <li>Uploads: Stored in <code>/data</code> inside the container.</li>
                    <li>Outputs: Written to <code>/output</code>, including:
                        <ul>
                            <li>Per-ship NAVPERS 1070/613 PDFs (Sea Pay PG13).</li>
                            <li>Summary TXT + PDF of valid / invalid days.</li>
                            <li>TORIS Sea Duty Certification Sheets with invalid rows struck out.</li>
                        </ul>
                    </li>
                    <li>No network calls are made by this app.</li>
                </ul>
            </div>

            <div class="progress-card" id="progressCard">
                <h3>PROCESS STATUS</h3>
                <div id="progressBanner" class="banner banner-hidden"></div>
                <div class="progress-grid">
                    <div class="progress-label">Files processed</div>
                    <div class="progress-value"><span id="filesProcessed">0</span> / <span id="filesTotal">0</span></div>

                    <div class="progress-label">Valid days</div>
                    <div class="progress-value" id="validDays">0</div>

                    <div class="progress-label">Invalid events</div>
                    <div class="progress-value" id="invalidEvents">0</div>

                    <div class="progress-label">PG13 generated</div>
                    <div class="progress-value" id="pg13Count">0</div>

                    <div class="progress-label">TORIS marked</div>
                    <div class="progress-value" id="torisMarked">0</div>
                </div>
                <div class="progress-bar-outer">
                    <div class="progress-bar-inner" id="progressBarInner"></div>
                </div>
                <div class="progress-step" id="progressStep">Idle</div>
            </div>

            <div class="logs">
                <h3>LIVE OPERATION LOG</h3>
                <div id="logBox"></div>
            </div>

            <footer>
                <span>ATGSD SEA PAY PROCESSOR</span> &nbsp;|&nbsp; For internal training / admin use only.
            </footer>
        </div>
    </div>
</div>

<script>
    let isPolling = false;
    let autoScroll = true;
    let lastText = "";

    let isProcessing = false;
    let progressTimer = null;

    const logBox = document.getElementById("logBox");
    const statusText = document.getElementById("statusText");
    const submitBtn = document.getElementById("submitBtn");
    const allToolbarButtons = document.querySelectorAll(".toolbar button");

    const filesProcessedEl = document.getElementById("filesProcessed");
    const filesTotalEl = document.getElementById("filesTotal");
    const validDaysEl = document.getElementById("validDays");
    const invalidEventsEl = document.getElementById("invalidEvents");
    const pg13CountEl = document.getElementById("pg13Count");
    const torisMarkedEl = document.getElementById("torisMarked");
    const progressBarInner = document.getElementById("progressBarInner");
    const progressStepEl = document.getElementById("progressStep");
    const progressBanner = document.getElementById("progressBanner");
    const themeToggle = document.getElementById("themeToggle");

    // Maintain auto-scroll behavior
    logBox.addEventListener("scroll", () => {
        autoScroll =
            logBox.scrollHeight - logBox.scrollTop - logBox.clientHeight < 30;
    });

    // GitHub-style status setter (text + class)
    function setStatus(state, label) {
        // state: "ready" | "processing" | "complete" | "error"
        statusText.classList.remove(
            "status-ready",
            "status-processing",
            "status-complete",
            "status-error",
        );
        if (state === "processing") {
            statusText.classList.add("status-processing");
        } else if (state === "complete") {
            statusText.classList.add("status-complete");
        } else if (state === "error") {
            statusText.classList.add("status-error");
        } else {
            statusText.classList.add("status-ready");
        }

        // Update pill text only (keep label word "Status")
        const pill = statusText.querySelector(".status-pill");
        if (pill) {
            const children = pill.childNodes;
            if (pill.children.length >= 2) {
                pill.children[1].textContent = label
                    .replace("STATUS:", "")
                    .trim();
            } else {
                pill.textContent = label.replace("STATUS:", "").trim();
            }
        }
    }

    function setButtonsDisabled(disabled) {
        allToolbarButtons.forEach((btn) => {
            btn.disabled = disabled;
        });
        submitBtn.disabled = disabled;
    }

    function updateProgressUI(p) {
        if (!p) return;
        const details = p.details || {};

        if (filesTotalEl) filesTotalEl.textContent = p.total_files || 0;
        if (filesProcessedEl)
            filesProcessedEl.textContent = details.files_processed || 0;
        if (validDaysEl) validDaysEl.textContent = details.valid_days || 0;
        if (invalidEventsEl)
            invalidEventsEl.textContent = details.invalid_events || 0;
        if (pg13CountEl)
            pg13CountEl.textContent = details.pg13_created || 0;
        if (torisMarkedEl)
            torisMarkedEl.textContent = details.toris_marked || 0;

        if (progressBarInner) {
            const pct = p.percentage || 0;
            progressBarInner.style.width = pct + "%";
        }

        if (progressStepEl) {
            progressStepEl.textContent = p.current_step || "";
        }
    }

    function showBanner(message, type) {
        if (!progressBanner) return;
        progressBanner.textContent = message || "";
        progressBanner.classList.remove(
            "banner-hidden",
            "banner-success",
            "banner-error",
        );
        if (type === "success") {
            progressBanner.classList.add("banner-success");
        } else if (type === "error") {
            progressBanner.classList.add("banner-error");
        } else {
            progressBanner.classList.add("banner-hidden");
        }
    }

    function startProgressPolling() {
        if (progressTimer) {
            return;
        }

        const poll = () => {
            fetch("/progress")
                .then((r) => r.json())
                .then((data) => {
                    updateProgressUI(data);
                    if (data.status === "processing") {
                        isProcessing = true;
                        progressTimer = setTimeout(poll, 300);
                    } else {
                        isProcessing = false;
                        progressTimer = null;
                        setButtonsDisabled(false);
                        if (data.status === "complete") {
                            setStatus("complete", "STATUS: COMPLETE");
                            showBanner("Processing complete", "success");
                        } else if (data.status === "error") {
                            setStatus("error", "STATUS: ERROR");
                            showBanner("Processing error", "error");
                        }
                    }
                })
                .catch(() => {
                    progressTimer = setTimeout(poll, 1000);
                });
        };

        poll();
    }

    function toggleTheme() {
        const body = document.body;
        const isLight = body.classList.toggle("theme-light");
        if (themeToggle) {
            themeToggle.textContent = isLight ? "Light" : "Dark";
        }
        try {
            localStorage.setItem("atgsd_theme", isLight ? "light" : "dark");
        } catch (e) {
            // ignore
        }
    }

    // Initialize theme from storage
    (function initTheme() {
        try {
            const stored = localStorage.getItem("atgsd_theme");
            if (stored === "light") {
                document.body.classList.add("theme-light");
                if (themeToggle) themeToggle.textContent = "Light";
            }
        } catch (e) {
            // ignore
        }
    })();

    // Initial poll
    pollLogs();

    function pollLogs() {
        if (isPolling) return;
        isPolling = true;

        fetch("/logs")
            .then((r) => r.text())
            .then((txt) => {
                if (txt === lastText) {
                    isPolling = false;
                    setTimeout(pollLogs, 1000);
                    return;
                }

                const prevHeight = logBox.scrollHeight;
                const prevTop = logBox.scrollTop;

                logBox.textContent = txt;
                lastText = txt;

                if (autoScroll && isProcessing) {
                    logBox.scrollTop = logBox.scrollHeight;
                } else {
                    logBox.scrollTop =
                        prevTop + (logBox.scrollHeight - prevHeight);
                }

                isPolling = false;
                setTimeout(pollLogs, 1000);
            })
            .catch(() => {
                isPolling = false;
                setTimeout(pollLogs, 2000);
            });
    }

    document
        .getElementById("uploadForm")
        .addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const btn = submitBtn;

            isProcessing = true;
            btn.innerText = "PROCESSING...";
            setButtonsDisabled(true);
            setStatus("processing", "STATUS: PROCESSING...");
            showBanner("", null);
            startProgressPolling();

            fetch("/process", { method: "POST", body: formData })
                .then((res) => {
                    if (!res.ok) {
                        throw new Error("Process start failed");
                    }
                    // Background thread and /progress will handle completion
                })
                .catch(() => {
                    isProcessing = false;
                    setButtonsDisabled(false);
                    btn.innerText = "RUN PROCESSOR";
                    setStatus("error", "STATUS: ERROR");
                    showBanner("Failed to start processor", "error");
                });
        });

    function downloadMerged() {
        location.href = "/download_merged";
    }

    function downloadSummary() {
        location.href = "/download_summary";
    }

    function downloadAll() {
        location.href = "/download_all";
    }

    function resetAll() {
        if (!confirm("Delete ALL input/output files and logs?")) return;

        fetch("/reset", { method: "POST" })
            .then((r) => r.json())
            .then((data) => {
                alert(data.message || "Reset complete");

                // Reset status to READY
                setStatus("ready", "STATUS: READY");

                // Reset strike color to default
                document.getElementById("strike_color").value = "black";

                // Clear log window immediately
                logBox.textContent = "";
                lastText = "";

                // Reset progress UI
                if (filesTotalEl) filesTotalEl.textContent = "0";
                if (filesProcessedEl) filesProcessedEl.textContent = "0";
                if (validDaysEl) validDaysEl.textContent = "0";
                if (invalidEventsEl) invalidEventsEl.textContent = "0";
                if (pg13CountEl) pg13CountEl.textContent = "0";
                if (torisMarkedEl) torisMarkedEl.textContent = "0";
                if (progressBarInner) progressBarInner.style.width = "0%";
                if (progressStepEl) progressStepEl.textContent = "Idle";
                showBanner("", null);
            });
    }
</script>

</body>
</html>
