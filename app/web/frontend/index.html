<!DOCTYPE html>
<html>
<head>
<title>ATGSD Sea Pay Processor</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
    background: #0e1117;
    font-family: Inter, Consolas, monospace;
    margin: 0;
    color:#c9d1d9;
}

/* HEADER */
header {
    background:#161b22;
    padding:16px;
    border-bottom:1px solid #30363d;
}
header h1 {
    margin:0;
    color:#58a6ff;
    font-size:20px;
}

/* LAYOUT */
.container {
    max-width:1200px;
    margin:20px auto;
    padding:10px;
}

.grid {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:16px;
}

/* CARD FIX */
.card {
    background:linear-gradient(180deg,#161b22,#0e1117);
    border-radius:10px;
    padding:16px;
    border:1px solid #21262d;
    box-sizing:border-box;
    overflow:hidden;
}

.card h3 {
    margin-top:0;
    font-size:14px;
    letter-spacing:0.5px;
    color:#8b949e;
}

/* FILE INPUT FIX */
input[type="file"] {
    width:100%;
    max-width:100%;
    padding:12px;
    border-radius:8px;
    background:#0e1117;
    border:1px dashed #30363d;
    color:#c9d1d9;
    box-sizing:border-box;
}

input[type="file"]::file-selector-button {
    background:#21262d;
    color:#c9d1d9;
    border:1px solid #30363d;
    padding:6px 12px;
    margin-right:10px;
    border-radius:6px;
    cursor:pointer;
    max-width:100%;
}

input[type="file"]::file-selector-button:hover {
    border-color:#58a6ff;
    color:#58a6ff;
}

input[type="file"]:hover {
    border-color:#58a6ff;
}

/* CONTROL BUTTONS */
.toolbar {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:12px;
}
button {
    background:#21262d;
    color:#c9d1d9;
    border:1px solid #30363d;
    padding:10px 14px;
    border-radius:8px;
    font-weight:600;
    cursor:pointer;
}
button:hover {
    border-color:#58a6ff;
}
button.primary {
    background:#1f6feb;
    border:none;
    color:white;
}
button.danger {
    background:#da3633;
    border:none;
    color:white;
}

/* PATHS */
.paths {
    margin-top:6px;
    font-size:12px;
    color:#8b949e;
}

/* STATUS */
.status {
    margin-top:10px;
    font-size:12px;
    color:#8b949e;
}

/* LOG CONSOLE */
.logs {
    margin-top:18px;
    background:#161b22;
    padding:16px;
    border-radius:8px;
    border:1px solid #30363d;
}
.logs h3 {
    margin:0 0 10px 0;
    color:#8b949e;
    font-size:14px;
}
#logBox {
    height:340px;
    background:#0e1117;
    border:1px solid #30363d;
    padding:12px;
    font-size:12px;
    white-space:pre-wrap;
    overflow-y:auto;
    font-family:Consolas, monospace;
}

/* FOOTER */
footer {
    margin-top:24px;
    text-align:center;
    font-size:12px;
    color:#8b949e;
}
</style>
</head>

<body>

<header>
<h1>ATG SAN DIEGO | SEA PAY PROCESSOR</h1>
</header>

<div class="container">

<form id="uploadForm" enctype="multipart/form-data">

<div class="grid">

    <div class="card">
        <h3>SEA DUTY CERTIFICATION SHEETS (TORIS)</h3>
        <input type="file" name="files" multiple>
    </div>

    <div class="card">
        <h3>NAVPERS 1070/613 TEMPLATE</h3>
        <input type="file" name="template_file">
        <div class="paths">Current: {{ template_path }}</div>
    </div>

    <div class="card">
        <h3>N811 PERSONNEL ROSTER (CSV)</h3>
        <input type="file" name="rate_file">
        <div class="paths">Current: {{ rate_path }}</div>
    </div>

    <div class="card">
        <h3>PROCESS CONTROL</h3>

        <div class="toolbar">
            <button type="submit" id="submitBtn" class="primary">RUN PROCESSOR</button>
            <button type="button" onclick="downloadMerged()">MERGED PDF</button>
            <button type="button" onclick="downloadSummary()">SUMMARY TXT</button>
            <button type="button" onclick="downloadAll()">DOWNLOAD ZIP</button>
            
            <button type="button" onclick="location.href='/download_marked_sheets'">MARKED SHEETS</button>
            <button type="button" onclick="location.href='/download_validation'">VALIDATION REPORTS</button>
            
            <button type="button" onclick="resetAll()" class="danger">RESET</button>
        </div>

        <div class="status" id="statusText">STATUS: READY</div>
    </div>

</div>

</form>

<div class="logs">
<h3>LIVE OPERATION LOG</h3>
<div id="logBox">{{ logs }}</div>
</div>

<footer>
STG1(SW) Nivera, Ryan | ATGSD
</footer>

</div>

<script>
let isPolling=false;
let autoScroll=true;
let lastText="";

const logBox=document.getElementById("logBox");
const statusText=document.getElementById("statusText");

logBox.addEventListener("scroll",()=>{
    autoScroll=(logBox.scrollHeight-logBox.scrollTop-logBox.clientHeight)<30;
});

pollLogs();

function pollLogs(){
    if(isPolling) return;
    isPolling=true;

    fetch("/logs")
    .then(r=>r.text())
    .then(txt=>{
        if(txt===lastText){
            isPolling=false;
            setTimeout(pollLogs,1000);
            return;
        }

        const prevTop=logBox.scrollTop;
        const prevHeight=logBox.scrollHeight;

        logBox.innerText=txt;
        lastText=txt;

        if(autoScroll){
            logBox.scrollTop=logBox.scrollHeight;
        } else {
            logBox.scrollTop=prevTop+(logBox.scrollHeight-prevHeight);
        }

        isPolling=false;
        setTimeout(pollLogs,1000);
    })
    .catch(()=>{
        isPolling=false;
        setTimeout(pollLogs,2000);
    });
}

document.getElementById("uploadForm").addEventListener("submit",function(e){
    e.preventDefault();

    const formData=new FormData(this);
    const btn=document.getElementById("submitBtn");

    btn.innerText="PROCESSING...";
    btn.disabled=true;
    statusText.innerText="STATUS: PROCESSING...";

    fetch("/",{method:"POST",body:formData})
    .then(()=>{
        btn.disabled=false;
        btn.innerText="RUN PROCESSOR";
        statusText.innerText="STATUS: COMPLETE";
    })
    .catch(()=>{
        btn.disabled=false;
        btn.innerText="RUN PROCESSOR";
        statusText.innerText="STATUS: ERROR";
    });
});

function downloadMerged(){location.href="/download_merged";}
function downloadSummary(){location.href="/download_summary";}
function downloadAll(){location.href="/download_all";}

function resetAll(){
    if(!confirm("Delete ALL input/output files and logs?")) return;
    fetch("/reset",{method:"POST"})
    .then(r=>r.json())
    .then(data=>{
        alert(data.message||"Reset complete");
        statusText.innerText="STATUS: READY";
    });
}
</script>

</body>
</html>
