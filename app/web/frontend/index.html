<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ATGSD Sea Pay Processor</title>
  <style>
    :root{--navy:#0b4c6b;--border:#d9d9d9;--bg:#f6f7f9;--panel:#fff;--mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#111;}
    header{background:var(--navy);color:#fff;padding:14px 18px;font-weight:700;}
    .wrap{padding:16px 18px;}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:18px;align-items:start;}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:4px;}
    .card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;letter-spacing:.02em;}
    .card .body{padding:12px;}
    label{display:block;font-size:12px;margin:10px 0 6px;}
    input[type=file], select{width:100%;}
    button{width:100%;padding:9px 10px;border:1px solid #1a4f6b;background:var(--navy);color:#fff;border-radius:2px;font-weight:700;cursor:pointer;}
    button.secondary{background:#fff;color:#111;border:1px solid var(--border);font-weight:600;}
    button.danger{background:#b00000;border-color:#8a0000;}
    .stack > * + *{margin-top:10px;}
    .status{font-size:13px;}
    .logbox{height:260px;overflow:auto;background:#000;color:#35ff57;font-family:var(--mono);font-size:12px;line-height:1.35;padding:10px;white-space:pre;}
    .review-controls{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px;}
    .review-controls select{height:32px;}
    table{width:100%;border-collapse:collapse;font-size:12px;}
    th,td{border:1px solid var(--border);padding:6px 8px;vertical-align:middle;}
    th{background:#eee;text-align:left;}
    tr.valid{background:#eaffea;}
    tr.invalid{background:#ffecec;}
    .override-cell{min-width:240px;}
    .override-wrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .override-wrap select{width:150px;height:28px;}
    .override-wrap input{flex:1;min-width:160px;height:26px;padding:0 6px;}
    .small{font-size:12px;color:#444;}
    footer{padding:10px;text-align:center;color:#777;font-size:11px;}
  </style>
</head>
<body>
<header>ATGSD Sea Pay Processor</header>

<div class="wrap">
  <div class="grid">
    <div class="stack">
      <div class="card">
        <h3>INPUT</h3>
        <div class="body">
          <form id="processForm" class="stack">
            <div>
              <label>SEA DUTY CERTIFICATION SHEETS (PDF)</label>
              <input id="pdfs" name="pdfs" type="file" accept="application/pdf" multiple required>
            </div>

            <div>
              <label>RATE CSV</label>
              <input id="ratesCsv" name="rates_csv" type="file" accept=".csv">
            </div>

            <div>
              <label>NAVPERS 1070/613 TEMPLATE</label>
              <input id="templatePdf" name="template_pdf" type="file" accept="application/pdf">
            </div>

            <div>
              <label>Strikeout Color</label>
              <select id="strikeColor" name="strikeout_color">
                <option value="Black" selected>Black</option>
                <option value="Red">Red</option>
              </select>
            </div>

            <button type="submit" id="processBtn">PROCESS</button>
          </form>
        </div>
      </div>

      <div class="card">
        <h3>STATUS</h3>
        <div class="body">
          <div class="status" id="statusText">Idle</div>
        </div>
      </div>

      <div class="card">
        <h3>DOWNLOADS</h3>
        <div class="body">
          <button class="secondary" type="button" id="btnMerged">Merged Package</button>
          <button class="secondary" type="button" id="btnAll" style="margin-top:8px;">Download All</button>
          <div class="small" style="margin-top:8px;">(If a download is empty, run PROCESS first.)</div>
        </div>
      </div>

      <div class="card">
        <div class="body">
          <button class="danger" type="button" id="btnReset">RESET ALL</button>
        </div>
      </div>
    </div>

    <div class="stack">
      <div class="card">
        <h3>LIVE LOG</h3>
        <div class="body">
          <div id="liveLog" class="logbox"></div>
        </div>
      </div>

      <div class="card">
        <h3>REVIEW &amp; OVERRIDE</h3>
        <div class="body">
          <div class="review-controls">
            <div>
              <label>Member</label>
              <select id="memberSelect">
                <option value="">Select member</option>
              </select>
            </div>
            <div>
              <label>Sheet</label>
              <select id="sheetSelect" disabled>
                <option value="">Select sheet</option>
              </select>
            </div>
          </div>

          <div class="small" id="reviewHint">Pick a member and a sheet to edit auto results.</div>

          <div style="margin-top:10px;">
            <div style="font-weight:700;font-size:12px;margin:6px 0;">Valid Rows</div>
            <table>
              <thead>
                <tr>
                  <th style="width:110px;">Date</th>
                  <th style="width:220px;">Ship</th>
                  <th style="width:110px;">Final</th>
                  <th class="override-cell">Override</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody id="validBody"></tbody>
            </table>
          </div>

          <div style="margin-top:12px;">
            <div style="font-weight:700;font-size:12px;margin:6px 0;">Invalid Events</div>
            <table>
              <thead>
                <tr>
                  <th style="width:110px;">Date</th>
                  <th style="width:220px;">Ship</th>
                  <th style="width:110px;">Final</th>
                  <th class="override-cell">Override</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody id="invalidBody"></tbody>
            </table>
          </div>

          <!-- ===== PATCH: explicit save button ===== -->
          <div style="margin-top:12px;text-align:right;">
            <button type="button" id="saveOverridesBtn" onclick="saveOverrides()">
              Save Overrides
            </button>
          </div>
          <!-- ======================================= -->

        </div>
      </div>

      <footer>ATGSD Sea Pay Processor</footer>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  let lastStatus = null;

  /* ===== PATCH: staging buffer ===== */
  let pendingOverrides = {};
  /* ================================= */

  function safeText(v){ if(v===null||v===undefined) return ""; return typeof v==="object"?JSON.stringify(v):String(v); }

  function pick(obj, keys, fallback=""){
    if(!obj) return fallback;
    for(const k of keys){ if(obj[k]!==undefined && obj[k]!==null && obj[k]!=="") return obj[k]; }
    return fallback;
  }

  async function jget(url){ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(r.status); return r.json(); }
  async function jpost(url,p){ const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)}); if(!r.ok) throw new Error(r.status); return r.json(); }
  async function jdel(url,p){ const r=await fetch(url,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)}); if(!r.ok) throw new Error(r.status); return r.json(); }

  async function pollProgress(){
    try{
      const d=await jget("/progress");
      const pct=pick(d,["percent"],null);
      const st=pick(d,["status"],"Idle");
      if(st==="COMPLETE" && lastStatus!=="COMPLETE") refreshReviewLists();
      lastStatus=st;
      $("statusText").textContent=pct!==null?`${st} (${pct}%)`:st;
      $("liveLog").textContent=d.log||"";
      $("liveLog").scrollTop=$("liveLog").scrollHeight;
    }catch{}
  }
  setInterval(pollProgress,1000); pollProgress();

  function buildOverrideControl(memberKey,sheetFile,eventIndex,curStatus,curReason,source){
    const wrap=document.createElement("div"); wrap.className="override-wrap";
    const sel=document.createElement("select");
    ["","valid","invalid"].forEach(v=>{const o=document.createElement("option");o.value=v;o.textContent=v===""?"Auto":(v==="valid"?"Force Valid":"Force Invalid");sel.appendChild(o);});
    sel.value=curStatus||"";
    const reason=document.createElement("input"); reason.value=curReason||"";

    /* ===== PATCH: queue instead of auto-save ===== */
    const queue=()=>{
      const k=memberKey+"|"+sheetFile+"|"+eventIndex;
      pendingOverrides[k]={member_key:memberKey,sheet_file:sheetFile,event_index:eventIndex,status:sel.value||null,reason:reason.value||"",source:source||"manual"};
    };
    sel.addEventListener("change",queue);
    reason.addEventListener("input",queue);
    /* ============================================ */

    wrap.appendChild(sel); wrap.appendChild(reason);
    return wrap;
  }

  /* ===== PATCH: explicit save ===== */
  async function saveOverrides(){
    const list=Object.values(pendingOverrides);
    if(list.length===0){ alert("No changes to save."); return; }
    for(const o of list){
      if(!o.status && !o.reason) await jdel("/api/override",o);
      else await jpost("/api/override",o);
    }
    pendingOverrides={};
    await loadSheet($("memberSelect").value,$("sheetSelect").value);
    alert("Overrides saved.");
  }
  /* ================================ */

  async function refreshReviewLists(){
    const m=await jget("/api/members");
    const sel=$("memberSelect"); sel.innerHTML='<option value="">Select member</option>';
    m.forEach(x=>{const o=document.createElement("option");o.value=x;o.textContent=x;sel.appendChild(o);});
  }

  async function loadSheet(m,s){
    if(!m||!s) return;
    const d=await jget("/api/member/"+encodeURIComponent(m)+"/sheet/"+encodeURIComponent(s));
    renderRows($("validBody"),d.valid||[],m,s,"valid");
    renderRows($("invalidBody"),d.invalid_events||[],m,s,"invalid");
  }

  function renderRows(tb,rows,m,s,cls){
    tb.innerHTML="";
    rows.forEach((r,i)=>{
      const tr=document.createElement("tr"); tr.className=cls;
      tr.innerHTML=`<td>${safeText(r.date)}</td><td>${safeText(r.ship)}</td><td>${safeText(r.final)}</td>`;
      const td=document.createElement("td"); td.appendChild(buildOverrideControl(m,s,i,r.override?.status,r.override?.reason,r.override?.source));
      tr.appendChild(td);
      tr.innerHTML+=`<td>${safeText(r.reason)}</td>`;
      tb.appendChild(tr);
    });
  }

  $("memberSelect").addEventListener("change",async()=>loadSheetsForMember($("memberSelect").value));
  $("sheetSelect").addEventListener("change",async()=>loadSheet($("memberSelect").value,$("sheetSelect").value));

  refreshReviewLists();
</script>
</body>
</html>
