<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=yes, maximum-scale=5"/>
  <title>ATGSD Sea Pay Processor</title>
  <style>
    :root {
      --navy-dark: #0a3854;
      --navy: #0e5578;
      --accent: #6fb7ff;
      --success: #16c784;
      --danger: #ff5b6b;
      --warning: #f5c451;
      --border: rgba(255,255,255,0.10);
      --bg: #070b14;
      --panel: rgba(20, 28, 48, 0.72);
      --text-primary: rgba(245,248,255,0.92);
      --text-secondary: rgba(245,248,255,0.62);
      --shadow-sm: 0 10px 26px rgba(0,0,0,0.35);
      --shadow: 0 18px 50px rgba(0,0,0,0.45);
      --mono: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
      --r: 14px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    img, svg, video, canvas { max-width: 100%; height: auto; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: radial-gradient(900px 380px at 50% -60px, rgba(90,160,255,0.22), transparent 60%),
                  radial-gradient(700px 340px at 18% 18%, rgba(22,199,132,0.10), transparent 55%),
                  radial-gradient(700px 340px at 85% 22%, rgba(255,91,107,0.10), transparent 55%),
                  linear-gradient(180deg, #040714 0%, #070b14 45%, #040714 100%);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* Header */
    header {
      background: linear-gradient(90deg, rgba(24,34,58,0.78), rgba(10,14,28,0.78));
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    .header-inner {
      max-width: 1600px;
      margin: 0 auto;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
    }
    
    .header-inner::after {
      content: "";
      position: absolute;
      left: 16px;
      right: 16px;
      bottom: -1px;
      height: 3px;
      background: linear-gradient(90deg, transparent, rgba(120,190,255,0.75), transparent);
      opacity: 0.55;
    }

    header h1 {
      font-size: clamp(16px, 2.2vw, 22px);
      font-weight: 750;
      letter-spacing: -0.02em;
      display: flex;
      gap: 10px;
      align-items: center;
      flex: 1;
    }
    
    .subtitle {
      font-size: clamp(11px, 1.6vw, 13px);
      opacity: 0.88;
      margin-top: 2px;
      color: rgba(245,248,255,0.72);
    }
    
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .header-btn {
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 650;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.18s ease;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }
    
    .header-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(111,183,255,0.35);
      transform: translateY(-1px);
    }

    /* Layout */
    .wrap {
      max-width: 1600px;
      margin: 0 auto;
      padding: 12px 12px 8px;
    }

    .top-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    /* Cards */
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      backdrop-filter: blur(10px);
      position: relative;
    }
    
    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      pointer-events: none;
      background: radial-gradient(520px 160px at 20% 0%, rgba(120,190,255,0.12), transparent 60%),
                  radial-gradient(420px 150px at 85% 10%, rgba(22,199,132,0.08), transparent 60%);
      opacity: 0.8;
    }
    
    .card > * { position: relative; }

    .card h3 {
      padding: 8px 10px;
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-size: 12px;
      font-weight: 750;
      letter-spacing: 0.02em;
      color: rgba(245,248,255,0.92);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card .body { padding: 10px; }

    /* Form Elements */
    label {
      display: block;
      font-size: 11px;
      font-weight: 650;
      margin-bottom: 4px;
      color: var(--text-secondary);
    }

    input[type=file], select, textarea {
      width: 100%;
      padding: 7px 8px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      font-size: 12px;
      background: rgba(6,10,18,0.55);
      color: var(--text-primary);
      transition: all 0.18s ease;
      outline: none;
      font-family: inherit;
    }
    
    input[type=file]::file-selector-button {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text-primary);
      border-radius: 10px;
      padding: 7px 10px;
      margin-right: 10px;
      cursor: pointer;
      transition: all 0.18s ease;
    }
    
    input[type=file]::file-selector-button:hover {
      background: rgba(255,255,255,0.09);
      border-color: rgba(120,190,255,0.30);
    }
    
    input[type=file]:hover, select:hover, textarea:hover {
      border-color: rgba(120,190,255,0.35);
    }
    
    input[type=file]:focus, select:focus, textarea:focus {
      border-color: rgba(120,190,255,0.55);
      box-shadow: 0 0 0 3px rgba(120,190,255,0.18);
    }
    
    textarea {
      resize: vertical;
      min-height: 34px;
    }

    input[type=checkbox] {
      width: auto;
      cursor: pointer;
    }

    /* Buttons */
    button {
      border: 1px solid transparent;
      font-weight: 750;
      cursor: pointer;
      transition: all 0.18s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-family: inherit;
      white-space: nowrap;
      border-radius: 10px;
      padding: 7px 10px;
      font-size: 12px;
    }
    
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    
    button:not(:disabled):active {
      transform: scale(0.99);
    }

    .btn-primary {
      background: linear-gradient(135deg, rgba(111,183,255,0.30), rgba(255,255,255,0.06));
      color: var(--text-primary);
      border-color: rgba(111,183,255,0.26);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    
    .btn-primary:not(:disabled):hover {
      transform: translateY(-1px);
      border-color: rgba(111,183,255,0.42);
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.04);
      color: var(--text-primary);
      border-color: rgba(255,255,255,0.10);
    }
    
    .btn-secondary:not(:disabled):hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(111,183,255,0.24);
      transform: translateY(-1px);
    }

    .btn-danger {
      background: linear-gradient(135deg, rgba(255,91,107,0.32), rgba(255,255,255,0.05));
      color: var(--text-primary);
      border-color: rgba(255,91,107,0.32);
    }
    
    .btn-danger:not(:disabled):hover {
      transform: translateY(-1px);
      border-color: rgba(255,91,107,0.45);
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
    }

    .btn-success {
      background: linear-gradient(135deg, rgba(22,199,132,0.28), rgba(255,255,255,0.05));
      color: var(--text-primary);
      border-color: rgba(22,199,132,0.30);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    
    .btn-success:not(:disabled):hover {
      transform: translateY(-1px);
      border-color: rgba(22,199,132,0.42);
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
    }

    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 6px;
    }
    
    .btn-row button {
      width: 100%;
    }

    .system-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 6px;
    }
    
    .system-actions button {
      width: 100%;
    }

    /* Status */
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 750;
      padding: 7px 10px;
      border-radius: 10px;
      background: rgba(6,10,18,0.55);
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text-primary);
      position: relative;
      overflow: hidden;
    }
    
    .status::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 0 3px rgba(22,199,132,0.16);
      animation: pulse 2s ease-in-out infinite;
      position: relative;
      z-index: 1;
    }
    
    .status::after {
      content: "";
      position: absolute;
      inset: 0;
      width: var(--pct, 0%);
      background: linear-gradient(90deg, rgba(111,183,255,0.22), rgba(22,199,132,0.22));
      opacity: 0;
      transition: width 250ms ease, opacity 200ms ease;
      z-index: 0;
    }
    
    .status[data-has-pct="1"]::after {
      opacity: 1;
    }
    
    #statusText {
      position: relative;
      z-index: 1;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.55; transform: scale(0.92); }
    }

    /* Stats Badges */
    .stats-badges {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    
    .stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 750;
      border: 1px solid;
      white-space: nowrap;
    }
    
    .stat-badge.valid {
      background: rgba(22,199,132,0.16);
      color: rgba(22,199,132,1);
      border-color: rgba(22,199,132,0.35);
    }
    
    .stat-badge.invalid {
      background: rgba(255,91,107,0.16);
      color: rgba(255,91,107,1);
      border-color: rgba(255,91,107,0.35);
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(6,10,18,0.40);
      margin-top: 6px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 900px;
      color: var(--text-primary);
    }
    
    thead {
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    th {
      padding: 8px 10px;
      text-align: left;
      font-weight: 800;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      color: rgba(245,248,255,0.82);
      border-bottom: 1px solid rgba(255,255,255,0.10);
      white-space: nowrap;
    }
    
    td {
      padding: 7px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      vertical-align: middle;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr.valid {
      background: rgba(22,199,132,0.09);
    }
    
    tr.invalid {
      background: rgba(255,91,107,0.09);
    }
    
    tr:hover {
      background: rgba(255,255,255,0.04);
    }

    .override-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    
    .override-wrap select {
      width: auto;
      min-width: 140px;
      padding: 8px 10px;
      font-size: 13px;
    }
    
    .override-wrap.dirty::after {
      content: 'â—';
      color: var(--warning);
      font-size: 14px;
      position: absolute;
      right: -14px;
      top: 50%;
      transform: translateY(-50%);
      animation: pulse 1.5s ease-in-out infinite;
    }

    .reason-cell {
      max-width: 360px;
      min-width: 220px;
    }

    /* Log */
    .logbox {
      height: 180px;
      overflow: auto;
      background: rgba(5,7,12,0.78);
      color: rgba(22,199,132,0.95);
      font-family: var(--mono);
      font-size: 11px;
      line-height: 1.3;
      padding: 10px;
      border-radius: 10px;
      white-space: pre;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }

    /* Utility */
    .hint {
      font-size: 11px;
      color: rgba(245,248,255,0.55);
      text-align: center;
      padding: 8px 6px;
      border-radius: 10px;
      border: 1px dashed rgba(255,255,255,0.14);
      background: rgba(6,10,18,0.35);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 850;
      font-size: 11px;
      margin: 10px 0 6px;
      color: rgba(245,248,255,0.86);
      text-transform: uppercase;
      letter-spacing: 0.10em;
    }

    .mb-1 { margin-bottom: 6px; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 9999;
      overflow-y: auto;
      backdrop-filter: blur(8px);
    }
    
    .modal-content {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }
    
    .modal h4 {
      color: var(--accent);
      margin-top: 24px;
      font-size: 16px;
    }
    
    .modal h4:first-of-type {
      margin-top: 0;
    }
    
    .modal p, .modal ul, .modal ol {
      line-height: 1.8;
      font-size: 14px;
    }
    
    .modal ul, .modal ol {
      padding-left: 20px;
    }
    
    .modal a {
      color: var(--accent);
    }

    /* Footer */
    .app-footer {
      max-width: 1600px;
      margin: 16px auto 22px;
      padding: 0 16px;
    }
    
    .footer-inner {
      padding: 12px 14px;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
      box-shadow: var(--shadow-sm);
      text-align: center;
      color: rgba(245,248,255,0.55);
      font-size: 12px;
    }
    
    .app-footer a {
      color: rgba(170,205,255,0.95);
      font-weight: 850;
      text-decoration: none;
    }
    
    .app-footer a:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 1400px) {
      .wrap > div:first-child {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    @media (max-width: 1024px) {
      .wrap > div:first-child {
        grid-template-columns: 1fr !important;
      }
    }

    @media (max-width: 640px) {
      .btn-row, .system-actions {
        grid-template-columns: 1fr;
      }
      
      table {
        min-width: 860px;
      }
      
      .header-buttons {
        flex-wrap: wrap;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div style="flex: 1;">
        <h1>âš“ ATGSD Sea Pay Processor</h1>
        <div class="subtitle">Automated Sea Duty Certification & PG-13 Generation System</div>
      </div>
      <div class="header-buttons">
        <a href="https://github.com/night-owl-018/stg1_nivera_atgsd-sea-pay-processor/tree/main" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="header-btn" 
           title="View source code on GitHub">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
          </svg>
          GitHub
        </a>
        <button onclick="showModal('aboutModal')" class="header-btn">â„¹ï¸ About</button>
        <button onclick="showModal('helpModal')" class="header-btn">ğŸ“– Help</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- First Row: Input, System, Downloads, Custom -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
      
      <!-- INPUT FILES -->
      <div class="card">
        <h3>ğŸ“‚ Files</h3>
        <div class="body">
          <label>Sea Duty PDFs *</label>
          <input id="pdfs" type="file" accept="application/pdf" multiple required class="mb-1">

          <label>Rate CSV</label>
          <input id="ratesCsv" type="file" accept=".csv" class="mb-1">

          <label>Template PDF</label>
          <input id="templatePdf" type="file" accept="application/pdf">
        </div>
      </div>

      <!-- SYSTEM CONTROLS -->
      <div class="card">
        <h3>âš™ï¸ Controls</h3>
        <div class="body">
          <label>Status</label>
          <div class="status" id="statusText">Idle</div>

          <div style="height:6px;"></div>

          <label>Strikeout</label>
          <select id="strikeColor">
            <option value="Black" selected>âš« Black</option>
            <option value="Red">ğŸ”´ Red</option>
          </select>

          <div style="height:6px;"></div>

          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; font-size: 11px;">
            <input type="checkbox" id="consolidatePG13">
            <span>Consolidate PG-13s</span>
          </label>
          
          <div style="height:8px;"></div>
          
          <label>Action</label>
          <select id="actionSelect" style="margin-bottom: 6px;">
            <option value="">Select action</option>
            <option value="process">â–¶ï¸ Process Files</option>
            <option value="cancel" disabled id="cancelOption">â¹ï¸ Cancel Processing</option>
            <option value="reset">ğŸ—‘ï¸ Reset All Data</option>
          </select>
          
          <button type="button" id="actionGoBtn" class="btn-primary" disabled style="width: 100%;">
            âš¡ Go
          </button>
        </div>
      </div>

      <!-- TOOLS -->
      <div class="card">
        <h3>ğŸ”§ Tools</h3>
        <div class="body">
          <button class="btn-primary" type="button" onclick="showModal('reviewModal')" style="width: 100%;">âœï¸ Review & Override</button>
          <button class="btn-primary" type="button" onclick="showModal('logModal')" style="width: 100%; margin-top: 6px;">ğŸ“œ Processing Log</button>
        </div>
      </div>

      <!-- QUICK DOWNLOADS -->
      <div class="card">
        <h3>ğŸ“¥ Downloads</h3>
        <div class="body">
          <button class="btn-secondary" type="button" id="downloadMergedBtn" style="width: 100%;">ğŸ“¦ Package</button>
          <button class="btn-secondary" type="button" id="downloadAllBtn" style="width: 100%; margin-top: 6px;">ğŸ“‚ All Files</button>
          <button class="btn-primary" type="button" onclick="showModal('customModal')" style="width: 100%; margin-top: 6px;">ğŸ¯ Custom</button>
          
          <div style="height: 8px; border-top: 1px dashed rgba(255,255,255,0.1); margin: 8px 0;"></div>
          
          <label>Member</label>
          <select id="memberSelect" class="mb-1">
            <option value="">Select member</option>
          </select>

          <label>Sheet</label>
          <select id="sheetSelect" disabled class="mb-1">
            <option value="">Select sheet</option>
          </select>
          
          <div style="height: 8px;"></div>
          
          <label>Download Type</label>
          <select id="memberFileTypeSelect" disabled class="mb-1">
            <option value="">Select file type</option>
            <option value="summary">ğŸ“„ Summary</option>
            <option value="toris">ğŸ“‹ TORIS Cert</option>
            <option value="pg13">ğŸ“‘ PG-13 Forms</option>
            <option value="all">ğŸ“¦ All Files</option>
          </select>
          
          <button class="btn-success" type="button" id="downloadMemberFileBtn" disabled style="width: 100%; margin-top: 6px;">
            ğŸ“¥ Download Selected
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ABOUT MODAL -->
  <div id="aboutModal" class="modal">
    <div class="modal-content">
      <div class="card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <span>â„¹ï¸ About ATGSD Sea Pay Processor</span>
          <button onclick="hideModal('aboutModal')" class="btn-danger" style="width: auto; padding: 8px 16px;">âœ• Close</button>
        </h3>
        <div class="body" style="max-height: 70vh; overflow-y: auto;">
          <h4>Mission Statement</h4>
          <p>The ATGSD Sea Pay Processor streamlines and automates the validation of sea duty certifications and generation of official PG-13 payment authorization forms for United States Navy personnel.</p>

          <h4>ğŸ¯ Core Purpose</h4>
          <ul>
            <li>Extract and validate sea duty events from certification documents</li>
            <li>Automatically identify valid and invalid pay periods</li>
            <li>Generate properly formatted PG-13 payment authorization forms</li>
            <li>Create annotated TORIS certifications with clear visual indicators</li>
            <li>Produce comprehensive summary reports for personnel records</li>
          </ul>

          <h4>âš™ï¸ Technical Capabilities</h4>
          <ul>
            <li><strong>Intelligent OCR:</strong> Extracts text from scanned PDFs with high accuracy</li>
            <li><strong>Event Validation:</strong> Validates events against Navy regulations</li>
            <li><strong>Ship Name Normalization:</strong> Standardizes ship names using official databases</li>
            <li><strong>Duplicate Detection:</strong> Identifies duplicate entries to prevent overpayment</li>
            <li><strong>Manual Override System:</strong> Allows authorized review with audit trails</li>
            <li><strong>Batch Processing:</strong> Handles multiple certifications simultaneously</li>
          </ul>

          <h4>ğŸ“Š Output Products</h4>
          <ul>
            <li><strong>Summary Reports:</strong> Text summaries showing valid/invalid periods</li>
            <li><strong>TORIS Certifications:</strong> Annotated originals with invalid entries marked</li>
            <li><strong>PG-13 Forms:</strong> Official payment authorization forms</li>
            <li><strong>Merged Packages:</strong> Complete document sets with PDF bookmarks</li>
          </ul>

          <h4>ğŸ‘¨â€ğŸ’» Developer Information</h4>
          <p>
            <strong>Developed by:</strong> STG1(SW) Ryan Nivera, USN<br>
            <strong>Command:</strong> Afloat Training Group San Diego (ATGSD)<br>
            <strong>Contact:</strong> <a href="/cdn-cgi/l/email-protection#611318000f4f0f4f0f08170413004f0c080d2114124f0f0017184f0c080d"><span class="__cf_email__" data-cfemail="d5a7acb4bbfbbbfbbbbca3b0a7b4fbb8bcb995a0a6fbbbb4a3acfbb8bcb9">[email&#160;protected]</span></a>
          </p>

          <h4>âš ï¸ Disclaimer</h4>
          <p style="color: rgba(245,248,255,0.78); font-style: italic;">
            This tool assists with sea pay processing but does not replace official Navy regulations or qualified personnel judgment. All outputs should be reviewed before submission. This is an unofficial tool not endorsed by the Department of the Navy or Department of Defense.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- HELP MODAL -->
  <div id="helpModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
      <div class="card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ“– Complete User Guide</span>
          <button onclick="hideModal('helpModal')" class="btn-danger" style="width: auto; padding: 8px 16px;">âœ• Close</button>
        </h3>
        <div class="body" style="max-height: 75vh; overflow-y: auto;">
          
          <!-- Quick Start Guide -->
          <div style="background: rgba(111,183,255,0.1); padding: 16px; border-radius: 10px; border-left: 4px solid var(--accent); margin-bottom: 24px;">
            <h4 style="margin: 0 0 12px 0; color: var(--accent); font-size: 16px;">ğŸš€ Quick Start (First Time Users)</h4>
            <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
              <li><strong>Upload</strong> your Sea Duty Certification PDF(s) in the <strong>ğŸ“‚ Files</strong> section</li>
              <li>Click the <strong>â–¶ï¸ Process</strong> button in the <strong>âš™ï¸ Controls</strong> section</li>
              <li>Wait for processing to complete (watch the status indicator)</li>
              <li>Download your processed files from the <strong>ğŸ“¥ Downloads</strong> section</li>
            </ol>
          </div>

          <p style="text-align: center; font-size: 14px; color: rgba(245,248,255,0.7); margin-bottom: 24px;">
            <em>Scroll down for detailed instructions, troubleshooting, and FAQ</em>
          </p>

          <!-- Main Interface Overview -->
          <h4 style="color: var(--accent); margin-top: 0;">ğŸ–¥ï¸ Main Interface Overview</h4>
          
          <div style="display: grid; gap: 12px; margin-bottom: 24px;">
            
            <!-- Files Section -->
            <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid #6fb7ff;">
              <div style="font-weight: 700; margin-bottom: 8px; color: #6fb7ff;">ğŸ“‚ Files - Upload Your Documents</div>
              <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 14px;">
                <li><strong>Sea Duty PDFs</strong> (Required) - Upload one or more certification PDFs</li>
                <li><strong>Rate CSV & Template PDF</strong> (Optional) - Custom files for advanced users</li>
              </ul>
            </div>

            <!-- Controls Section -->
            <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid #16c784;">
              <div style="font-weight: 700; margin-bottom: 8px; color: #16c784;">âš™ï¸ Controls - Process & Manage</div>
              <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 14px;">
                <li><strong>â–¶ï¸ Process</strong> - Start processing your files</li>
                <li><strong>â¹ï¸ Cancel</strong> - Stop processing if needed</li>
                <li><strong>ğŸ—‘ï¸ Reset</strong> - Clear everything and start over</li>
                <li><strong>Settings</strong> - Choose strikeout color and consolidation options</li>
              </ul>
            </div>

            <!-- Tools Section -->
            <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid #f5c451;">
              <div style="font-weight: 700; margin-bottom: 8px; color: #f5c451;">ğŸ”§ Tools - Review & Monitor</div>
              <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 14px;">
                <li><strong>âœï¸ Review & Override</strong> - Check and correct validation results</li>
                <li><strong>ğŸ“œ Processing Log</strong> - See detailed processing information</li>
              </ul>
            </div>

            <!-- Downloads Section -->
            <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid #ff5b6b;">
              <div style="font-weight: 700; margin-bottom: 8px; color: #ff5b6b;">ğŸ“¥ Downloads - Get Your Files</div>
              <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 14px;">
                <li><strong>ğŸ“¦ Package / ğŸ“‚ All Files</strong> - Download everything at once</li>
                <li><strong>ğŸ¯ Custom</strong> - Create custom packages with selected files</li>
                <li><strong>Per-Member Downloads</strong> - Get specific files for each person</li>
              </ul>
            </div>
          </div>

          <!-- Common Questions -->
          <h4 style="color: var(--accent);">â“ Frequently Asked Questions</h4>
          
          <div style="margin-bottom: 24px;">
            <div style="margin-bottom: 14px;">
              <div style="font-weight: 700; margin-bottom: 6px; font-size: 14px;">Q: How do I get started?</div>
              <p style="margin: 0; padding-left: 16px; font-size: 13px; line-height: 1.6; color: rgba(245,248,255,0.85);">
                A: Click "Choose Files" in the Files section, select your PDF(s), then click the "â–¶ï¸ Process" button. That's it!
              </p>
            </div>
            
            <div style="margin-bottom: 14px;">
              <div style="font-weight: 700; margin-bottom: 6px; font-size: 14px;">Q: Can I process multiple people at once?</div>
              <p style="margin: 0; padding-left: 16px; font-size: 13px; line-height: 1.6; color: rgba(245,248,255,0.85);">
                A: Yes! Upload all PDFs at once. The system creates separate outputs for each person automatically.
              </p>
            </div>
            
            <div style="margin-bottom: 14px;">
              <div style="font-weight: 700; margin-bottom: 6px; font-size: 14px;">Q: What if something is marked invalid but shouldn't be?</div>
              <p style="margin: 0; padding-left: 16px; font-size: 13px; line-height: 1.6; color: rgba(245,248,255,0.85);">
                A: Use the "Review & Override" tool. Select the member and sheet, find the event, change it to "Valid", add a reason, then save and rebuild.
              </p>
            </div>
            
            <div style="margin-bottom: 14px;">
              <div style="font-weight: 700; margin-bottom: 6px; font-size: 14px;">Q: What does "Consolidate PG-13s" do?</div>
              <p style="margin: 0; padding-left: 16px; font-size: 13px; line-height: 1.6; color: rgba(245,248,255,0.85);">
                A: It combines multiple periods on the same ship into one PG-13 form, saving paper. Great for sailors with lots of time on one ship.
              </p>
            </div>
            
            <div style="margin-bottom: 14px;">
              <div style="font-weight: 700; margin-bottom: 6px; font-size: 14px;">Q: What files will I get?</div>
              <p style="margin: 0; padding-left: 16px; font-size: 13px; line-height: 1.6; color: rgba(245,248,255,0.85);">
                A: You'll get a Summary (text report), TORIS Cert (marked-up certification), and PG-13 Forms (payment forms) for each member.
              </p>
            </div>
            
            <div style="margin-bottom: 14px;">
              <div style="font-weight: 700; margin-bottom: 6px; font-size: 14px;">Q: How long does processing take?</div>
              <p style="margin: 0; padding-left: 16px; font-size: 13px; line-height: 1.6; color: rgba(245,248,255,0.85);">
                A: Usually 1-3 minutes per certification. Large PDFs or multiple files take longer. Watch the progress percentage.
              </p>
            </div>

            <div style="margin-bottom: 14px;">
              <div style="font-weight: 700; margin-bottom: 6px; font-size: 14px;">Q: Can I undo a Reset?</div>
              <p style="margin: 0; padding-left: 16px; font-size: 13px; line-height: 1.6; color: rgba(245,248,255,0.85);">
                A: No! Reset permanently deletes everything. Always download your files first.
              </p>
            </div>
          </div>

          <!-- Quick Troubleshooting -->
          <h4 style="color: var(--accent);">ğŸ”§ Quick Troubleshooting</h4>
          
          <div style="display: grid; gap: 8px; margin-bottom: 24px;">
            <div style="padding: 10px; background: rgba(255,91,107,0.08); border-radius: 6px; border-left: 3px solid #ff5b6b;">
              <strong style="font-size: 13px;">Problem:</strong> <span style="font-size: 13px;">Files won't upload</span><br>
              <span style="font-size: 12px; color: rgba(245,248,255,0.75);">â†’ Check: PDF format? File size reasonable? Good internet connection?</span>
            </div>
            
            <div style="padding: 10px; background: rgba(255,91,107,0.08); border-radius: 6px; border-left: 3px solid #ff5b6b;">
              <strong style="font-size: 13px;">Problem:</strong> <span style="font-size: 13px;">Processing stuck</span><br>
              <span style="font-size: 12px; color: rgba(245,248,255,0.75);">â†’ Check the Processing Log. Wait 5 min. If still stuck, click Cancel and try again.</span>
            </div>
            
            <div style="padding: 10px; background: rgba(255,91,107,0.08); border-radius: 6px; border-left: 3px solid #ff5b6b;">
              <strong style="font-size: 13px;">Problem:</strong> <span style="font-size: 13px;">Missing events</span><br>
              <span style="font-size: 12px; color: rgba(245,248,255,0.75);">â†’ Check if they're marked invalid. Use Review & Override to manually add them.</span>
            </div>
            
            <div style="padding: 10px; background: rgba(255,91,107,0.08); border-radius: 6px; border-left: 3px solid #ff5b6b;">
              <strong style="font-size: 13px;">Problem:</strong> <span style="font-size: 13px;">Download not working</span><br>
              <span style="font-size: 12px; color: rgba(245,248,255,0.75);">â†’ Make sure processing is complete. For member downloads, select a member first.</span>
            </div>
          </div>

          <!-- Best Practices -->
          <h4 style="color: var(--accent);">ğŸ’¡ Tips for Best Results</h4>
          <ul style="line-height: 1.7; padding-left: 20px; margin-bottom: 24px; font-size: 14px;">
            <li>Use clear, high-quality PDF scans for better accuracy</li>
            <li>Always review outputs before submitting for official use</li>
            <li>Add reasons when you override - helps with audits later</li>
            <li>Download all files before clicking Reset</li>
            <li>Process 5-10 certs at a time for efficiency</li>
            <li>Keep backup copies of original PDFs</li>
          </ul>

          <!-- Support Information -->
          <h4 style="color: var(--accent);">ğŸ“ Need More Help?</h4>
          <div style="background: rgba(111,183,255,0.1); padding: 16px; border-radius: 10px; border-left: 4px solid var(--accent);">
            <p style="margin: 0 0 10px 0; line-height: 1.6; font-size: 14px;">
              For questions, technical issues, or feature requests:
            </p>
            <div style="line-height: 1.7; font-size: 14px;">
              <strong>Contact:</strong> STG1(SW) Ryan Nivera, USN<br>
              <strong>Email:</strong> <a href="/cdn-cgi/l/email-protection#c7b5bea6a9e9a9e9a9aeb1a2b5a6e9aaaeab87b2b4e9a9a6b1bee9aaaeab" style="color: var(--accent);"><span class="__cf_email__" data-cfemail="b0c2c9d1de9ede9eded9c6d5c2d19eddd9dcf0c5c39eded1c6c99eddd9dc">[email&#160;protected]</span></a><br>
              <strong>Command:</strong> ATGSD (Afloat Training Group San Diego)
            </div>
            <p style="margin: 10px 0 0 0; font-size: 12px; opacity: 0.75;">
              ğŸ’¡ Tip: Include screenshots and log output when reporting issues
            </p>
          </div>

          <!-- Disclaimer -->
          <div style="margin-top: 20px; padding: 12px; background: rgba(245,196,81,0.1); border-radius: 8px; font-size: 12px; line-height: 1.6; border-left: 3px solid #f5c451;">
            <strong>âš ï¸ Disclaimer:</strong> This tool assists with processing but doesn't replace official Navy regulations or qualified personnel judgment. Always have authorized personnel review outputs before submission to disbursing/DFAS. Not officially endorsed by DON/DOD.
          </div>

        </div>
      </div>
    </div>
  </div>
  <!-- CUSTOM DOWNLOAD MODAL -->
  <div id="customModal" class="modal">
    <div class="modal-content">
      <div class="card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ¯ Custom Download & Merge</span>
          <button onclick="hideModal('customModal')" class="btn-danger" style="width: auto; padding: 8px 16px;">âœ• Close</button>
        </h3>
        <div class="body">
          <div style="font-size: 12px; color: rgba(245,248,255,0.72); margin-bottom: 10px;">
            Select members and file types to download or merge into a package:
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
            <button class="btn-secondary" type="button" id="selectAllBtn">â˜‘ Select All</button>
            <button class="btn-secondary" type="button" id="deselectAllBtn">â˜ Deselect All</button>
          </div>
          
          <div id="memberSelectionList" style="max-height: 400px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; background: rgba(6,10,18,0.35); margin-bottom: 12px;">
            <div style="text-align: center; color: rgba(245,248,255,0.55); padding: 20px; font-size: 12px;">
              Process files first to see member list
            </div>
          </div>
          
          <div id="selectionSummary" style="padding: 10px; background: rgba(111,183,255,0.1); border-radius: 10px; font-size: 13px; text-align: center; color: rgba(245,248,255,0.82); margin-bottom: 12px;">
            Selection: <span id="selectedCount">0 members, 0 items</span>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button class="btn-success" type="button" id="downloadCustomBtn" disabled>ğŸ“¥ Download ZIP</button>
            <button class="btn-primary" type="button" id="mergeCustomBtn" disabled>ğŸ“¦ Merge to PDF</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- REVIEW & OVERRIDE MODAL -->
  <div id="reviewModal" class="modal">
    <div class="modal-content" id="reviewModalContent" style="max-width: 1400px; transition: all 0.3s ease;">
      <div class="card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span>âœï¸ Review & Override</span>
            <div class="stats-badges">
              <div class="stat-badge valid">
                <span>âœ…</span>
                <span class="count" id="validCountModal">0</span>
              </div>
              <div class="stat-badge invalid">
                <span>âŒ</span>
                <span class="count" id="invalidCountModal">0</span>
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button onclick="toggleMaximizeModal('reviewModal')" class="btn-secondary" style="width: auto; padding: 6px 12px; font-size: 12px;" title="Maximize/Restore">
              <span id="reviewModalMaximizeIcon">â›¶</span>
            </button>
            <button onclick="hideModal('reviewModal')" class="btn-danger" style="width: auto; padding: 8px 16px;">âœ• Close</button>
          </div>
        </h3>
        <div class="body" id="reviewModalBody" style="max-height: 65vh; overflow-y: auto; transition: max-height 0.3s ease;">
          <div class="hint" id="reviewHint">
            ğŸ‘† Select a member and sheet in the main page to review validation results
          </div>

          <div class="section-header">âœ… Valid Rows</div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Ship</th>
                  <th>Event</th>
                  <th>Status</th>
                  <th>Override</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody id="validBody"></tbody>
            </table>
          </div>

          <div class="section-header">âŒ Invalid Events</div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Ship</th>
                  <th>Event</th>
                  <th>Status</th>
                  <th>Override</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody id="invalidBody"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Action Buttons Footer -->
        <div style="padding: 12px; border-top: 1px solid rgba(255,255,255,0.1); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.05)); display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button type="button" id="saveOverridesBtn" class="btn-success">ğŸ’¾ Save Overrides</button>
          <button type="button" id="rebuildBtn" class="btn-primary">ğŸ”„ Rebuild Outputs</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PROCESSING LOG MODAL -->
  <div id="logModal" class="modal">
    <div class="modal-content" id="logModalContent" style="max-width: 1200px; transition: all 0.3s ease;">
      <div class="card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ“œ Live Processing Log</span>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button onclick="toggleMaximizeModal('logModal')" class="btn-secondary" style="width: auto; padding: 6px 12px; font-size: 12px;" title="Maximize/Restore">
              <span id="logModalMaximizeIcon">â›¶</span>
            </button>
            <button onclick="hideModal('logModal')" class="btn-danger" style="width: auto; padding: 8px 16px;">âœ• Close</button>
          </div>
        </h3>
        <div class="body" id="logModalBody" style="transition: height 0.3s ease;">
          <div id="liveLog" class="logbox" style="height: 500px;"></div>
        </div>
      </div>
    </div>
  </div>

  <footer class="app-footer">
    <div class="footer-inner">
      Developed by <a href="/cdn-cgi/l/email-protection#ea98938b84c484c484839c8f988bc4878386aa9f99c4848b9c93c4878386">STG1(SW) Ryan Nivera</a> Â© <span id="yearNow">2025</span>
    </div>
  </footer>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // Utility functions - Global scope for onclick attributes
    const $ = id => document.getElementById(id);
    
    // Modal functions with error handling - Defined immediately for onclick
    window.showModal = function(modalId) {
      const modal = $(modalId);
      if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      } else {
        console.error('Modal not found:', modalId);
        alert('Error: Modal "' + modalId + '" not found. Please refresh the page.');
      }
    };
    
    window.hideModal = function(modalId) {
      const modal = $(modalId);
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      } else {
        console.error('Modal not found:', modalId);
      }
    };
    
    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
        document.body.style.overflow = '';
      }
    });

    // Toggle maximize/fullscreen for modals
    window.toggleMaximizeModal = function(modalId) {
      const modal = $(modalId);
      const content = $(modalId + 'Content');
      const body = $(modalId + 'Body');
      const icon = $(modalId + 'MaximizeIcon');
      
      if (!modal || !content) {
        console.error('Modal elements not found for:', modalId);
        return;
      }
      
      // Check if currently maximized
      const isMaximized = content.getAttribute('data-maximized') === 'true';
      
      if (isMaximized) {
        // Restore to normal
        content.style.maxWidth = modalId === 'reviewModal' ? '1400px' : '1200px';
        content.style.width = '';
        content.style.height = '';
        content.style.margin = '40px auto';
        
        if (body) {
          if (modalId === 'reviewModal') {
            body.style.maxHeight = '65vh';
          } else if (modalId === 'logModal') {
            const logBox = $('liveLog');
            if (logBox) logBox.style.height = '500px';
          }
        }
        
        if (icon) icon.textContent = 'â›¶';
        content.setAttribute('data-maximized', 'false');
      } else {
        // Maximize to fullscreen
        content.style.maxWidth = 'none';
        content.style.width = 'calc(100vw - 40px)';
        content.style.height = 'calc(100vh - 40px)';
        content.style.margin = '20px';
        
        if (body) {
          if (modalId === 'reviewModal') {
            body.style.maxHeight = 'calc(100vh - 220px)';
          } else if (modalId === 'logModal') {
            const logBox = $('liveLog');
            if (logBox) logBox.style.height = 'calc(100vh - 200px)';
          }
        }
        
        if (icon) icon.textContent = 'ğŸ——';
        content.setAttribute('data-maximized', 'true');
      }
    };

    // ESC key to close modals
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
          if (modal.style.display === 'block') {
            modal.style.display = 'none';
            document.body.style.overflow = '';
            
            // Reset maximize state
            const modalId = modal.id;
            const content = $(modalId + 'Content');
            if (content && content.getAttribute('data-maximized') === 'true') {
              toggleMaximizeModal(modalId);
            }
          }
        });
      }
    });

    // State
    let pendingOverrides = {};
    let customSelections = {};
    let currentMember = '';
    let currentSheet = '';

    // API helpers
    async function apiGet(url) {
      const res = await fetch(url, {cache: 'no-store'});
      if (!res.ok) throw new Error(`GET ${url} failed: ${res.status}`);
      return res.json();
    }

    async function apiPost(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`POST ${url} failed: ${res.status} ${text}`);
      }
      return res.json();
    }

    // Status polling
    async function pollProgress() {
      try {
        const data = await apiGet('/progress');
        const status = data.status || data.state || data.message || 'Idle';
        const pct = data.percent || data.progress || data.pct;
        const log = data.log || data.lines || data.text || '';

        // Update status
        const statusEl = $('statusText');
        if (pct != null && pct !== '') {
          const p = Math.max(0, Math.min(100, Number(pct)));
          statusEl.textContent = `${status} (${p}%)`;
          statusEl.style.setProperty('--pct', `${p}%`);
          statusEl.setAttribute('data-has-pct', '1');
        } else {
          statusEl.textContent = status;
          statusEl.style.setProperty('--pct', '0%');
          statusEl.removeAttribute('data-has-pct');
        }

        // Update action dropdown cancel option based on processing status
        const statusUpper = status.toUpperCase();
        const isProcessing = !['IDLE', 'COMPLETE', 'CANCELLED', 'CANCELLING'].includes(statusUpper);
        const cancelOption = $('cancelOption');
        if (cancelOption) {
          cancelOption.disabled = !isProcessing;
        }

        // Update log
        if (log) {
          const logEl = $('liveLog');
          const atBottom = logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight < 20;
          logEl.textContent = log;
          if (atBottom) logEl.scrollTop = logEl.scrollHeight;
        }

        // Refresh on complete
        if (status === 'COMPLETE') {
          await refreshMembers();
        }
      } catch (e) {
        console.error('Poll error:', e);
      }
    }

    setInterval(pollProgress, 1000);
    pollProgress();

    // Action dropdown change handler
    $('actionSelect').addEventListener('change', function() {
      const hasSelection = this.value !== '';
      $('actionGoBtn').disabled = !hasSelection;
      
      // Update button appearance based on selection
      const btn = $('actionGoBtn');
      if (this.value === 'process') {
        btn.className = 'btn-primary';
        btn.textContent = 'âš¡ Go';
      } else if (this.value === 'cancel') {
        btn.className = 'btn-danger';
        btn.textContent = 'âš¡ Go';
      } else if (this.value === 'reset') {
        btn.className = 'btn-danger';
        btn.textContent = 'âš¡ Go';
      }
    });
    
    // Action Go button handler
    $('actionGoBtn').addEventListener('click', async () => {
      const action = $('actionSelect').value;
      
      if (action === 'process') {
        // Process files
        const fd = new FormData();
        for (const f of $('pdfs').files) fd.append('pdfs', f);
        if ($('ratesCsv').files[0]) fd.append('rates_csv', $('ratesCsv').files[0]);
        if ($('templatePdf').files[0]) fd.append('template_pdf', $('templatePdf').files[0]);
        fd.append('strikeout_color', $('strikeColor').value);
        fd.append('consolidate_pg13', $('consolidatePG13').checked ? 'true' : 'false');

        $('actionGoBtn').disabled = true;
        try {
          const res = await fetch('/process', {method: 'POST', body: fd});
          if (!res.ok) throw new Error(`Process failed: ${res.status}`);
          // Reset dropdown after successful process
          $('actionSelect').value = '';
        } catch (err) {
          alert(err.message);
        } finally {
          $('actionGoBtn').disabled = false;
        }
      } else if (action === 'cancel') {
        // Cancel processing
        $('actionGoBtn').disabled = true;
        try {
          const res = await fetch('/cancel_process', {method: 'POST'});
          if (res.ok) {
            alert('âœ… Processing cancelled');
            $('actionSelect').value = '';
          } else {
            throw new Error(`Cancel failed: ${res.status}`);
          }
        } catch (err) {
          alert(`âŒ ${err.message}`);
        } finally {
          $('actionGoBtn').disabled = false;
        }
      } else if (action === 'reset') {
        // Reset all data
        if (!confirm('âš ï¸ Reset all data? This cannot be undone.')) return;
        try {
          const res = await fetch('/reset', {method: 'POST'});
          if (!res.ok) throw new Error(`Reset failed: ${res.status}`);
          
          $('pdfs').value = '';
          $('ratesCsv').value = '';
          $('templatePdf').value = '';
          $('memberSelect').innerHTML = '<option value="">Select member</option>';
          $('sheetSelect').innerHTML = '<option value="">Select sheet</option>';
          $('sheetSelect').disabled = true;
          
          // Reset member file type dropdown and button
          $('memberFileTypeSelect').value = '';
          $('memberFileTypeSelect').disabled = true;
          $('downloadMemberFileBtn').disabled = true;
          
          $('validBody').innerHTML = '';
          $('invalidBody').innerHTML = '';
          
          // Reset both main and modal counts
          if ($('validCount')) $('validCount').textContent = '0';
          if ($('invalidCount')) $('invalidCount').textContent = '0';
          if ($('validCountModal')) $('validCountModal').textContent = '0';
          if ($('invalidCountModal')) $('invalidCountModal').textContent = '0';
          
          $('reviewHint').textContent = 'ğŸ‘† Select a member and sheet in the main page to review validation results';
          pendingOverrides = {};
          customSelections = {};
          renderMemberList();
          
          // Reset action dropdown
          $('actionSelect').value = '';
          $('actionGoBtn').disabled = true;
          
          alert('âœ… Reset complete');
        } catch (err) {
          alert(err.message);
        }
      }
    });

    // Downloads
    $('downloadMergedBtn').addEventListener('click', () => window.location = '/download_merged');
    $('downloadAllBtn').addEventListener('click', () => window.location = '/download_all');
    
    // Member file type selection handling
    $('memberFileTypeSelect').addEventListener('change', function() {
      const hasSelection = this.value !== '';
      $('downloadMemberFileBtn').disabled = !hasSelection || !currentMember;
    });
    
    // Download selected member file
    $('downloadMemberFileBtn').addEventListener('click', () => {
      const fileType = $('memberFileTypeSelect').value;
      if (!currentMember || !fileType) {
        alert('Please select a member and file type');
        return;
      }
      
      const urls = {
        summary: `/download_member_summary/${encodeURIComponent(currentMember)}`,
        toris: `/download_member_toris/${encodeURIComponent(currentMember)}`,
        pg13: `/download_member_pg13s/${encodeURIComponent(currentMember)}`,
        all: `/download_member/${encodeURIComponent(currentMember)}`
      };
      
      if (urls[fileType]) {
        window.location = urls[fileType];
      }
    });

    // Members
    async function refreshMembers() {
      try {
        const members = await apiGet('/api/members');
        const sel = $('memberSelect');
        const current = sel.value;
        sel.innerHTML = '<option value="">Select member</option>';
        
        customSelections = {};
        members.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m;
          opt.textContent = m;
          sel.appendChild(opt);
          customSelections[m] = {enabled: false, summary: false, toris: false, pg13: false};
        });
        
        if (current && members.includes(current)) sel.value = current;
        currentMember = sel.value;
        renderMemberList();
      } catch (e) {
        console.error('Refresh members error:', e);
      }
    }

    $('memberSelect').addEventListener('change', async e => {
      currentMember = e.target.value;
      pendingOverrides = {};
      await loadSheets();
    });

    async function loadSheets() {
      const hasSelection = !!currentMember;
      
      // Enable/disable member file type dropdown and download button
      $('memberFileTypeSelect').disabled = !hasSelection;
      $('downloadMemberFileBtn').disabled = !hasSelection || $('memberFileTypeSelect').value === '';
      
      // Reset file type selection when member changes
      if (!hasSelection) {
        $('memberFileTypeSelect').value = '';
      }
      
      $('sheetSelect').disabled = true;
      $('sheetSelect').innerHTML = '<option value="">Select sheet</option>';
      $('validBody').innerHTML = '';
      $('invalidBody').innerHTML = '';
      $('reviewHint').style.display = 'block';
      $('reviewHint').textContent = 'Select a sheet to review';
      
      // Reset both main and modal counts
      if ($('validCount')) $('validCount').textContent = '0';
      if ($('invalidCount')) $('invalidCount').textContent = '0';
      if ($('validCountModal')) $('validCountModal').textContent = '0';
      if ($('invalidCountModal')) $('invalidCountModal').textContent = '0';
      
      if (!currentMember) return;
      
      try {
        const sheets = await apiGet(`/api/member/${encodeURIComponent(currentMember)}/sheets`);
        const sel = $('sheetSelect');
        sheets.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          sel.appendChild(opt);
        });
        sel.disabled = false;
      } catch (e) {
        console.error('Load sheets error:', e);
      }
    }

    $('sheetSelect').addEventListener('change', async e => {
      currentSheet = e.target.value;
      pendingOverrides = {};
      if (currentSheet && currentMember) await loadEvents();
    });

    async function loadEvents() {
      $('validBody').innerHTML = '';
      $('invalidBody').innerHTML = '';
      $('reviewHint').textContent = 'Loading...';
      
      try {
        const data = await apiGet(`/api/member/${encodeURIComponent(currentMember)}/sheet/${encodeURIComponent(currentSheet)}`);
        const valid = data.valid_rows || [];
        const invalid = data.invalid_events || [];
        
        // Update both main and modal counts
        const validCount = valid.length;
        const invalidCount = invalid.length;
        if ($('validCount')) $('validCount').textContent = validCount;
        if ($('invalidCount')) $('invalidCount').textContent = invalidCount;
        if ($('validCountModal')) $('validCountModal').textContent = validCount;
        if ($('invalidCountModal')) $('invalidCountModal').textContent = invalidCount;
        
        if (valid.length === 0 && invalid.length === 0) {
          $('reviewHint').textContent = 'No events found';
          return;
        }
        
        $('reviewHint').style.display = 'none';
        
        valid.forEach(row => renderRow(row, $('validBody'), 'valid'));
        invalid.forEach(row => renderRow(row, $('invalidBody'), 'invalid'));
      } catch (e) {
        $('reviewHint').textContent = `Error: ${e.message}`;
        $('reviewHint').style.display = 'block';
      }
    }

    function renderRow(row, tbody, type) {
      const tr = document.createElement('tr');
      tr.className = type;
      
      tr.innerHTML = `
        <td>${row.date || ''}</td>
        <td>${row.ship || ''}</td>
        <td>${row.event || ''}</td>
        <td>${row.source === 'override' ? 'Override' : type === 'valid' ? 'Valid' : 'Invalid'}</td>
        <td></td>
        <td class="reason-cell"></td>
      `;
      
      const overrideStatus = row.override_status || (row.override && row.override.status) || '';
      const overrideReason = row.override_reason || (row.override && row.override.reason) || '';
      const statusReason = row.status_reason || row.reason || '';
      
      tr.children[4].appendChild(createOverrideSelect(row.event_index, overrideStatus, row.source));
      tr.children[5].appendChild(createReasonTextarea(row.event_index, statusReason, overrideReason));
      
      tbody.appendChild(tr);
    }

    function createOverrideSelect(index, status, source) {
      const wrap = document.createElement('div');
      wrap.className = 'override-wrap';
      if (source === 'override') wrap.classList.add('dirty');
      
      const sel = document.createElement('select');
      sel.innerHTML = `
        <option value="">ğŸ”„ Auto</option>
        <option value="valid">âœ… Valid</option>
        <option value="invalid">âŒ Invalid</option>
      `;
      sel.value = status || '';
      
      const key = `${currentMember}|||${currentSheet}|||${index}`;
      sel.addEventListener('change', () => {
        wrap.classList.add('dirty');
        const ta = document.querySelector(`textarea[data-key="${key}"]`);
        pendingOverrides[key] = {
          member_key: currentMember,
          sheet_file: currentSheet,
          event_index: index,
          override_status: sel.value || null,
          override_reason: ta ? ta.value : null
        };
      });
      
      wrap.appendChild(sel);
      return wrap;
    }

    function createReasonTextarea(index, initialText, overrideReason) {
      const ta = document.createElement('textarea');
      ta.className = 'override-reason';
      ta.value = overrideReason || initialText || '';
      ta.placeholder = 'Optional...';
      
      const key = `${currentMember}|||${currentSheet}|||${index}`;
      ta.setAttribute('data-key', key);
      
      ta.addEventListener('input', () => {
        const sel = document.querySelector(`select[data-key="${key}"]`) || 
                     ta.closest('tr').querySelector('select');
        const wrap = sel ? sel.closest('.override-wrap') : null;
        if (wrap) wrap.classList.add('dirty');
        
        pendingOverrides[key] = {
          member_key: currentMember,
          sheet_file: currentSheet,
          event_index: index,
          override_status: sel ? sel.value : null,
          override_reason: ta.value || null
        };
      });
      
      return ta;
    }

    // Save overrides
    $('saveOverridesBtn').addEventListener('click', async () => {
      const overrides = Object.values(pendingOverrides);
      if (overrides.length === 0) {
        alert('No changes to save');
        return;
      }
      
      const transformed = overrides.map(o => ({
        member_key: o.member_key,
        sheet_file: o.sheet_file,
        event_index: o.event_index,
        status: o.override_status || '',
        reason: o.override_reason || '',
        source: 'manual'
      }));
      
      $('saveOverridesBtn').disabled = true;
      try {
        await apiPost('/api/overrides/batch', transformed);
        alert(`âœ… Saved ${overrides.length} override(s)`);
        pendingOverrides = {};
        if (currentMember && currentSheet) await loadEvents();
      } catch (err) {
        alert(`Error: ${err.message}`);
      } finally {
        $('saveOverridesBtn').disabled = false;
      }
    });

    // Rebuild
    $('rebuildBtn').addEventListener('click', async () => {
      if (!confirm('ğŸ”„ Rebuild all outputs?')) return;
      
      $('rebuildBtn').disabled = true;
      try {
        const res = await apiPost('/rebuild_outputs', {
          consolidate_pg13: $('consolidatePG13').checked
        });
        alert('âœ… ' + (res.status || 'Rebuild complete'));
      } catch (err) {
        alert(`Error: ${err.message}`);
      } finally {
        setTimeout(() => $('rebuildBtn').disabled = false, 1000);
      }
    });

    // Custom selection
    // Custom selection toggle functions - Must be defined before renderMemberList
    window.toggleMember = function(member) {
      customSelections[member].enabled = !customSelections[member].enabled;
      
      // When enabling, auto-select all file types if none are selected
      if (customSelections[member].enabled) {
        if (!customSelections[member].summary && !customSelections[member].toris && !customSelections[member].pg13) {
          customSelections[member].summary = true;
          customSelections[member].toris = true;
          customSelections[member].pg13 = true;
        }
      }
      // When disabling, keep file type selections preserved
      
      renderMemberList();
    };

    window.toggleFileType = function(member, type) {
      customSelections[member][type] = !customSelections[member][type];
      
      // If all file types are unchecked, uncheck the member too
      const s = customSelections[member];
      if (!s.summary && !s.toris && !s.pg13) {
        s.enabled = false;
        renderMemberList(); // Re-render to update member checkbox
      } else {
        // If any file type is checked, ensure member is enabled
        if (!s.enabled) {
          s.enabled = true;
          renderMemberList(); // Re-render to update member checkbox
        } else {
          updateSelectionSummary(); // Just update counts, don't re-render
        }
      }
    };

    function updateSelectionSummary() {
      let memberCount = 0;
      let itemCount = 0;
      
      Object.keys(customSelections).forEach(member => {
        const s = customSelections[member];
        if (s.enabled) {
          memberCount++;
          if (s.summary) itemCount++;
          if (s.toris) itemCount++;
          if (s.pg13) itemCount++;
        }
      });
      
      $('selectedCount').textContent = `${memberCount} members, ${itemCount} items`;
      $('downloadCustomBtn').disabled = itemCount === 0;
      $('mergeCustomBtn').disabled = itemCount === 0;
    }

    function renderMemberList() {
      const container = $('memberSelectionList');
      
      if (Object.keys(customSelections).length === 0) {
        container.innerHTML = '<div style="text-align: center; color: rgba(245,248,255,0.55); padding: 20px; font-size: 12px;">Process files first to see member list</div>';
        return;
      }
      
      let html = '';
      Object.keys(customSelections).forEach(member => {
        const s = customSelections[member];
        html += `
          <div style="margin-bottom: 10px; padding: 10px; border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; background: rgba(20,28,48,0.4);">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; margin-bottom: 6px; font-size: 13px;">
              <input type="checkbox" onchange="toggleMember('${member}')" ${s.enabled ? 'checked' : ''}>
              <span>${member}</span>
            </label>
            <div style="padding-left: 30px; display: flex; gap: 12px; flex-wrap: wrap;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" onchange="toggleFileType('${member}', 'summary')" ${s.summary ? 'checked' : ''} ${!s.enabled ? 'disabled' : ''}>
                <span>ğŸ“„ Summary</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" onchange="toggleFileType('${member}', 'toris')" ${s.toris ? 'checked' : ''} ${!s.enabled ? 'disabled' : ''}>
                <span>ğŸ“‹ TORIS</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" onchange="toggleFileType('${member}', 'pg13')" ${s.pg13 ? 'checked' : ''} ${!s.enabled ? 'disabled' : ''}>
                <span>ğŸ“‘ PG-13</span>
              </label>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      updateSelectionSummary();
    }

    $('selectAllBtn').addEventListener('click', () => {
      Object.keys(customSelections).forEach(member => {
        customSelections[member].enabled = true;
        customSelections[member].summary = true;
        customSelections[member].toris = true;
        customSelections[member].pg13 = true;
      });
      renderMemberList();
    });

    $('deselectAllBtn').addEventListener('click', () => {
      Object.keys(customSelections).forEach(member => {
        customSelections[member].enabled = false;
        customSelections[member].summary = false;
        customSelections[member].toris = false;
        customSelections[member].pg13 = false;
      });
      renderMemberList();
    });

    $('downloadCustomBtn').addEventListener('click', async () => {
      const selections = {};
      Object.keys(customSelections).forEach(member => {
        const s = customSelections[member];
        if (s.enabled) {
          selections[member] = {summary: s.summary, toris: s.toris, pg13: s.pg13};
        }
      });
      
      $('downloadCustomBtn').disabled = true;
      $('downloadCustomBtn').textContent = 'ğŸ“¥ Downloading...';
      
      try {
        const res = await fetch('/download_custom', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'download', selections})
        });
        
        if (!res.ok) throw new Error(`Download failed: ${res.status}`);
        
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'CUSTOM_SELECTION.zip';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert(`Error: ${err.message}`);
      } finally {
        $('downloadCustomBtn').disabled = false;
        $('downloadCustomBtn').textContent = 'ğŸ“¥ Download ZIP';
      }
    });

    $('mergeCustomBtn').addEventListener('click', async () => {
      const selections = {};
      Object.keys(customSelections).forEach(member => {
        const s = customSelections[member];
        if (s.enabled) {
          selections[member] = {summary: s.summary, toris: s.toris, pg13: s.pg13};
        }
      });
      
      try {
        const res = await fetch('/download_custom', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'merge', selections})
        });
        
        if (!res.ok) throw new Error(`Merge failed: ${res.status}`);
        
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'CUSTOM_MERGED_PACKAGE.pdf';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert(`Error: ${err.message}`);
      } finally {
        $('mergeCustomBtn').disabled = false;
        $('mergeCustomBtn').textContent = 'ğŸ“¦ Merge PDF';
      }
    });

    // Initialize
    $('yearNow').textContent = new Date().getFullYear();
  </script>
</body>
</html>
