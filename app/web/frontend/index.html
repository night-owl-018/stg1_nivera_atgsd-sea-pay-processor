<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ATGSD Sea Pay Processor</title>
  <style>
    :root{--navy:#0b4c6b;--border:#d9d9d9;--bg:#f6f7f9;--panel:#fff;--mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#111;}
    header{background:var(--navy);color:#fff;padding:14px 18px;font-weight:700;}
    .wrap{padding:16px 18px;}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:18px;align-items:start;}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:4px;}
    .card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;letter-spacing:.02em;}
    .card .body{padding:12px;}
    label{display:block;font-size:12px;margin:10px 0 6px;}
    input[type=file], select{width:100%;}
    button{width:100%;padding:9px 10px;border:1px solid #1a4f6b;background:var(--navy);color:#fff;border-radius:2px;font-weight:700;cursor:pointer;}
    button.secondary{background:#fff;color:#111;border:1px solid var(--border);font-weight:600;}
    button.danger{background:#b00000;border-color:#8a0000;}
    .stack > * + *{margin-top:10px;}
    .status{font-size:13px;}
    .logbox{height:260px;overflow:auto;background:#000;color:#35ff57;font-family:var(--mono);font-size:12px;line-height:1.35;padding:10px;white-space:pre;}
    .review-controls{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px;}
    .review-controls select{height:32px;}
    table{width:100%;border-collapse:collapse;font-size:12px;}
    th,td{border:1px solid var(--border);padding:6px 8px;vertical-align:middle;}
    th{background:#eee;text-align:left;}
    tr.valid{background:#eaffea;}
    tr.invalid{background:#ffecec;}
    .override-cell{min-width:240px;}
    .override-wrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .override-wrap select{width:150px;height:28px;}
    .override-wrap input{flex:1;min-width:160px;height:26px;padding:0 6px;}
    .small{font-size:12px;color:#444;}
    footer{padding:10px;text-align:center;color:#777;font-size:11px;}
  </style>
</head>
<body>
<header>ATGSD Sea Pay Processor</header>

<div class="wrap">
  <div class="grid">
    <div class="stack">
      <div class="card">
        <h3>INPUT</h3>
        <div class="body">
          <form id="processForm" class="stack">
            <div>
              <label>SEA DUTY CERTIFICATION SHEETS (PDF)</label>
              <input id="pdfs" name="pdfs" type="file" accept="application/pdf" multiple required>
            </div>

            <div>
              <label>RATE CSV</label>
              <input id="ratesCsv" name="rates_csv" type="file" accept=".csv">
            </div>

            <div>
              <label>NAVPERS 1070/613 TEMPLATE</label>
              <input id="templatePdf" name="template_pdf" type="file" accept="application/pdf">
            </div>

            <div>
              <label>Strikeout Color</label>
              <select id="strikeColor" name="strikeout_color">
                <option value="Black" selected>Black</option>
                <option value="Red">Red</option>
              </select>
            </div>

            <button type="submit" id="processBtn">PROCESS</button>
          </form>
        </div>
      </div>

      <div class="card">
        <h3>STATUS</h3>
        <div class="body">
          <div class="status" id="statusText">Idle</div>
        </div>
      </div>

      <div class="card">
        <h3>DOWNLOADS</h3>
        <div class="body">
          <button class="secondary" type="button" id="btnMerged">Merged Package</button>
          <button class="secondary" type="button" id="btnAll" style="margin-top:8px;">Download All</button>
          <div class="small" style="margin-top:8px;">(If a download is empty, run PROCESS first.)</div>
        </div>
      </div>

      <div class="card">
        <div class="body">
          <button class="danger" type="button" id="btnReset">RESET ALL</button>
        </div>
      </div>
    </div>

    <div class="stack">
      <div class="card">
        <h3>LIVE LOG</h3>
        <div class="body">
          <div id="liveLog" class="logbox"></div>
        </div>
      </div>

      <div class="card">
        <h3>REVIEW &amp; OVERRIDE</h3>
        <div class="body">
          <div class="review-controls">
            <div>
              <label>Member</label>
              <select id="memberSelect">
                <option value="">Select member</option>
              </select>
            </div>
            <div>
              <label>Sheet</label>
              <select id="sheetSelect" disabled>
                <option value="">Select sheet</option>
              </select>
            </div>
          </div>

          <div class="small" id="reviewHint">Pick a member and a sheet to edit auto results.</div>

          <div style="margin-top:10px;">
            <div style="font-weight:700;font-size:12px;margin:6px 0;">Valid Rows</div>
            <table>
              <thead>
                <tr>
                  <th style="width:110px;">Date</th>
                  <th style="width:220px;">Ship</th>
                  <th style="width:110px;">Final</th>
                  <th class="override-cell">Override</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody id="validBody"></tbody>
            </table>
          </div>

          <div style="margin-top:12px;">
            <div style="font-weight:700;font-size:12px;margin:6px 0;">Invalid Events</div>
            <table>
              <thead>
                <tr>
                  <th style="width:110px;">Date</th>
                  <th style="width:220px;">Ship</th>
                  <th style="width:110px;">Final</th>
                  <th class="override-cell">Override</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody id="invalidBody"></tbody>
            </table>
          </div>

        </div>
      </div>

      <footer>ATGSD Sea Pay Processor</footer>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);
  
  let lastStatus = null;

  function safeText(v) {
    if (v === null || v === undefined) return "";
    if (typeof v === "object") return JSON.stringify(v);
    return String(v);
  }

  function pick(obj, keys, fallback="") {
    if (!obj) return fallback;
    for (const k of keys) {
      if (obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
    }
    return fallback;
  }

  async function jget(url) {
    const r = await fetch(url, {cache:"no-store"});
    if (!r.ok) throw new Error("GET " + url + " -> " + r.status);
    return await r.json();
  }

  async function jpost(url, payload) {
    const r = await fetch(url, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if (!r.ok) {
      const t = await r.text().catch(()=> "");
      throw new Error("POST " + url + " -> " + r.status + " " + t);
    }
    return await r.json();
  }

  async function jdel(url, payload) {
    const r = await fetch(url, {
      method:"DELETE",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if (!r.ok) {
      const t = await r.text().catch(()=> "");
      throw new Error("DELETE " + url + " -> " + r.status + " " + t);
    }
    return await r.json();
  }

  // ----- LIVE LOG -----
  async function pollProgress() {
    try {
      const data = await jget("/progress");
      const pct = pick(data, ["percent","progress","pct"], null);
      const status = pick(data, ["status","state","message"], "Idle");
      const log = pick(data, ["log","lines","text"], "");

      // Detect transition to COMPLETE and refresh Review list once
      if (status === "COMPLETE" && lastStatus !== "COMPLETE") {
        refreshReviewLists();
      }
      lastStatus = status;
        
      if (pct !== null && pct !== undefined) {
        $("statusText").textContent = status + " (" + pct + "%)";
      } else {
        $("statusText").textContent = status;
      }

      if (typeof log === "string") {
        $("liveLog").textContent = log;
        $("liveLog").scrollTop = $("liveLog").scrollHeight;
      }
    } catch (e) {}
  }
  setInterval(pollProgress, 1000);
  pollProgress();

  // ----- PROCESS -----
  $("processForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData();
    for (const f of $("pdfs").files) fd.append("pdfs", f);
    if ($("ratesCsv").files[0]) fd.append("rates_csv", $("ratesCsv").files[0]);
    if ($("templatePdf").files[0]) fd.append("template_pdf", $("templatePdf").files[0]);
    fd.append("strikeout_color", $("strikeColor").value);

    $("processBtn").disabled = true;
    try {
      const r = await fetch("/process", {method:"POST", body: fd});
      if (!r.ok) throw new Error("Process failed: " + r.status);
      await refreshReviewLists();
    } catch (err) {
      alert(err.message || String(err));
    } finally {
      $("processBtn").disabled = false;
    }
  });

  // ----- DOWNLOADS -----
  $("btnMerged").addEventListener("click", () => { window.location = "/download_merged"; });
  $("btnAll").addEventListener("click", () => { window.location = "/download_all"; });

  // ----- RESET -----
  $("btnReset").addEventListener("click", async () => {
    if (!confirm("Reset all output and overrides?")) return;
    try {
      const r = await fetch("/reset", {method:"POST"});
      if (!r.ok) throw new Error("Reset failed: " + r.status);
      
      // Clear form inputs
      $("processForm").reset();
      
      // Clear review UI
      $("memberSelect").innerHTML = '<option value="">Select member</option>';
      $("sheetSelect").innerHTML = '<option value="">Select sheet</option>';
      $("sheetSelect").disabled = true;
      $("validBody").innerHTML = "";
      $("invalidBody").innerHTML = "";
      $("reviewHint").textContent = "Pick a member and a sheet to edit auto results.";
      
      alert("Reset complete!");
    } catch (err) {
      alert(err.message || String(err));
    }
  });

  // ----- REVIEW & OVERRIDE (Option A: Navy-proof) -----
  async function refreshReviewLists() {
    try {
      const members = await jget("/api/members");
      const sel = $("memberSelect");
      const current = sel.value;
      sel.innerHTML = '<option value="">Select member</option>';
      for (const m of members) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        sel.appendChild(opt);
      }
      if (current && members.includes(current)) sel.value = current;
    } catch (e) {}
  }

  async function loadSheetsForMember(memberKey) {
    $("sheetSelect").disabled = true;
    $("sheetSelect").innerHTML = '<option value="">Select sheet</option>';
    $("validBody").innerHTML = "";
    $("invalidBody").innerHTML = "";
    if (!memberKey) return;

    const sheets = await jget("/api/member/" + encodeURIComponent(memberKey) + "/sheets");
    const sel = $("sheetSelect");
    for (const s of sheets) {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      sel.appendChild(opt);
    }
    sel.disabled = false;
  }

  function buildOverrideControl(memberKey, sheetFile, eventIndex, currentStatus, currentReason, source) {
    const wrap = document.createElement("div");
    wrap.className = "override-wrap";

    const sel = document.createElement("select");
    const options = [
      {v:"", t:"Auto"},
      {v:"valid", t:"Force Valid"},
      {v:"invalid", t:"Force Invalid"},
    ];
    for (const o of options) {
      const opt = document.createElement("option");
      opt.value = o.v;
      opt.textContent = o.t;
      sel.appendChild(opt);
    }
    sel.value = currentStatus || "";

    const reason = document.createElement("input");
    reason.type = "text";
    reason.placeholder = "Reason (optional)";
    reason.value = currentReason || "";

    const save = async () => {
      const st = sel.value || null;
      try {
        if (st === null && !(reason.value || "").trim()) {
          await jdel("/api/override", {
            member_key: memberKey,
            sheet_file: sheetFile,
            event_index: eventIndex
          });
        } else {
          await jpost("/api/override", {
            member_key: memberKey,
            sheet_file: sheetFile,
            event_index: eventIndex,
            status: st,
            reason: reason.value || "",
            source: source || ""
          });
        }
        await loadSheet(memberKey, sheetFile);
      } catch (e) {
        alert(e.message || String(e));
      }
    };

    sel.addEventListener("change", save);
    reason.addEventListener("change", save);

    wrap.appendChild(sel);
    wrap.appendChild(reason);
    return wrap;
  }

  function renderRows(tbody, rows, memberKey, sheetFile, rowClass) {
    tbody.innerHTML = "";
    if (!Array.isArray(rows) || rows.length === 0) return;

    rows.forEach((row, idx) => {
      const tr = document.createElement("tr");
      tr.className = rowClass || "";

      const date = pick(row, ["date","Date","event_date","schedule_day","day","dt"], "");
      const ship = pick(row, ["ship","Ship","event","Event","ship_name"], "");
      const final = pick(row, ["final","Final","final_status","final_valid","computed_status","status"], "");
      const reason = pick(row, ["reason","Reason","invalid_reason","why"], "");

      const ov = row.override || row.Override || null;
      const ovStatus = pick(ov || row, ["status","override_status","override"], "");
      const ovReason = pick(ov || row, ["reason","override_reason"], "");
      const source = pick(ov || row, ["source","override_source"], "");
      
      // Use negative index for invalid events
      let eventIndex = pick(row, ["event_index","index","i"], null);
      if (eventIndex === null) {
        eventIndex = (rowClass === "invalid") ? -(idx + 1) : idx;
      }

      const tdDate = document.createElement("td"); tdDate.textContent = safeText(date);
      const tdShip = document.createElement("td"); tdShip.textContent = safeText(ship);
      const tdFinal = document.createElement("td"); tdFinal.textContent = safeText(final);

      const tdOverride = document.createElement("td");
      tdOverride.className = "override-cell";
      tdOverride.appendChild(buildOverrideControl(memberKey, sheetFile, eventIndex, ovStatus, ovReason, source));

      const tdReason = document.createElement("td"); tdReason.textContent = safeText(reason);

      tr.appendChild(tdDate);
      tr.appendChild(tdShip);
      tr.appendChild(tdFinal);
      tr.appendChild(tdOverride);
      tr.appendChild(tdReason);
      tbody.appendChild(tr);
    });
  }

  async function loadSheet(memberKey, sheetFile) {
    if (!memberKey || !sheetFile) return;
    const data = await jget("/api/member/" + encodeURIComponent(memberKey) + "/sheet/" + encodeURIComponent(sheetFile));
    const validRows = data.valid_rows || data.valid || data.rows_valid || [];
    const invalidRows = data.invalid_events || data.invalid || data.rows_invalid || [];

    $("reviewHint").textContent = "";
    renderRows($("validBody"), validRows, memberKey, sheetFile, "valid");
    renderRows($("invalidBody"), invalidRows, memberKey, sheetFile, "invalid");
  }

  $("memberSelect").addEventListener("change", async () => {
    await loadSheetsForMember($("memberSelect").value);
  });

  $("sheetSelect").addEventListener("change", async () => {
    await loadSheet($("memberSelect").value, $("sheetSelect").value);
  });

  refreshReviewLists();
</script>
</body>
</html>
