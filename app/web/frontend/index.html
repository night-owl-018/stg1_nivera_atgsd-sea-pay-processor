<!DOCTYPE html>
<html>
<head>
    <title>ATGSD Sea Pay Processor</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #010409;
            --bg-header: #161b22;
            --bg-card: #0d1117;
            --bg-card-soft: #161b22;
            --border-subtle: #30363d;
            --text-primary: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --accent-soft: rgba(88, 166, 255, 0.4);
            --accent-danger: #f85149;
            --accent-warning: #d29922;
            --status-ready: #656d76;
            --status-processing: #d29922;
            --status-complete: #2ea043;
            --status-error: #f85149;
        }
    </style>
</head>
<body>
<script>
    let isPolling = false;
    let autoScroll = true;
    let lastText = "";

    let isProcessing = false;
    let progressTimer = null;

    const logBox = document.getElementById("logBox");
    const statusText = document.getElementById("statusText");
    const submitBtn = document.getElementById("submitBtn");
    const allToolbarButtons = document.querySelectorAll(".toolbar button");

    const filesProcessedEl = document.getElementById("filesProcessed");
    const filesTotalEl = document.getElementById("filesTotal");
    const validDaysEl = document.getElementById("validDays");
    const invalidEventsEl = document.getElementById("invalidEvents");
    const pg13CountEl = document.getElementById("pg13Count");
    const torisMarkedEl = document.getElementById("torisMarked");
    const progressBarInner = document.getElementById("progressBarInner");
    const progressStepEl = document.getElementById("progressStep");
    const progressBanner = document.getElementById("progressBanner");
    const themeToggle = document.getElementById("themeToggle");

    logBox.addEventListener("scroll", () => {
        autoScroll =
            logBox.scrollHeight - logBox.scrollTop - logBox.clientHeight < 30;
    });

    function setStatus(state, label) {
        statusText.classList.remove(
            "status-ready",
            "status-processing",
            "status-complete",
            "status-error",
        );
        if (state === "processing") {
            statusText.classList.add("status-processing");
        } else if (state === "complete") {
            statusText.classList.add("status-complete");
        } else if (state === "error") {
            statusText.classList.add("status-error");
        } else {
            statusText.classList.add("status-ready");
        }

        const pill = statusText.querySelector(".status-pill");
        if (pill) {
            if (pill.children.length >= 2) {
                pill.children[1].textContent = label
                    .replace("STATUS:", "")
                    .trim();
            } else {
                pill.textContent = label.replace("STATUS:", "").trim();
            }
        }
    }

    function setButtonsDisabled(disabled) {
        allToolbarButtons.forEach((btn) => {
            btn.disabled = disabled;
        });
        submitBtn.disabled = disabled;
    }

    function updateProgressUI(p) {
        if (!p) return;
        const details = p.details || {};

        if (filesTotalEl) filesTotalEl.textContent = p.total_files || 0;
        if (filesProcessedEl)
            filesProcessedEl.textContent = details.files_processed || 0;
        if (validDaysEl) validDaysEl.textContent = details.valid_days || 0;
        if (invalidEventsEl)
            invalidEventsEl.textContent = details.invalid_events || 0;
        if (pg13CountEl)
            pg13CountEl.textContent = details.pg13_created || 0;
        if (torisMarkedEl)
            torisMarkedEl.textContent = details.toris_marked || 0;

        if (progressBarInner) {
            const pct = p.percentage || 0;
            progressBarInner.style.width = pct + "%";
        }

        if (progressStepEl) {
            progressStepEl.textContent = p.current_step || "";
        }
    }

    function showBanner(message, type) {
        if (!progressBanner) return;
        progressBanner.textContent = message || "";
        progressBanner.classList.remove(
            "banner-hidden",
            "banner-success",
            "banner-error",
        );
        if (type === "success") {
            progressBanner.classList.add("banner-success");
        } else if (type === "error") {
            progressBanner.classList.add("banner-error");
        } else {
            progressBanner.classList.add("banner-hidden");
        }
    }

    function startProgressPolling() {
        if (progressTimer) {
            return;
        }

        const poll = () => {
            fetch("/progress")
                .then((r) => r.json())
                .then((data) => {
                    updateProgressUI(data);
                    if (data.status === "processing") {
                        isProcessing = true;
                        progressTimer = setTimeout(poll, 300);
                    } else {
                        // PATCH: processing finished â†’ unlock UI and reset button text
                        isProcessing = false;
                        progressTimer = null;
                        setButtonsDisabled(false);
                        submitBtn.innerText = "RUN PROCESSOR";  // <-- PATCH

                        if (data.status === "complete") {
                            setStatus("complete", "STATUS: COMPLETE");
                            showBanner("Processing complete", "success");
                        } else if (data.status === "error") {
                            setStatus("error", "STATUS: ERROR");
                            showBanner("Processing error", "error");
                        } else {
                            setStatus("ready", "STATUS: READY");
                        }
                    }
                })
                .catch(() => {
                    progressTimer = setTimeout(poll, 1000);
                });
        };

        poll();
    }

    function toggleTheme() {
        const body = document.body;
        const isLight = body.classList.toggle("theme-light");
        if (themeToggle) {
            themeToggle.textContent = isLight ? "Light" : "Dark";
        }
        try {
            localStorage.setItem("atgsd_theme", isLight ? "light" : "dark");
        } catch (e) {}
    }

    (function initTheme() {
        try {
            const stored = localStorage.getItem("atgsd_theme");
            if (stored === "light") {
                document.body.classList.add("theme-light");
                if (themeToggle) themeToggle.textContent = "Light";
            }
        } catch (e) {}
    })();

    pollLogs();

    function pollLogs() {
        if (isPolling) return;
        isPolling = true;

        fetch("/logs")
            .then((r) => r.text())
            .then((txt) => {
                if (txt === lastText) {
                    isPolling = false;
                    setTimeout(pollLogs, 1000);
                    return;
                }

                const prevHeight = logBox.scrollHeight;
                const prevTop = logBox.scrollTop;

                logBox.textContent = txt;
                lastText = txt;

                if (autoScroll && isProcessing) {
                    logBox.scrollTop = logBox.scrollHeight;
                } else {
                    logBox.scrollTop =
                        prevTop + (logBox.scrollHeight - prevHeight);
                }

                isPolling = false;
                setTimeout(pollLogs, 1000);
            })
            .catch(() => {
                isPolling = false;
                setTimeout(pollLogs, 2000);
            });
    }

    document
        .getElementById("uploadForm")
        .addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const btn = submitBtn;

            isProcessing = true;
            btn.innerText = "PROCESSING...";
            setButtonsDisabled(true);
            setStatus("processing", "STATUS: PROCESSING...");
            showBanner("", null);
            startProgressPolling();

            fetch("/process", { method: "POST", body: formData })
                .then((res) => {
                    if (!res.ok) {
                        throw new Error("Process start failed");
                    }
                })
                .catch(() => {
                    isProcessing = false;
                    setButtonsDisabled(false);
                    btn.innerText = "RUN PROCESSOR";
                    setStatus("error", "STATUS: ERROR");
                    showBanner("Failed to start processor", "error");
                });
        });

    function downloadMerged() {
        location.href = "/download_merged";
    }

    function downloadSummary() {
        location.href = "/download_summary";
    }

    function downloadAll() {
        location.href = "/download_all";
    }

    function resetAll() {
        if (!confirm("Delete ALL input/output files and logs?")) return;

        fetch("/reset", { method: "POST" })
            .then((r) => r.json())
            .then((data) => {
                alert(data.message || "Reset complete");

                setStatus("ready", "STATUS: READY");
                document.getElementById("strike_color").value = "black";

                logBox.textContent = "";
                lastText = "";

                if (filesTotalEl) filesTotalEl.textContent = "0";
                if (filesProcessedEl) filesProcessedEl.textContent = "0";
                if (validDaysEl) validDaysEl.textContent = "0";
                if (invalidEventsEl) invalidEventsEl.textContent = "0";
                if (pg13CountEl) pg13CountEl.textContent = "0";
                if (torisMarkedEl) torisMarkedEl.textContent = "0";
                if (progressBarInner) progressBarInner.style.width = "0%";
                if (progressStepEl) progressStepEl.textContent = "Idle";
                showBanner("", null);
            });
    }
</script>

</body>
</html>
