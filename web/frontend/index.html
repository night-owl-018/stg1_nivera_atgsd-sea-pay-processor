<!DOCTYPE html>
<html>
<head>
<title>ATGSD Sea Pay Processor</title>
<style>
body { background:#000; color:#0f0; font-family:monospace }
label { display:block; margin-top:12px }
button,input { background:#111;color:#0f0;border:1px solid #0f0;padding:6px }
button:disabled { opacity:0.5; cursor:not-allowed }
pre { background:#000; padding:10px; height:280px; overflow:auto; border:1px solid #0f0 }
.small { font-size:12px; color:#6f6 }
</style>
</head>
<body>
<h2>ATGSD Sea Pay Processor</h2>
<form id="uploadForm">
<label>INPUT PDFs</label>
<input type="file" name="files" multiple>
<label>REPLACE TEMPLATE PDF</label>
<input type="file" name="template_file">
<div class="small">Current: {{ template_path }}</div>
<label>RATE CSV</label>
<input type="file" name="rate_file">
<div class="small">Current: {{ rate_path }}</div>
<br><br>
<button type="submit" id="submitBtn">RUN PROCESSOR</button>
</form>
<hr>
<button onclick="downloadAll()">â¬‡ DOWNLOAD ALL GENERATED FILES</button>
<hr>
<h3>LIVE LOG CONSOLE</h3>
<pre id="logBox">{{ logs }}</pre>
<script>
let isPolling = false;

// Start polling immediately when page loads
pollLogs();

function pollLogs() {
    if (isPolling) return;
    isPolling = true;
    
    fetch("/logs")
        .then(r => r.text())
        .then(txt => {
            const logBox = document.getElementById("logBox");
            logBox.innerText = txt;
            logBox.scrollTop = logBox.scrollHeight;
            
            isPolling = false;
            setTimeout(pollLogs, 1000);
        })
        .catch(err => {
            console.error("Log poll failed:", err);
            isPolling = false;
            setTimeout(pollLogs, 2000);
        });
}

// Handle form submission without page reload
document.getElementById("uploadForm").addEventListener("submit", function(e) {
    e.preventDefault();  // STOP the page reload!
    
    const formData = new FormData(this);
    const submitBtn = document.getElementById("submitBtn");
    
    submitBtn.disabled = true;
    submitBtn.innerText = "PROCESSING...";
    
    fetch("/", {
        method: "POST",
        body: formData
    })
    .then(response => {
        submitBtn.disabled = false;
        submitBtn.innerText = "RUN PROCESSOR";
        // Logs continue streaming via pollLogs() - no interruption!
    })
    .catch(err => {
        console.error("Upload failed:", err);
        submitBtn.disabled = false;
        submitBtn.innerText = "RUN PROCESSOR";
    });
});

function downloadAll() {
    window.location.href = "/download_all";
}
</script>
</body>
</html>
