<!DOCTYPE html>
<html>
<head>
<title>ATGSD Sea Pay Processor</title>
<style>
body { background:#000; color:#0f0; font-family:monospace }
label { display:block; margin-top:12px }
button,input { background:#111;color:#0f0;border:1px solid #0f0;padding:6px }
pre { background:#000; padding:10px; overflow:auto; border:1px solid #0f0 }
#logBox { height: calc(100vh - 180px); }
.main-container { display:flex; align-items:flex-start; gap:16px; }
.left-panel { flex:1; min-width:0; }
.right-panel { flex:1; min-width:0; }
.small { font-size:12px; color:#6f6 }
.buttons { margin-top:10px }
.reset-btn { background:#330000; border-color:#ff4444; color:#ff6666; }
</style>
</head>

<body>
<div class="main-container">

  <div class="left-panel">
    <h2>ATGSD Sea Pay Processor</h2>

    <form id="uploadForm">
      <label>INPUT SEA DUTY CERTIFICATION SHEET FROM TORIS</label>
      <input type="file" name="files" multiple>

      <label>NAVPERS_1070_613_TEMPLATE</label>
      <input type="file" name="template_file">
      <div class="small">Current: {{ template_path }}</div>

      <label>N811 PERSONNEL ROSTER</label>
      <input type="file" name="rate_file">
      <div class="small">Current: {{ rate_path }}</div>

      <br><br>
      <button type="submit" id="submitBtn">RUN PROCESSOR</button>
    </form>

    <hr>

    <div class="download-section">
      <button onclick="downloadMerged()">üìÑ DOWNLOAD MERGED PDF</button>
      <button onclick="downloadSummary()">üìù DOWNLOAD SUMMARY TXT</button>
      <button onclick="downloadAll()">üì¶ DOWNLOAD ZIP (ALL FILES)</button>
      <button onclick="resetAll()" class="reset-btn">üóëÔ∏è RESET ALL FILES & LOGS</button>
    </div>
  </div>

  <div class="right-panel">
    <h3>LIVE LOG CONSOLE</h3>
    <pre id="logBox">{{ logs }}</pre>
  </div>

</div>

<script>
let isPolling = false;
let autoScroll = true;
const logBox = document.getElementById("logBox");

// Detect when user scrolls manually
logBox.addEventListener("scroll", function () {
    const atBottom = logBox.scrollHeight - logBox.scrollTop - logBox.clientHeight < 20;
    autoScroll = atBottom;
});

// Start polling immediately when page loads
pollLogs();

function pollLogs() {
    if (isPolling) return;
    isPolling = true;
    
    fetch("/logs")
        .then(r => r.text())
        .then(txt => {
            logBox.innerText = txt;

            // Only auto-scroll if user is already near bottom
            if (autoScroll) {
                logBox.scrollTop = logBox.scrollHeight;
            }
            
            isPolling = false;
            setTimeout(pollLogs, 1000);
        })
        .catch(err => {
            console.error("Log poll failed:", err);
            isPolling = false;
            setTimeout(pollLogs, 2000);
        });
}

// Handle form submission without page reload
document.getElementById("uploadForm").addEventListener("submit", function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = document.getElementById("submitBtn");
    
    submitBtn.disabled = true;
    submitBtn.innerText = "PROCESSING...";
    
    fetch("/", {
        method: "POST",
        body: formData
    })
    .then(response => {
        submitBtn.disabled = false;
        submitBtn.innerText = "RUN PROCESSOR";
    })
    .catch(err => {
        console.error("Upload failed:", err);
        submitBtn.disabled = false;
        submitBtn.innerText = "RUN PROCESSOR";
    });
});

function downloadMerged() {
    window.location.href = "/download_merged";
}

function downloadSummary() {
    window.location.href = "/download_summary";
}

function downloadAll() {
    window.location.href = "/download_all";
}

function resetAll() {
    if (!confirm("Are you sure you want to delete ALL input, output files, and logs?")) {
        return;
    }

    fetch("/reset", { method: "POST" })
        .then(resp => resp.json())
        .then(data => {
            alert(data.message || "Reset complete!");
        })
        .catch(err => {
            console.error("Reset failed:", err);
            alert("Reset failed - see logs for details.");
        });
}
</script>

</body>
</html>
